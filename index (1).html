<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة طلبات وجها</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulse-success {
            animation: pulseSuccess 0.6s ease-in-out;
        }
        @keyframes pulseSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .status-pending { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .status-completed { background: linear-gradient(135deg, #10b981, #059669); }
        .status-approved { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-rejected { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-waiting { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .status-connected {
            background: #10b981;
            color: white;
        }
        .status-connecting {
            background: #f59e0b;
            color: white;
        }
        .status-error {
            background: #ef4444;
            color: white;
        }
        .status-local {
            background: #6b7280;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- حالة الاتصال -->
    <div id="connectionStatus" class="connection-status status-connecting">
        🔄 جاري فحص الاتصال...
    </div>

    <!-- الهيدر -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">نظام إدارة طلبات وجها</h1>
                        <p class="text-blue-100">إدارة شاملة للعملاء والمعاينات</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="syncWithGoogleSheets()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>تحديث من Sheets</span>
                    </button>
                    <button onclick="exportAllDataToCSV()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>تصدير CSV</span>
                    </button>
                    <div class="text-right">
                        <div class="text-sm opacity-90">إجمالي العملاء</div>
                        <div id="totalCustomers" class="text-xl font-bold">0</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- التنقل -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8 space-x-reverse">
                <button onclick="showSection('dashboard')" class="nav-btn px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-semibold">
                    لوحة التحكم
                </button>
                <button onclick="showSection('customers')" class="nav-btn px-6 py-4 text-gray-600 hover:text-blue-600 transition-colors">
                    العملاء
                </button>
                <button onclick="showSection('inspections')" class="nav-btn px-6 py-4 text-gray-600 hover:text-blue-600 transition-colors">
                    المعاينات
                </button>
                <button onclick="showSection('reports')" class="nav-btn px-6 py-4 text-gray-600 hover:text-blue-600 transition-colors">
                    التقارير
                </button>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <main class="container mx-auto px-6 py-8">
        <!-- لوحة التحكم -->
        <section id="dashboard" class="section-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- بطاقة إجمالي العملاء -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">إجمالي العملاء</p>
                            <p id="dashTotalCustomers" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- بطاقة المعاينات المعلقة -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">معاينات معلقة</p>
                            <p id="dashPendingInspections" class="text-3xl font-bold text-yellow-600">0</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- بطاقة المعاينات المكتملة -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">معاينات مكتملة</p>
                            <p id="dashCompletedInspections" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- بطاقة إجمالي الإيرادات -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">إجمالي الإيرادات</p>
                            <p id="dashTotalRevenue" class="text-3xl font-bold text-purple-600">0 د.ك</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الرسوم البيانية -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">توزيع حالات المعاينات</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">المعاينات الشهرية</h3>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- قسم العملاء -->
        <section id="customers" class="section-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة العملاء</h2>
                    <button onclick="showAddCustomerModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <span>إضافة عميل جديد</span>
                    </button>
                </div>

                <!-- شريط البحث -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="customerSearch" placeholder="البحث عن عميل..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                </div>

                <!-- جدول العملاء -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم العميل</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم الهاتف</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ التسجيل</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">عدد المعاينات</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- قسم المعاينات -->
        <section id="inspections" class="section-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة المعاينات</h2>
                    <button onclick="showAddInspectionModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <span>إضافة معاينة جديدة</span>
                    </button>
                </div>

                <!-- فلاتر البحث -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="inspectionSearch" placeholder="البحث..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">جميع الحالات</option>
                        <option value="معلق">معلق</option>
                        <option value="مكتمل">مكتمل</option>
                    </select>
                    <select id="approvalFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">جميع الموافقات</option>
                        <option value="موافق">موافق</option>
                        <option value="غير موافق">غير موافق</option>
                        <option value="في الانتظار">في الانتظار</option>
                    </select>
                    <input type="date" id="dateFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>

                <!-- جدول المعاينات -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم المعاينة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العميل</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنطقة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع الخدمة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الموافقة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ النهائي</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="inspectionsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- قسم التقارير -->
        <section id="reports" class="section-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">التقارير والإحصائيات</h2>
                
                <!-- أزرار التصدير -->
                <div class="flex flex-wrap gap-4 mb-8">
                    <button onclick="exportCustomersReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        تقرير العملاء (PDF)
                    </button>
                    <button onclick="exportInspectionsReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        تقرير المعاينات (PDF)
                    </button>
                    <button onclick="exportFinancialReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        التقرير المالي (PDF)
                    </button>
                    <button onclick="exportAllDataToCSV()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        تصدير CSV للـ Sheets
                    </button>
                    <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        نسخة احتياطية (JSON)
                    </button>
                </div>

                <!-- إحصائيات مفصلة -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-2">معدل الموافقة</h3>
                        <p id="approvalRate" class="text-3xl font-bold">0%</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-2">متوسط قيمة المعاينة</h3>
                        <p id="avgInspectionValue" class="text-3xl font-bold">0 د.ك</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-2">متوسط التقييم</h3>
                        <p id="avgRating" class="text-3xl font-bold">0/5</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- مودال إضافة عميل -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 bounce-in">
            <h3 class="text-xl font-bold mb-6">إضافة عميل جديد</h3>
            <form id="addCustomerForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">الاسم</label>
                    <input type="text" id="customerName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">رقم الهاتف</label>
                    <input type="tel" id="customerPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" onclick="hideAddCustomerModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-all duration-300">
                        <span class="flex items-center space-x-2 space-x-reverse">
                            <span>إضافة</span>
                            <div id="addCustomerSpinner" class="loading-spinner hidden"></div>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- مودال إضافة معاينة -->
    <div id="addInspectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto bounce-in">
            <h3 class="text-xl font-bold mb-6">إضافة معاينة جديدة</h3>
            <form id="addInspectionForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">العميل</label>
                        <select id="inspectionCustomer" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">اختر العميل</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">المنطقة</label>
                        <select id="inspectionArea" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">اختر المنطقة</option>
                            <option value="الكويت">الكويت</option>
                            <option value="حولي">حولي</option>
                            <option value="الفروانية">الفروانية</option>
                            <option value="مبارك الكبير">مبارك الكبير</option>
                            <option value="الأحمدي">الأحمدي</option>
                            <option value="الجهراء">الجهراء</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">نوع الخدمة</label>
                        <select id="inspectionServiceType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">اختر نوع الخدمة</option>
                            <option value="فحص منزل">فحص منزل</option>
                            <option value="فحص شقة">فحص شقة</option>
                            <option value="فحص فيلا">فحص فيلا</option>
                            <option value="فحص مكتب">فحص مكتب</option>
                            <option value="فحص محل تجاري">فحص محل تجاري</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">نوع العقار</label>
                        <select id="inspectionPropertyType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">اختر نوع العقار</option>
                            <option value="شقة">شقة</option>
                            <option value="فيلا">فيلا</option>
                            <option value="بيت">بيت</option>
                            <option value="مكتب">مكتب</option>
                            <option value="محل">محل</option>
                            <option value="مستودع">مستودع</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">تاريخ المعاينة</label>
                        <input type="date" id="inspectionDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">وقت المعاينة</label>
                        <input type="time" id="inspectionTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ الإجمالي</label>
                        <input type="number" id="inspectionTotalAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ النهائي</label>
                        <input type="number" id="inspectionFinalAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ملاحظات إضافية</label>
                    <textarea id="inspectionNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" onclick="hideAddInspectionModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-all duration-300">
                        <span class="flex items-center space-x-2 space-x-reverse">
                            <span>إضافة</span>
                            <div id="addInspectionSpinner" class="loading-spinner hidden"></div>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- مودال تفاصيل المعاينة -->
    <div id="inspectionDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">تفاصيل المعاينة</h3>
                <button onclick="hideInspectionDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="inspectionDetailsContent">
                <!-- سيتم ملء المحتوى ديناميكياً -->
            </div>
        </div>
    </div>

    <script>
        // إعدادات Google Sheets - قراءة مباشرة عبر CSV
        const SPREADSHEET_ID = '14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI';
        
        // متغيرات البيانات
        let customers = [];
        let inspections = [];
        let isConnected = false;
        let autoSaveEnabled = true;
        let environmentType = 'unknown';

        // فحص البيئة
        function detectEnvironment() {
            const isInIframe = window !== window.top;
            const isLocalFile = window.location.protocol === 'file:';
            const isHTTPS = window.location.protocol === 'https:';
            const isCanvaEnvironment = window.location.hostname.includes('canva');
            
            if (isCanvaEnvironment) {
                environmentType = 'canva';
            } else if (isInIframe) {
                environmentType = 'iframe';
            } else if (isLocalFile) {
                environmentType = 'local';
            } else if (isHTTPS) {
                environmentType = 'web';
            } else {
                environmentType = 'http';
            }
            
            console.log('البيئة المكتشفة:', environmentType);
            return environmentType;
        }

        // قراءة البيانات من Google Sheets باستخدام CSV Export المباشر
        async function readFromGoogleSheets(sheetName) {
            try {
                // التحقق من إمكانية الاتصال
                if (environmentType === 'local' || environmentType === 'iframe') {
                    throw new Error('البيئة لا تدعم الاتصال الخارجي');
                }

                // استخدام رابط CSV المباشر من Google Sheets (يعمل للقراءة فقط)
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
                
                const response = await fetch(csvUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: فشل في الاتصال`);
                }
                
                const csvText = await response.text();
                
                // التحقق من وجود بيانات صحيحة
                if (!csvText || csvText.trim() === '' || csvText.includes('<!DOCTYPE html>') || csvText.includes('<html>')) {
                    console.log(`الشيت ${sheetName} فارغ أو غير متاح`);
                    return [];
                }
                
                return parseCSV(csvText);
                
            } catch (error) {
                console.error(`خطأ في قراءة ${sheetName}:`, error);
                throw error;
            }
        }

        // تحليل CSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    // تحليل بسيط للـ CSV مع التعامل مع الفواصل داخل النصوص
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim().replace(/^"|"$/g, ''));
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    
                    row.push(current.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }
            
            return result;
        }

        // تصدير البيانات كـ CSV للنسخ اليدوي إلى Google Sheets
        function exportToCSV(data, filename) {
            let csvContent = '';
            
            if (filename.includes('customers')) {
                // هيدر العملاء
                csvContent = 'customer_id,name,phone,created_at\n';
                data.forEach(customer => {
                    csvContent += `"${customer.id}","${customer.name}","${customer.phone}","${customer.createdAt}"\n`;
                });
            } else if (filename.includes('inspections')) {
                // هيدر المعاينات
                csvContent = 'inspection_id,customer_id,customer_name,area,service_type,property_type,inspection_date,inspection_time,status,approval,total_amount,final_amount,rating,additional_notes,inspector_notes,created_at\n';
                data.forEach(inspection => {
                    csvContent += `"${inspection.id}","${inspection.customerId}","${inspection.customerName}","${inspection.area}","${inspection.serviceType}","${inspection.propertyType}","${inspection.date}","${inspection.time}","${inspection.status}","${inspection.approval}","${inspection.totalAmount}","${inspection.finalAmount}","${inspection.rating}","${inspection.additionalNotes}","${inspection.inspectorNotes}","${inspection.createdAt}"\n`;
                });
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // تحميل البيانات من Google Sheets (قراءة فقط)
        async function loadDataFromGoogleSheets() {
            try {
                updateConnectionStatus('connecting');
                
                // التحقق من البيئة
                if (environmentType === 'local' || environmentType === 'iframe') {
                    console.log('البيئة محدودة - سيعمل النظام محلياً فقط');
                    throw new Error('بيئة محدودة');
                }
                
                // محاولة تحميل العملاء
                try {
                    const customersData = await readFromGoogleSheets('Customers');
                    if (customersData && customersData.length > 1) { // تجاهل الهيدر
                        const loadedCustomers = customersData.slice(1).map(row => ({
                            id: row[0] || '',
                            name: row[1] || '',
                            phone: row[2] || '',
                            createdAt: row[3] || new Date().toISOString()
                        })).filter(customer => customer.id && customer.name); // تصفية الصفوف الفارغة
                        
                        if (loadedCustomers.length > 0) {
                            customers = loadedCustomers;
                            console.log(`تم تحميل ${customers.length} عميل من Google Sheets`);
                        }
                    }
                } catch (error) {
                    console.log('لم يتم العثور على شيت العملاء أو هو فارغ');
                }

                // محاولة تحميل المعاينات
                try {
                    const inspectionsData = await readFromGoogleSheets('Inspections');
                    if (inspectionsData && inspectionsData.length > 1) { // تجاهل الهيدر
                        const loadedInspections = inspectionsData.slice(1).map(row => ({
                            id: row[0] || '',
                            customerId: row[1] || '',
                            customerName: row[2] || '',
                            area: row[3] || '',
                            serviceType: row[4] || '',
                            propertyType: row[5] || '',
                            date: row[6] || '',
                            time: row[7] || '',
                            status: row[8] || 'معلق',
                            approval: row[9] || 'في الانتظار',
                            totalAmount: parseFloat(row[10]) || 0,
                            finalAmount: parseFloat(row[11]) || 0,
                            rating: parseInt(row[12]) || 0,
                            additionalNotes: row[13] || '',
                            inspectorNotes: row[14] || '',
                            createdAt: row[15] || new Date().toISOString()
                        })).filter(inspection => inspection.id && inspection.customerName); // تصفية الصفوف الفارغة
                        
                        if (loadedInspections.length > 0) {
                            inspections = loadedInspections;
                            console.log(`تم تحميل ${inspections.length} معاينة من Google Sheets`);
                        }
                    }
                } catch (error) {
                    console.log('لم يتم العثور على شيت المعاينات أو هو فارغ');
                }

                isConnected = true;
                updateConnectionStatus('connected');
                updateUI();
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                updateConnectionStatus('error');
                // تحميل البيانات المحلية كبديل
                loadLocalData();
                updateUI();
            }
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            
            switch (status) {
                case 'connecting':
                    if (environmentType === 'local' || environmentType === 'iframe') {
                        statusElement.textContent = '💾 يعمل محلياً (بيئة محدودة)';
                        statusElement.className = 'connection-status status-local';
                    } else {
                        statusElement.textContent = '🔄 جاري الاتصال بـ Google Sheets...';
                        statusElement.className = 'connection-status status-connecting';
                    }
                    break;
                case 'connected':
                    statusElement.textContent = '📖 متصل للقراءة من Google Sheets';
                    statusElement.className = 'connection-status status-connected';
                    break;
                case 'error':
                    if (environmentType === 'local' || environmentType === 'iframe') {
                        statusElement.textContent = '💾 يعمل محلياً (بيئة محدودة)';
                        statusElement.className = 'connection-status status-local';
                    } else {
                        statusElement.textContent = '💾 يعمل محلياً فقط';
                        statusElement.className = 'connection-status status-error';
                    }
                    break;
            }
        }

        // مزامنة البيانات (قراءة فقط من Google Sheets)
        async function syncWithGoogleSheets() {
            if (environmentType === 'local' || environmentType === 'iframe') {
                showNotification('الاتصال بـ Google Sheets غير متاح في هذه البيئة', 'error');
                return;
            }
            
            showNotification('جاري تحديث البيانات من Google Sheets...', 'info');
            await loadDataFromGoogleSheets();
            
            if (isConnected) {
                showNotification('تم تحديث البيانات بنجاح', 'success');
            } else {
                showNotification('فشل في الاتصال - يعمل النظام محلياً', 'error');
            }
        }

        // تحديث البيانات وحفظها محلياً
        function updateData() {
            // حفظ محلياً دائماً
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('inspections', JSON.stringify(inspections));
            
            // تحديث الواجهة
            updateUI();
            
            // إظهار تنبيه للتصدير اليدوي
            if (autoSaveEnabled && (customers.length > 0 || inspections.length > 0)) {
                showAutoExportReminder();
            }
        }

        // تذكير بالتصدير التلقائي
        function showAutoExportReminder() {
            // إظهار التذكير كل 10 إضافات
            const totalRecords = customers.length + inspections.length;
            if (totalRecords % 10 === 0 && totalRecords > 0) {
                setTimeout(() => {
                    if (confirm('هل تريد تصدير البيانات الحديثة إلى ملفات CSV لنسخها إلى Google Sheets؟')) {
                        exportAllDataToCSV();
                    }
                }, 1000);
            }
        }

        // تحميل البيانات المحلية
        function loadLocalData() {
            const savedCustomers = localStorage.getItem('customers');
            const savedInspections = localStorage.getItem('inspections');
            
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            }
            
            if (savedInspections) {
                inspections = JSON.parse(savedInspections);
            }
        }

        // تهيئة التطبيق
        async function initApp() {
            // فحص البيئة أولاً
            detectEnvironment();
            
            // محاولة الاتصال بـ Google Sheets
            await loadDataFromGoogleSheets();
            
            // إذا فشل الاتصال، تحميل البيانات المحلية
            if (!isConnected) {
                loadLocalData();
                updateUI();
            }
        }

        // إظهار القسم المحدد
        function showSection(sectionName) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            
            // إظهار القسم المحدد
            document.getElementById(sectionName).classList.remove('hidden');
            
            // تحديث أزرار التنقل
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'font-semibold');
                btn.classList.add('text-gray-600');
            });
            
            event.target.classList.remove('text-gray-600');
            event.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'font-semibold');
            
            // تحديث المحتوى حسب القسم
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'customers') {
                updateCustomersTable();
            } else if (sectionName === 'inspections') {
                updateInspectionsTable();
            } else if (sectionName === 'reports') {
                updateReports();
            }
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            const totalCustomers = customers.length;
            const pendingInspections = inspections.filter(i => i.status === 'معلق').length;
            const completedInspections = inspections.filter(i => i.status === 'مكتمل').length;
            const totalRevenue = inspections.reduce((sum, i) => sum + (parseFloat(i.finalAmount) || 0), 0);

            document.getElementById('dashTotalCustomers').textContent = totalCustomers;
            document.getElementById('dashPendingInspections').textContent = pendingInspections;
            document.getElementById('dashCompletedInspections').textContent = completedInspections;
            document.getElementById('dashTotalRevenue').textContent = totalRevenue.toFixed(2) + ' د.ك';

            updateCharts();
        }

        // تحديث الرسوم البيانية
        function updateCharts() {
            // رسم بياني لحالات المعاينات
            const statusCounts = {
                'معلق': inspections.filter(i => i.status === 'معلق').length,
                'مكتمل': inspections.filter(i => i.status === 'مكتمل').length
            };

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#f59e0b', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // رسم بياني للمعاينات الشهرية
            const monthlyData = {};
            inspections.forEach(inspection => {
                const month = new Date(inspection.date).toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });

            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'عدد المعاينات',
                        data: Object.values(monthlyData),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // إظهار مودال إضافة عميل
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('hidden');
            document.getElementById('addCustomerModal').classList.add('flex');
        }

        // إخفاء مودال إضافة عميل
        function hideAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('hidden');
            document.getElementById('addCustomerModal').classList.remove('flex');
            document.getElementById('addCustomerForm').reset();
        }

        // إضافة عميل جديد
        async function addCustomer(event) {
            event.preventDefault();
            
            const spinner = document.getElementById('addCustomerSpinner');
            spinner.classList.remove('hidden');
            
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            
            const newCustomer = {
                id: 'CUST-' + Date.now(),
                name: name,
                phone: phone,
                createdAt: new Date().toISOString()
            };
            
            customers.push(newCustomer);
            await updateData();
            
            hideAddCustomerModal();
            showNotification('تم إضافة العميل بنجاح', 'success');
            
            spinner.classList.add('hidden');
        }

        // إظهار مودال إضافة معاينة
        function showAddInspectionModal() {
            // تحديث قائمة العملاء
            const customerSelect = document.getElementById('inspectionCustomer');
            customerSelect.innerHTML = '<option value="">اختر العميل</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.phone}`;
                customerSelect.appendChild(option);
            });
            
            document.getElementById('addInspectionModal').classList.remove('hidden');
            document.getElementById('addInspectionModal').classList.add('flex');
        }

        // إخفاء مودال إضافة معاينة
        function hideAddInspectionModal() {
            document.getElementById('addInspectionModal').classList.add('hidden');
            document.getElementById('addInspectionModal').classList.remove('flex');
            document.getElementById('addInspectionForm').reset();
        }

        // إضافة معاينة جديدة
        async function addInspection(event) {
            event.preventDefault();
            
            const spinner = document.getElementById('addInspectionSpinner');
            spinner.classList.remove('hidden');
            
            const customerId = document.getElementById('inspectionCustomer').value;
            const customer = customers.find(c => c.id === customerId);
            
            const newInspection = {
                id: 'INS-' + Date.now(),
                customerId: customerId,
                customerName: customer.name,
                area: document.getElementById('inspectionArea').value,
                serviceType: document.getElementById('inspectionServiceType').value,
                propertyType: document.getElementById('inspectionPropertyType').value,
                date: document.getElementById('inspectionDate').value,
                time: document.getElementById('inspectionTime').value,
                status: 'معلق',
                approval: 'في الانتظار',
                totalAmount: parseFloat(document.getElementById('inspectionTotalAmount').value) || 0,
                finalAmount: parseFloat(document.getElementById('inspectionFinalAmount').value) || 0,
                rating: 0,
                additionalNotes: document.getElementById('inspectionNotes').value,
                inspectorNotes: '',
                createdAt: new Date().toISOString()
            };
            
            inspections.push(newInspection);
            await updateData();
            
            hideAddInspectionModal();
            showNotification('تم إضافة المعاينة بنجاح', 'success');
            
            spinner.classList.add('hidden');
        }

        // تحديث جدول العملاء
        function updateCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const customerInspections = inspections.filter(i => i.customerId === customer.id);
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(customer.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customerInspections.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCustomer('${customer.id}')" class="text-blue-600 hover:text-blue-900 ml-4">تعديل</button>
                        <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900">حذف</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // تحديث جدول المعاينات
        function updateInspectionsTable() {
            const tbody = document.getElementById('inspectionsTableBody');
            tbody.innerHTML = '';
            
            inspections.forEach(inspection => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const statusClass = inspection.status === 'معلق' ? 'status-pending' : 'status-completed';
                const approvalClass = inspection.approval === 'موافق' ? 'status-approved' : 
                                    inspection.approval === 'غير موافق' ? 'status-rejected' : 'status-waiting';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${inspection.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inspection.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inspection.area}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inspection.serviceType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(inspection.date).toLocaleDateString('ar-SA')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full text-white ${statusClass}">${inspection.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full text-white ${approvalClass}">${inspection.approval}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inspection.finalAmount} د.ك</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showInspectionDetails('${inspection.id}')" class="text-blue-600 hover:text-blue-900 ml-2">عرض</button>
                        <button onclick="editInspection('${inspection.id}')" class="text-green-600 hover:text-green-900 ml-2">تعديل</button>
                        <button onclick="deleteInspection('${inspection.id}')" class="text-red-600 hover:text-red-900">حذف</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // عرض تفاصيل المعاينة
        function showInspectionDetails(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (!inspection) return;
            
            const content = document.getElementById('inspectionDetailsContent');
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">معلومات أساسية</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">رقم المعاينة:</span> ${inspection.id}</p>
                            <p><span class="font-medium">العميل:</span> ${inspection.customerName}</p>
                            <p><span class="font-medium">المنطقة:</span> ${inspection.area}</p>
                            <p><span class="font-medium">نوع الخدمة:</span> ${inspection.serviceType}</p>
                            <p><span class="font-medium">نوع العقار:</span> ${inspection.propertyType}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">تفاصيل الموعد</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">التاريخ:</span> ${new Date(inspection.date).toLocaleDateString('ar-SA')}</p>
                            <p><span class="font-medium">الوقت:</span> ${inspection.time}</p>
                            <p><span class="font-medium">الحالة:</span> ${inspection.status}</p>
                            <p><span class="font-medium">الموافقة:</span> ${inspection.approval}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">المعلومات المالية</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">المبلغ الإجمالي:</span> ${inspection.totalAmount} د.ك</p>
                            <p><span class="font-medium">المبلغ النهائي:</span> ${inspection.finalAmount} د.ك</p>
                            <p><span class="font-medium">التقييم:</span> ${inspection.rating}/5</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">الملاحظات</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">ملاحظات إضافية:</span></p>
                            <p class="text-gray-600">${inspection.additionalNotes || 'لا توجد ملاحظات'}</p>
                            <p><span class="font-medium">ملاحظات المفتش:</span></p>
                            <p class="text-gray-600">${inspection.inspectorNotes || 'لا توجد ملاحظات'}</p>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4 space-x-reverse">
                    <button onclick="updateInspectionStatus('${inspection.id}', 'مكتمل')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        تحديد كمكتمل
                    </button>
                    <button onclick="updateInspectionApproval('${inspection.id}', 'موافق')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        موافقة
                    </button>
                    <button onclick="updateInspectionApproval('${inspection.id}', 'غير موافق')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        رفض
                    </button>
                </div>
            `;
            
            document.getElementById('inspectionDetailsModal').classList.remove('hidden');
            document.getElementById('inspectionDetailsModal').classList.add('flex');
        }

        // إخفاء مودال تفاصيل المعاينة
        function hideInspectionDetailsModal() {
            document.getElementById('inspectionDetailsModal').classList.add('hidden');
            document.getElementById('inspectionDetailsModal').classList.remove('flex');
        }

        // تحديث حالة المعاينة
        async function updateInspectionStatus(inspectionId, status) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (inspection) {
                inspection.status = status;
                await updateData();
                hideInspectionDetailsModal();
                showNotification('تم تحديث حالة المعاينة', 'success');
            }
        }

        // تحديث موافقة المعاينة
        async function updateInspectionApproval(inspectionId, approval) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (inspection) {
                inspection.approval = approval;
                await updateData();
                hideInspectionDetailsModal();
                showNotification('تم تحديث موافقة المعاينة', 'success');
            }
        }

        // حذف عميل
        async function deleteCustomer(customerId) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                customers = customers.filter(c => c.id !== customerId);
                // حذف معاينات العميل أيضاً
                inspections = inspections.filter(i => i.customerId !== customerId);
                await updateData();
                showNotification('تم حذف العميل بنجاح', 'success');
            }
        }

        // حذف معاينة
        async function deleteInspection(inspectionId) {
            if (confirm('هل أنت متأكد من حذف هذه المعاينة؟')) {
                inspections = inspections.filter(i => i.id !== inspectionId);
                await updateData();
                showNotification('تم حذف المعاينة بنجاح', 'success');
            }
        }

        // تحديث التقارير
        function updateReports() {
            const totalInspections = inspections.length;
            const approvedInspections = inspections.filter(i => i.approval === 'موافق').length;
            const approvalRate = totalInspections > 0 ? ((approvedInspections / totalInspections) * 100).toFixed(1) : 0;
            
            const totalRevenue = inspections.reduce((sum, i) => sum + (parseFloat(i.finalAmount) || 0), 0);
            const avgInspectionValue = totalInspections > 0 ? (totalRevenue / totalInspections).toFixed(2) : 0;
            
            const ratingsSum = inspections.reduce((sum, i) => sum + (parseInt(i.rating) || 0), 0);
            const avgRating = totalInspections > 0 ? (ratingsSum / totalInspections).toFixed(1) : 0;
            
            document.getElementById('approvalRate').textContent = approvalRate + '%';
            document.getElementById('avgInspectionValue').textContent = avgInspectionValue + ' د.ك';
            document.getElementById('avgRating').textContent = avgRating + '/5';
        }

        // تصدير جميع البيانات كـ CSV
        function exportAllDataToCSV() {
            const today = new Date().toISOString().split('T')[0];
            
            // تصدير العملاء
            if (customers.length > 0) {
                exportToCSV(customers, `customers-${today}.csv`);
            }
            
            // تصدير المعاينات
            if (inspections.length > 0) {
                exportToCSV(inspections, `inspections-${today}.csv`);
            }
            
            showNotification('تم تصدير ملفات CSV - يمكنك الآن نسخها إلى Google Sheets', 'success');
            
            // إظهار تعليمات النسخ
            setTimeout(() => {
                alert(`📋 تعليمات النسخ إلى Google Sheets:

1. افتح Google Sheets: https://sheets.google.com
2. افتح الملف: ${SPREADSHEET_ID}
3. أنشئ شيت جديد باسم "Customers" 
4. افتح ملف customers-${today}.csv ونسخ المحتوى
5. الصق في شيت "Customers"
6. كرر نفس العملية لـ "Inspections"

✅ بهذه الطريقة ستكون البيانات محفوظة في Google Sheets!`);
            }, 2000);
        }

        // تصدير البيانات كـ JSON (للنسخ الاحتياطي)
        function exportData() {
            const data = {
                customers: customers,
                inspections: inspections,
                exportDate: new Date().toISOString(),
                environment: environmentType
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wajha-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('تم تصدير النسخة الاحتياطية بنجاح', 'success');
        }

        // تصدير تقرير العملاء (PDF)
        function exportCustomersReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إعداد الخط العربي (تقريبي)
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('Customers Report - Wajha', 20, 20);
            
            let yPosition = 40;
            customers.forEach((customer, index) => {
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${customer.name} - ${customer.phone}`, 20, yPosition);
                yPosition += 10;
                
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
            });
            
            doc.save('customers-report.pdf');
            showNotification('تم تصدير تقرير العملاء', 'success');
        }

        // تصدير تقرير المعاينات (PDF)
        function exportInspectionsReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('Inspections Report - Wajha', 20, 20);
            
            let yPosition = 40;
            inspections.forEach((inspection, index) => {
                doc.setFontSize(10);
                doc.text(`${index + 1}. ${inspection.customerName} - ${inspection.area} - ${inspection.finalAmount} KD`, 20, yPosition);
                yPosition += 8;
                
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
            });
            
            doc.save('inspections-report.pdf');
            showNotification('تم تصدير تقرير المعاينات', 'success');
        }

        // تصدير التقرير المالي (PDF)
        function exportFinancialReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const totalRevenue = inspections.reduce((sum, i) => sum + (parseFloat(i.finalAmount) || 0), 0);
            const approvedInspections = inspections.filter(i => i.approval === 'موافق').length;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('Financial Report - Wajha', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Total Revenue: ${totalRevenue.toFixed(2)} KD`, 20, 40);
            doc.text(`Approved Inspections: ${approvedInspections}`, 20, 55);
            doc.text(`Total Inspections: ${inspections.length}`, 20, 70);
            
            doc.save('financial-report.pdf');
            showNotification('تم تصدير التقرير المالي', 'success');
        }

        // إظهار الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-blue-500');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // إظهار الإشعار
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // إخفاء الإشعار
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // تحديث الواجهة
        function updateUI() {
            document.getElementById('totalCustomers').textContent = customers.length;
            updateDashboard();
            updateCustomersTable();
            updateInspectionsTable();
            updateReports();
        }

        // وظائف فارغة للتعديل (يمكن تطويرها لاحقاً)
        function editCustomer(customerId) {
            showNotification('ميزة التعديل قيد التطوير', 'info');
        }

        function editInspection(inspectionId) {
            showNotification('ميزة التعديل قيد التطوير', 'info');
        }

        // إعداد مستمعي الأحداث
        document.getElementById('addCustomerForm').addEventListener('submit', addCustomer);
        document.getElementById('addInspectionForm').addEventListener('submit', addInspection);

        // البحث في العملاء
        document.getElementById('customerSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#customersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // فلاتر المعاينات
        ['inspectionSearch', 'statusFilter', 'approvalFilter', 'dateFilter'].forEach(filterId => {
            document.getElementById(filterId).addEventListener('input', filterInspections);
        });

        function filterInspections() {
            const searchTerm = document.getElementById('inspectionSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const approvalFilter = document.getElementById('approvalFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const rows = document.querySelectorAll('#inspectionsTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const text = row.textContent.toLowerCase();
                const status = cells[5]?.textContent.trim();
                const approval = cells[6]?.textContent.trim();
                const date = cells[4]?.textContent.trim();
                
                let show = true;
                
                if (searchTerm && !text.includes(searchTerm)) show = false;
                if (statusFilter && status !== statusFilter) show = false;
                if (approvalFilter && approval !== approvalFilter) show = false;
                if (dateFilter && !date.includes(new Date(dateFilter).toLocaleDateString('ar-SA'))) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a3db7b843dc68b',t:'MTc1OTc0MDA2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
