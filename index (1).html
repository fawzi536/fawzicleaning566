<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة طلبات المعاينة والخدمات المنزلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
        }
        
        .status-active {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .status-completed {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        
        .rating-star {
            font-size: 1.5rem;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .rating-star.active {
            color: #fbbf24;
        }
        
        .rating-star:hover {
            color: #f59e0b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <span class="text-4xl ml-3">🏡</span>
                    Wajha Orders
                </h1>

            </div>

        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-6 py-8">
        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-8 overflow-hidden">
            <div class="flex border-b">
                <button onclick="showTab('new-inspection')" id="tab-new-inspection" class="flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-500 bg-blue-50">
                    طلب معاينة جديد
                </button>
                <button onclick="showTab('pending-inspections')" id="tab-pending-inspections" class="flex-1 py-4 px-6 text-center font-semibold text-gray-700 hover:text-blue-600 hover:bg-gray-50 transition-colors">
                    الطلبات المعلقة
                </button>
                <button onclick="showTab('completed-inspections')" id="tab-completed-inspections" class="flex-1 py-4 px-6 text-center font-semibold text-gray-700 hover:text-blue-600 hover:bg-gray-50 transition-colors">
                    الطلبات المكتملة
                </button>
            </div>
        </div>

        <!-- New Inspection Tab -->
        <div id="new-inspection-tab" class="tab-content">
            <!-- Customer Number Input -->
            <div id="customer-search" class="bg-white rounded-xl shadow-lg p-8 mb-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="text-2xl ml-3">🔎</span>
                    البحث عن العميل
                </h2>
                <div class="flex gap-4">
                    <input type="text" id="customerNumber" placeholder="أدخل رقم العميل" 
                           class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-lg" onkeyup="toggleCreateButton()">
                    <button onclick="searchCustomer()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold">
                        بحث
                    </button>
                    <button id="createNewButton" onclick="createNewInspection()" class="btn-success text-white px-8 py-3 rounded-lg font-semibold hidden">
                        إنشاء طلب معاينة جديد
                    </button>
                </div>
                
                <!-- Customer History Section -->
                <div id="customer-history" class="hidden mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-xl ml-2">📋</span>
                        طلبات العميل السابقة
                    </h3>
                    <div id="customer-history-table"></div>
                </div>
            </div>

            <!-- New Customer Form -->
            <div id="new-customer-form" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-2xl ml-3">👨‍💼</span>
                        إنشاء حساب عميل جديد
                    </h2>
                    <form id="customerForm" class="space-y-6">
                        <!-- Customer Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">رقم العميل *</label>
                                <input type="text" id="newCustomerNumber" readonly class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الاسم *</label>
                                <input type="text" id="customerName" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">رقم الجوال *</label>
                                <input type="tel" id="customerPhone" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">المنطقة *</label>
                                <select id="customerArea" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="updateAddressReview()"
                                    <option value="">اختر المنطقة</option>
                                    <option value="الشامية">الشامية</option>
                                    <option value="بيان">بيان</option>
                                    <option value="مشرف">مشرف</option>
                                    <option value="حولي">حولي</option>
                                    <option value="السالمية">السالمية</option>
                                    <option value="الجابرية">الجابرية</option>
                                    <option value="الزهراء">الزهراء</option>
                                    <option value="الرميثية">الرميثية</option>
                                    <option value="الصديق">الصديق</option>
                                    <option value="الفنطاس">الفنطاس</option>
                                    <option value="أبو حليفة">أبو حليفة</option>
                                    <option value="المهبولة">المهبولة</option>
                                    <option value="الفحيحيل">الفحيحيل</option>
                                    <option value="علي صباح السالم">علي صباح السالم</option>
                                    <option value="صباح السالم">صباح السالم</option>
                                    <option value="الأحمدي">الأحمدي</option>
                                    <option value="الفروانية">الفروانية</option>
                                    <option value="الرقة">الرقة</option>
                                    <option value="الرابية">الرابية</option>
                                    <option value="الأندلس">الأندلس</option>
                                    <option value="إشبيلية">إشبيلية</option>
                                    <option value="الضجيج">الضجيج</option>
                                    <option value="العارضية">العارضية</option>
                                    <option value="جليب الشيوخ">جليب الشيوخ</option>
                                    <option value="الرحاب">الرحاب</option>
                                    <option value="صباح الناصر">صباح الناصر</option>
                                    <option value="الصباحية">الصباحية</option>
                                    <option value="مبارك الكبير">مبارك الكبير</option>
                                    <option value="صبحان">صبحان</option>
                                    <option value="أبو فطيرة">أبو فطيرة</option>
                                    <option value="القصور">القصور</option>
                                    <option value="القرين">القرين</option>
                                    <option value="العدان">العدان</option>
                                    <option value="الجهراء">الجهراء</option>
                                    <option value="تيماء">تيماء</option>
                                    <option value="النسيم">النسيم</option>
                                    <option value="الواحة">الواحة</option>
                                    <option value="العيون">العيون</option>
                                    <option value="كاظمة">كاظمة</option>
                                    <option value="الصليبية">الصليبية</option>
                                    <option value="الشدادية">الشدادية</option>
                                    <option value="الشويخ">الشويخ</option>
                                    <option value="الدوحة">الدوحة</option>
                                    <option value="النزهة">النزهة</option>
                                    <option value="الفيحاء">الفيحاء</option>
                                    <option value="الخالدية">الخالدية</option>
                                    <option value="الدعية">الدعية</option>
                                    <option value="كيفان">كيفان</option>
                                    <option value="المنصورية">المنصورية</option>
                                    <option value="الدسمة">الدسمة</option>
                                    <option value="دسمان">دسمان</option>
                                    <option value="الشرق">الشرق</option>
                                    <option value="المرقاب">المرقاب</option>
                                    <option value="القبلة">القبلة</option>
                                    <option value="الصوابر">الصوابر</option>
                                    <option value="الروضة">الروضة</option>
                                    <option value="العديلية">العديلية</option>
                                    <option value="قرطبة">قرطبة</option>
                                    <option value="اليرموك">اليرموك</option>
                                    <option value="غرناطة">غرناطة</option>
                                    <option value="الصالحية">الصالحية</option>
                                    <option value="السرة">السرة</option>
                                    <option value="حطين">حطين</option>
                                    <option value="الشهداء">الشهداء</option>
                                    <option value="الوطية">الوطية</option>
                                    <option value="الزور">الزور</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">القطعة</label>
                                <input type="text" id="customerBlock" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم القطعة" onkeyup="updateAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الجادة</label>
                                <input type="text" id="customerAvenue" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم الجادة" onkeyup="updateAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الشارع</label>
                                <input type="text" id="customerStreet" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="اسم أو رقم الشارع" onkeyup="updateAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">رقم المنزل</label>
                                <input type="text" id="customerHouseNumber" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم المنزل" onkeyup="updateAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الموقع (اختياري)</label>
                                <input type="text" id="customerLocation" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رابط الموقع أو إحداثيات GPS">
                            </div>
                        </div>

                        <!-- Address Review Section -->
                        <div id="addressReview" class="bg-blue-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📍</span>
                                مراجعة العنوان المدخل
                            </h3>
                            <div id="addressDisplay" class="bg-white p-4 rounded-lg border-2 border-blue-200">
                                <p class="text-gray-700 font-medium">العنوان الكامل:</p>
                                <p id="fullAddress" class="text-lg font-bold text-blue-800 mt-2"></p>
                            </div>
                        </div>

                        <!-- Service Details -->
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">🧽</span>
                                تفاصيل الخدمة المطلوبة
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع الخدمة *</label>
                                    <select id="serviceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleServiceTypeOther()">
                                        <option value="">اختر نوع الخدمة</option>
                                        <option value="تنظيف عام">تنظيف عام</option>
                                        <option value="تنظيف عميق">تنظيف عميق</option>
                                        <option value="تنظيف بعد الدهان">تنظيف بعد الدهان</option>
                                        <option value="تنظيف المطبخ">تنظيف المطبخ</option>
                                        <option value="تنظيف الحمامات">تنظيف الحمامات</option>
                                        <option value="تنظيف النوافذ">تنظيف النوافذ</option>
                                        <option value="تنظيف السجاد والموكيت">تنظيف السجاد والموكيت</option>
                                        <option value="تنظيف الأثاث">تنظيف الأثاث</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                    <div id="serviceTypeOther" class="hidden mt-2">
                                        <input type="text" id="serviceTypeCustom" placeholder="حدد نوع الخدمة" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع السكن *</label>
                                    <select id="housingType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleHousingTypeOther()">
                                        <option value="">اختر نوع السكن</option>
                                        <option value="شقة">شقة</option>
                                        <option value="فيلا">فيلا</option>
                                        <option value="دوبلكس">دوبلكس</option>
                                        <option value="استوديو">استوديو</option>
                                        <option value="بيت شعبي">بيت شعبي</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                    <div id="housingTypeOther" class="hidden mt-2">
                                        <input type="text" id="housingTypeCustom" placeholder="حدد نوع المكان" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ المعاينة المفضل *</label>
                                    <input type="date" id="inspectionDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">وقت المعاينة المفضل *</label>
                                    <select id="inspectionTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="">اختر الوقت</option>
                                        <option value="صباحاً (8-12)">صباحاً (8-12)</option>
                                        <option value="ظهراً (12-4)">ظهراً (12-4)</option>
                                        <option value="مساءً (4-8)">مساءً (4-8)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-gray-700 font-medium mb-2">ملاحظات إضافية</label>
                                <textarea id="serviceNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="أي ملاحظات أو طلبات خاصة"></textarea>
                            </div>
                        </div>

                        <!-- Customer Approval -->
                        <div class="bg-yellow-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">✔️</span>
                                موافقة العميل على الخدمة (اختياري - يمكن تحديدها لاحقاً)
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">هل العميل موافق على الخدمة؟</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="customerApproval" value="موافق" onchange="togglePaymentSection()" class="ml-2">
                                            <span class="text-green-600 font-semibold">موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="customerApproval" value="غير موافق" onchange="togglePaymentSection()" class="ml-2">
                                            <span class="text-red-600 font-semibold">غير موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="customerApproval" value="في الانتظار" onchange="togglePaymentSection()" class="ml-2" checked>
                                            <span class="text-blue-600 font-semibold">في الانتظار</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Rejection Section -->
                                <div id="rejection-section" class="hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">السعر المقترح (دينار كويتي)</label>
                                            <input type="number" id="proposedPrice" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">سبب عدم الموافقة</label>
                                            <select id="rejectionReason" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" onchange="toggleRejectionReasonOther()">
                                                <option value="">اختر السبب</option>
                                                <option value="السعر مرتفع">السعر مرتفع</option>
                                                <option value="لا يحتاج الخدمة حالياً">لا يحتاج الخدمة حالياً</option>
                                                <option value="وجد خدمة أخرى">وجد خدمة أخرى</option>
                                                <option value="غير راضي عن المعاينة">غير راضي عن المعاينة</option>
                                                <option value="أسباب أخرى">أسباب أخرى</option>
                                            </select>
                                            <div id="rejectionReasonOther" class="hidden mt-2">
                                                <input type="text" id="rejectionReasonCustom" placeholder="حدد السبب" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details (shown only if approved) -->
                        <div id="payment-section" class="bg-green-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">💰</span>
                                معلومات الدفع
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">طريقة الدفع *</label>
                                    <select id="paymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="">اختر طريقة الدفع</option>
                                        <option value="كاش">كاش</option>
                                        <option value="فيزا">فيزا</option>
                                        <option value="كي نت">كي نت</option>
                                        <option value="ابل باي">ابل باي</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ الكلي (دينار كويتي) *</label>
                                    <input type="number" id="totalAmount" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نسبة الخصم (%)</label>
                                    <input type="number" id="discountPercentage" min="0" max="100" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ بعد الخصم</label>
                                    <input type="number" id="finalAmount" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">حالة الدفع *</label>
                                    <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="في الانتظار">في الانتظار</option>
                                        <option value="مدفوع">مدفوع</option>
                                        <option value="مدفوع جزئياً">مدفوع جزئياً</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Service Date (shown only if approved) -->
                        <div id="team-section" class="bg-purple-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📅</span>
                                تاريخ تنفيذ الخدمة
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ تنفيذ الخدمة</label>
                                    <input type="date" id="serviceDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Customer Satisfaction Rating (Only for approved and paid services) -->
                        <div id="rating-section" class="bg-orange-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">⭐️</span>
                                تقييم رضا العميل (للعملاء الموافقين والمدفوعين فقط)
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">مدى رضا العميل عن الخدمة (من 1 إلى 5)</label>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span onclick="setRating(1)" class="rating-star" data-rating="1">⭐</span>
                                        <span onclick="setRating(2)" class="rating-star" data-rating="2">⭐</span>
                                        <span onclick="setRating(3)" class="rating-star" data-rating="3">⭐</span>
                                        <span onclick="setRating(4)" class="rating-star" data-rating="4">⭐</span>
                                        <span onclick="setRating(5)" class="rating-star" data-rating="5">⭐</span>
                                        <span id="rating-text" class="mr-4 font-medium text-gray-700"></span>
                                    </div>
                                    <input type="hidden" id="customerRating" value="">
                                    <div class="text-sm text-gray-600 mt-2">
                                        <div><strong>1 نجمة:</strong> غير راضي تماماً</div>
                                        <div><strong>2 نجمة:</strong> غير راضي</div>
                                        <div><strong>3 نجمة:</strong> راضي إلى حد ما</div>
                                        <div><strong>4 نجمة:</strong> راضي</div>
                                        <div><strong>5 نجمة:</strong> راضي جداً</div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظة حول سبب التقييم</label>
                                    <textarea id="ratingNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="لماذا اختار العميل هذا التقييم؟"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Photos Section -->
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📷</span>
                                الصور والمقاطع
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Before Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-red-500 ml-2">📸</span>
                                        صور قبل التنظيف
                                    </h4>
                                    <input type="file" id="beforePhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleFileUpload('before', this.files)">
                                    <button type="button" onclick="document.getElementById('beforePhotos').click()" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع قبل التنظيف
                                    </button>
                                    <div id="beforePhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                                
                                <!-- After Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-green-500 ml-2">📸</span>
                                        صور بعد التنظيف
                                    </h4>
                                    <input type="file" id="afterPhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleFileUpload('after', this.files)">
                                    <button type="button" onclick="document.getElementById('afterPhotos').click()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع بعد التنظيف
                                    </button>
                                    <div id="afterPhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ملاحظات إضافية</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظات إضافية</label>
                                    <textarea id="inspectorNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="أي ملاحظات إضافية حول الطلب"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button type="submit" class="btn-primary text-white px-12 py-4 rounded-lg font-bold text-lg">
                                حفظ طلب المعاينة
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Existing Customer Form -->
            <div id="existing-customer-form" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-2xl ml-3">👤</span>
                        عميل موجود - طلب معاينة جديد
                    </h2>
                    <div id="existing-customer-info" class="bg-gray-50 p-4 rounded-lg mb-6"></div>
                    <div id="area-reminder" class="bg-blue-50 p-4 rounded-lg mb-6"></div>
                    
                    <form id="existingCustomerForm" class="space-y-6">
                        <!-- Address Details -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">المنطقة *</label>
                                <select id="newArea" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="updateExistingAddressReview()"
                                    <option value="">اختر المنطقة</option>
                                    <option value="الشامية">الشامية</option>
                                    <option value="بيان">بيان</option>
                                    <option value="مشرف">مشرف</option>
                                    <option value="حولي">حولي</option>
                                    <option value="السالمية">السالمية</option>
                                    <option value="الجابرية">الجابرية</option>
                                    <option value="الزهراء">الزهراء</option>
                                    <option value="الرميثية">الرميثية</option>
                                    <option value="الصديق">الصديق</option>
                                    <option value="الفنطاس">الفنطاس</option>
                                    <option value="أبو حليفة">أبو حليفة</option>
                                    <option value="المهبولة">المهبولة</option>
                                    <option value="الفحيحيل">الفحيحيل</option>
                                    <option value="علي صباح السالم">علي صباح السالم</option>
                                    <option value="صباح السالم">صباح السالم</option>
                                    <option value="الأحمدي">الأحمدي</option>
                                    <option value="الفروانية">الفروانية</option>
                                    <option value="الرقة">الرقة</option>
                                    <option value="الرابية">الرابية</option>
                                    <option value="الأندلس">الأندلس</option>
                                    <option value="إشبيلية">إشبيلية</option>
                                    <option value="الضجيج">الضجيج</option>
                                    <option value="العارضية">العارضية</option>
                                    <option value="جليب الشيوخ">جليب الشيوخ</option>
                                    <option value="الرحاب">الرحاب</option>
                                    <option value="صباح الناصر">صباح الناصر</option>
                                    <option value="الصباحية">الصباحية</option>
                                    <option value="مبارك الكبير">مبارك الكبير</option>
                                    <option value="صبحان">صبحان</option>
                                    <option value="أبو فطيرة">أبو فطيرة</option>
                                    <option value="القصور">القصور</option>
                                    <option value="القرين">القرين</option>
                                    <option value="العدان">العدان</option>
                                    <option value="الجهراء">الجهراء</option>
                                    <option value="تيماء">تيماء</option>
                                    <option value="النسيم">النسيم</option>
                                    <option value="الواحة">الواحة</option>
                                    <option value="العيون">العيون</option>
                                    <option value="كاظمة">كاظمة</option>
                                    <option value="الصليبية">الصليبية</option>
                                    <option value="الشدادية">الشدادية</option>
                                    <option value="الشويخ">الشويخ</option>
                                    <option value="الدوحة">الدوحة</option>
                                    <option value="النزهة">النزهة</option>
                                    <option value="الفيحاء">الفيحاء</option>
                                    <option value="الخالدية">الخالدية</option>
                                    <option value="الدعية">الدعية</option>
                                    <option value="كيفان">كيفان</option>
                                    <option value="المنصورية">المنصورية</option>
                                    <option value="الدسمة">الدسمة</option>
                                    <option value="دسمان">دسمان</option>
                                    <option value="الشرق">الشرق</option>
                                    <option value="المرقاب">المرقاب</option>
                                    <option value="القبلة">القبلة</option>
                                    <option value="الصوابر">الصوابر</option>
                                    <option value="الروضة">الروضة</option>
                                    <option value="العديلية">العديلية</option>
                                    <option value="قرطبة">قرطبة</option>
                                    <option value="اليرموك">اليرموك</option>
                                    <option value="غرناطة">غرناطة</option>
                                    <option value="الصالحية">الصالحية</option>
                                    <option value="السرة">السرة</option>
                                    <option value="حطين">حطين</option>
                                    <option value="الشهداء">الشهداء</option>
                                    <option value="الوطية">الوطية</option>
                                    <option value="الزور">الزور</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">القطعة</label>
                                <input type="text" id="existingCustomerBlock" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم القطعة" onkeyup="updateExistingAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الجادة</label>
                                <input type="text" id="existingCustomerAvenue" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم الجادة" onkeyup="updateExistingAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الشارع</label>
                                <input type="text" id="existingCustomerStreet" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="اسم أو رقم الشارع" onkeyup="updateExistingAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">رقم المنزل</label>
                                <input type="text" id="existingCustomerHouseNumber" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رقم المنزل" onkeyup="updateExistingAddressReview()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">الموقع (اختياري)</label>
                                <input type="text" id="existingCustomerLocation" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="رابط الموقع أو إحداثيات GPS">
                            </div>
                        </div>

                        <!-- Address Review Section for Existing Customer -->
                        <div id="existingAddressReview" class="bg-blue-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📍</span>
                                مراجعة العنوان المدخل
                            </h3>
                            <div id="existingAddressDisplay" class="bg-white p-4 rounded-lg border-2 border-blue-200">
                                <p class="text-gray-700 font-medium">العنوان الكامل:</p>
                                <p id="existingFullAddress" class="text-lg font-bold text-blue-800 mt-2"></p>
                            </div>
                        </div>

                        <!-- Same form sections as new customer but without name/phone -->
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">🧽</span>
                                تفاصيل الخدمة المطلوبة
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع الخدمة *</label>
                                    <select id="existingServiceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleExistingServiceTypeOther()">
                                        <option value="">اختر نوع الخدمة</option>
                                        <option value="تنظيف عام">تنظيف عام</option>
                                        <option value="تنظيف عميق">تنظيف عميق</option>
                                        <option value="تنظيف بعد الدهان">تنظيف بعد الدهان</option>
                                        <option value="تنظيف المطبخ">تنظيف المطبخ</option>
                                        <option value="تنظيف الحمامات">تنظيف الحمامات</option>
                                        <option value="تنظيف النوافذ">تنظيف النوافذ</option>
                                        <option value="تنظيف السجاد والموكيت">تنظيف السجاد والموكيت</option>
                                        <option value="تنظيف الأثاث">تنظيف الأثاث</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                    <div id="existingServiceTypeOther" class="hidden mt-2">
                                        <input type="text" id="existingServiceTypeCustom" placeholder="حدد نوع الخدمة" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع السكن *</label>
                                    <select id="existingHousingType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleExistingHousingTypeOther()">
                                        <option value="">اختر نوع السكن</option>
                                        <option value="شقة">شقة</option>
                                        <option value="فيلا">فيلا</option>
                                        <option value="دوبلكس">دوبلكس</option>
                                        <option value="استوديو">استوديو</option>
                                        <option value="بيت شعبي">بيت شعبي</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                    <div id="existingHousingTypeOther" class="hidden mt-2">
                                        <input type="text" id="existingHousingTypeCustom" placeholder="حدد نوع المكان" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ المعاينة المفضل *</label>
                                    <input type="date" id="existingInspectionDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">وقت المعاينة المفضل *</label>
                                    <select id="existingInspectionTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="">اختر الوقت</option>
                                        <option value="صباحاً (8-12)">صباحاً (8-12)</option>
                                        <option value="ظهراً (12-4)">ظهراً (12-4)</option>
                                        <option value="مساءً (4-8)">مساءً (4-8)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-gray-700 font-medium mb-2">ملاحظات إضافية</label>
                                <textarea id="existingServiceNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="أي ملاحظات أو طلبات خاصة"></textarea>
                            </div>
                        </div>

                        <!-- Customer Approval -->
                        <div class="bg-yellow-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">✔️</span>
                                موافقة العميل على الخدمة (اختياري - يمكن تحديدها لاحقاً)
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">هل العميل موافق على الخدمة؟</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="existingCustomerApproval" value="موافق" onchange="toggleExistingPaymentSection()" class="ml-2">
                                            <span class="text-green-600 font-semibold">موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="existingCustomerApproval" value="غير موافق" onchange="toggleExistingPaymentSection()" class="ml-2">
                                            <span class="text-red-600 font-semibold">غير موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="existingCustomerApproval" value="في الانتظار" onchange="toggleExistingPaymentSection()" class="ml-2" checked>
                                            <span class="text-blue-600 font-semibold">في الانتظار</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Rejection Section -->
                                <div id="existing-rejection-section" class="hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">السعر المقترح (دينار كويتي)</label>
                                            <input type="number" id="existingProposedPrice" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">سبب عدم الموافقة</label>
                                            <select id="existingRejectionReason" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                                <option value="">اختر السبب</option>
                                                <option value="السعر مرتفع">السعر مرتفع</option>
                                                <option value="لا يحتاج الخدمة حالياً">لا يحتاج الخدمة حالياً</option>
                                                <option value="وجد خدمة أخرى">وجد خدمة أخرى</option>
                                                <option value="غير راضي عن المعاينة">غير راضي عن المعاينة</option>
                                                <option value="أسباب أخرى">أسباب أخرى</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details (shown only if approved) -->
                        <div id="existing-payment-section" class="bg-green-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">💰</span>
                                معلومات الدفع
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">طريقة الدفع *</label>
                                    <select id="existingPaymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="">اختر طريقة الدفع</option>
                                        <option value="كاش">كاش</option>
                                        <option value="فيزا">فيزا</option>
                                        <option value="كي نت">كي نت</option>
                                        <option value="ابل باي">ابل باي</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ الكلي (دينار كويتي) *</label>
                                    <input type="number" id="existingTotalAmount" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateExistingDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نسبة الخصم (%)</label>
                                    <input type="number" id="existingDiscountPercentage" min="0" max="100" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateExistingDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ بعد الخصم</label>
                                    <input type="number" id="existingFinalAmount" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">حالة الدفع *</label>
                                    <select id="existingPaymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="في الانتظار">في الانتظار</option>
                                        <option value="مدفوع">مدفوع</option>
                                        <option value="مدفوع جزئياً">مدفوع جزئياً</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Service Date (shown only if approved) -->
                        <div id="existing-team-section" class="bg-purple-50 p-6 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📅</span>
                                تاريخ تنفيذ الخدمة
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ تنفيذ الخدمة</label>
                                    <input type="date" id="existingServiceDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Customer Satisfaction Rating -->
                        <div class="bg-orange-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">⭐</span>
                                تقييم رضا العميل
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">مدى رضا العميل عن المعاينة (من 1 إلى 5)</label>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span onclick="setExistingRating(1)" class="existing-rating-star" data-rating="1">⭐</span>
                                        <span onclick="setExistingRating(2)" class="existing-rating-star" data-rating="2">⭐</span>
                                        <span onclick="setExistingRating(3)" class="existing-rating-star" data-rating="3">⭐</span>
                                        <span onclick="setExistingRating(4)" class="existing-rating-star" data-rating="4">⭐</span>
                                        <span onclick="setExistingRating(5)" class="existing-rating-star" data-rating="5">⭐</span>
                                        <span id="existing-rating-text" class="mr-4 font-medium text-gray-700"></span>
                                    </div>
                                    <input type="hidden" id="existingCustomerRating" value="">
                                    <div class="text-sm text-gray-600 mt-2">
                                        <div><strong>1 نجمة:</strong> غير راضي تماماً</div>
                                        <div><strong>2 نجمة:</strong> غير راضي</div>
                                        <div><strong>3 نجمة:</strong> راضي إلى حد ما</div>
                                        <div><strong>4 نجمة:</strong> راضي</div>
                                        <div><strong>5 نجمة:</strong> راضي جداً</div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظة حول سبب التقييم</label>
                                    <textarea id="existingRatingNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="لماذا اختار العميل هذا التقييم؟"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Photos Section -->
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📷</span>
                                الصور والمقاطع
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Before Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-red-500 ml-2">📸</span>
                                        صور قبل التنظيف
                                    </h4>
                                    <input type="file" id="existingBeforePhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleFileUpload('existingBefore', this.files)">
                                    <button type="button" onclick="document.getElementById('existingBeforePhotos').click()" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع قبل التنظيف
                                    </button>
                                    <div id="existingBeforePhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                                
                                <!-- After Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-green-500 ml-2">📸</span>
                                        صور بعد التنظيف
                                    </h4>
                                    <input type="file" id="existingAfterPhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleFileUpload('existingAfter', this.files)">
                                    <button type="button" onclick="document.getElementById('existingAfterPhotos').click()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع بعد التنظيف
                                    </button>
                                    <div id="existingAfterPhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ملاحظات إضافية</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظات إضافية</label>
                                    <textarea id="existingInspectorNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="أي ملاحظات إضافية حول الطلب"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button type="submit" class="btn-primary text-white px-12 py-4 rounded-lg font-bold text-lg">
                                حفظ طلب المعاينة
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pending Inspections Tab -->
        <div id="pending-inspections-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="text-2xl ml-3">⏳</span>
                    الطلبات المعلقة
                </h2>
                <div id="pending-inspections-table"></div>
            </div>
        </div>

        <!-- Completed Inspections Tab -->
        <div id="completed-inspections-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="text-2xl ml-3">✅</span>
                    الطلبات المكتملة
                </h2>
                
                <!-- Filters Section -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="text-lg ml-2">🔍</span>
                        فلاتر البحث
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div id="filterInspectionNumberContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">رقم المعاينة</label>
                            <input type="text" id="filterInspectionNumber" placeholder="ابحث برقم المعاينة" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onkeyup="filterCompletedInspections()">
                        </div>
                        <div id="filterCustomerIdContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">رقم العميل</label>
                            <input type="text" id="filterCustomerId" placeholder="ابحث برقم العميل" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onkeyup="filterCompletedInspections()">
                        </div>
                        <div id="filterCustomerNameContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">اسم العميل</label>
                            <input type="text" id="filterCustomerName" placeholder="ابحث باسم العميل" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onkeyup="filterCompletedInspections()">
                        </div>
                        <div id="filterAreaContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">المنطقة</label>
                            <select id="filterArea" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                                <option value="">جميع المناطق</option>
                                <option value="حولي">حولي</option>
                                <option value="الأحمدي">الأحمدي</option>
                                <option value="الفروانية">الفروانية</option>
                                <option value="مبارك الكبير">مبارك الكبير</option>
                                <option value="الجهراء">الجهراء</option>
                                <option value="العاصمة">العاصمة</option>
                            </select>
                        </div>
                        <div id="filterServiceTypeContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">نوع الخدمة</label>
                            <select id="filterServiceType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                                <option value="">جميع الخدمات</option>
                                <option value="تنظيف عام">تنظيف عام</option>
                                <option value="تنظيف عميق">تنظيف عميق</option>
                                <option value="تنظيف بعد الدهان">تنظيف بعد الدهان</option>
                                <option value="تنظيف المطبخ">تنظيف المطبخ</option>
                                <option value="تنظيف الحمامات">تنظيف الحمامات</option>
                                <option value="تنظيف النوافذ">تنظيف النوافذ</option>
                                <option value="تنظيف السجاد والموكيت">تنظيف السجاد والموكيت</option>
                                <option value="تنظيف الأثاث">تنظيف الأثاث</option>
                            </select>
                        </div>
                        <div id="filterDateFromContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">من تاريخ</label>
                            <input type="date" id="filterDateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                        </div>
                        <div id="filterDateToContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">إلى تاريخ</label>
                            <input type="date" id="filterDateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                        </div>
                        <div id="filterApprovalContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">الموافقة</label>
                            <select id="filterApproval" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                                <option value="">جميع الحالات</option>
                                <option value="موافق">موافق</option>
                                <option value="غير موافق">غير موافق</option>
                                <option value="في الانتظار">في الانتظار</option>
                            </select>
                        </div>
                        <div id="filterRatingContainer" class="hidden">
                            <label class="block text-gray-700 font-medium mb-2">التقييم</label>
                            <select id="filterRating" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="filterCompletedInspections()">
                                <option value="">جميع التقييمات</option>
                                <option value="1">1 نجمة</option>
                                <option value="2">2 نجمة</option>
                                <option value="3">3 نجمة</option>
                                <option value="4">4 نجمة</option>
                                <option value="5">5 نجمة</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button onclick="clearFilters()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            مسح الفلاتر
                        </button>
                    </div>
                </div>
                
                <div id="completed-inspections-table"></div>
                
                <!-- Pagination Controls -->
                <div id="pagination-controls" class="flex justify-center items-center mt-6 space-x-2 hidden">
                    <button id="prevPage" onclick="changePage(-1)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                        السابق
                    </button>
                    <div id="pageInfo" class="mx-4 text-gray-700 font-medium"></div>
                    <button id="nextPage" onclick="changePage(1)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                        التالي
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspection Details Modal -->
    <div id="inspectionModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">تفاصيل المعاينة</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                <div id="inspectionDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let customers = JSON.parse(localStorage.getItem('customers')) || {};
        let inspections = JSON.parse(localStorage.getItem('inspections')) || [];
        let inspectionCounter = parseInt(localStorage.getItem('inspectionCounter')) || 1000;
        let currentCustomerId = null;
        let uploadedFiles = {
            before: [],
            after: [],
            existingBefore: [],
            existingAfter: []
        };
        let currentEditingInspection = null;
        
        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredCompletedInspections = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setMinDate();
            renderPendingInspections();
            renderCompletedInspections(); // This will show all completed inspections by default
            
            // Style rating stars
            document.querySelectorAll('.rating-star, .existing-rating-star').forEach(star => {
                star.style.fontSize = '1.5rem';
                star.style.color = '#d1d5db';
                star.style.cursor = 'pointer';
                star.style.transition = 'color 0.2s';
            });
        });

        // Handle file uploads
        function handleFileUpload(type, files) {
            uploadedFiles[type] = Array.from(files);
            displayFilePreview(type, files);
        }

        function displayFilePreview(type, files) {
            const previewContainer = document.getElementById(type + 'PhotosPreview');
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'relative bg-gray-100 p-2 rounded-lg';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'w-full h-20 object-cover rounded';
                    fileDiv.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'w-full h-20 object-cover rounded';
                    video.controls = true;
                    fileDiv.appendChild(video);
                }
                
                const fileName = document.createElement('p');
                fileName.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                fileName.className = 'text-xs text-gray-600 mt-1 text-center';
                fileDiv.appendChild(fileName);
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600';
                removeBtn.onclick = () => removeFile(type, index);
                fileDiv.appendChild(removeBtn);
                
                previewContainer.appendChild(fileDiv);
            });
        }

        function removeFile(type, index) {
            uploadedFiles[type].splice(index, 1);
            const input = document.getElementById(type + 'Photos');
            const dt = new DataTransfer();
            uploadedFiles[type].forEach(file => dt.items.add(file));
            input.files = dt.files;
            displayFilePreview(type, uploadedFiles[type]);
        }



        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').min = today;
            if (document.getElementById('existingInspectionDate')) {
                document.getElementById('existingInspectionDate').min = today;
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('text-gray-700');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById(tabName + '-tab').classList.add('fade-in');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-500', 'bg-blue-50');
            activeBtn.classList.remove('text-gray-700');
        }

        function searchCustomer() {
            const customerNumber = document.getElementById('customerNumber').value.trim();
            
            if (!customerNumber) {
                alert('يرجى إدخال رقم العميل');
                return;
            }

            // Show customer history first
            showCustomerHistory(customerNumber);
        }

        function createNewInspection() {
            const customerNumber = document.getElementById('customerNumber').value.trim();
            
            if (!customerNumber) {
                alert('يرجى إدخال رقم العميل أولاً');
                return;
            }

            if (customers[customerNumber]) {
                // Existing customer
                currentCustomerId = customerNumber;
                showExistingCustomerForm(customerNumber);
            } else {
                // New customer
                currentCustomerId = customerNumber;
                showNewCustomerForm();
            }
        }

        function showCustomerHistory(customerNumber) {
            const customerInspections = inspections.filter(inspection => inspection.customerId === customerNumber);
            const historySection = document.getElementById('customer-history');
            const historyTable = document.getElementById('customer-history-table');
            
            if (customerInspections.length === 0) {
                historyTable.innerHTML = '<p class="text-gray-600 text-center py-4">لا توجد طلبات سابقة لهذا العميل</p>';
            } else {
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                                    <th class="border border-gray-300 p-3 text-right">رقم المعاينة</th>
                                    <th class="border border-gray-300 p-3 text-right">المنطقة</th>
                                    <th class="border border-gray-300 p-3 text-right">نوع الخدمة</th>
                                    <th class="border border-gray-300 p-3 text-right">تاريخ المعاينة</th>
                                    <th class="border border-gray-300 p-3 text-right">الموافقة</th>
                                    <th class="border border-gray-300 p-3 text-right">الحالة</th>
                                    <th class="border border-gray-300 p-3 text-right">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                customerInspections.forEach(inspection => {
                    let approvalColor = 'text-blue-600';
                    if (inspection.customerApproval === 'موافق') approvalColor = 'text-green-600';
                    else if (inspection.customerApproval === 'غير موافق') approvalColor = 'text-red-600';
                    
                    let statusColor = inspection.status === 'مكتمل' ? 'text-green-600' : 'text-orange-600';
                    
                    tableHTML += `
                        <tr class="hover:bg-indigo-50 transition-colors">
                            <td class="border border-gray-300 p-3 font-semibold text-indigo-600">${inspection.inspectionNumber}</td>
                            <td class="border border-gray-300 p-3">${inspection.area}</td>
                            <td class="border border-gray-300 p-3">${inspection.serviceType}</td>
                            <td class="border border-gray-300 p-3">${inspection.inspectionDate}</td>
                            <td class="border border-gray-300 p-3 font-semibold ${approvalColor}">${inspection.customerApproval}</td>
                            <td class="border border-gray-300 p-3 font-semibold ${statusColor}">${inspection.status}</td>
                            <td class="border border-gray-300 p-3">
                                <button onclick="viewInspectionDetails('${inspection.inspectionNumber}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                    عرض التفاصيل
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table></div>';
                historyTable.innerHTML = tableHTML;
            }
            
            historySection.classList.remove('hidden');
            historySection.classList.add('fade-in');
        }

        function toggleServiceTypeOther() {
            const serviceType = document.getElementById('serviceType').value;
            const otherSection = document.getElementById('serviceTypeOther');
            
            if (serviceType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('serviceTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('serviceTypeCustom').required = false;
                document.getElementById('serviceTypeCustom').value = '';
            }
        }

        function toggleHousingTypeOther() {
            const housingType = document.getElementById('housingType').value;
            const otherSection = document.getElementById('housingTypeOther');
            
            if (housingType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('housingTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('housingTypeCustom').required = false;
                document.getElementById('housingTypeCustom').value = '';
            }
        }

        function toggleExistingServiceTypeOther() {
            const serviceType = document.getElementById('existingServiceType').value;
            const otherSection = document.getElementById('existingServiceTypeOther');
            
            if (serviceType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('existingServiceTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('existingServiceTypeCustom').required = false;
                document.getElementById('existingServiceTypeCustom').value = '';
            }
        }

        function toggleExistingHousingTypeOther() {
            const housingType = document.getElementById('existingHousingType').value;
            const otherSection = document.getElementById('existingHousingTypeOther');
            
            if (housingType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('existingHousingTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('existingHousingTypeCustom').required = false;
                document.getElementById('existingHousingTypeCustom').value = '';
            }
        }

        function showNewCustomerForm() {
            document.getElementById('customer-search').style.display = 'none';
            document.getElementById('new-customer-form').classList.remove('hidden');
            document.getElementById('new-customer-form').classList.add('fade-in');
            
            // Set the customer number in the readonly field
            document.getElementById('newCustomerNumber').value = currentCustomerId;
        }

        function showExistingCustomerForm(customerNumber) {
            const customer = customers[customerNumber];
            const customerInspections = inspections.filter(inspection => inspection.customerId === customerNumber);
            
            document.getElementById('customer-search').style.display = 'none';
            document.getElementById('existing-customer-form').classList.remove('hidden');
            document.getElementById('existing-customer-form').classList.add('fade-in');
            
            // Display customer info (read-only)
            document.getElementById('existing-customer-info').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><strong>الاسم:</strong> ${customer.name} <span class="text-gray-500">(غير قابل للتعديل)</span></div>
                    <div><strong>رقم الجوال:</strong> ${customer.phone} <span class="text-gray-500">(غير قابل للتعديل)</span></div>
                </div>
            `;
            
            // Show area reminder
            if (customerInspections.length > 0) {
                const lastInspection = customerInspections[customerInspections.length - 1];
                document.getElementById('area-reminder').innerHTML = `
                    <div class="flex items-center">
                        <span class="text-blue-600 ml-2">💡</span>
                        <strong>تذكير:</strong> آخر معاينة كانت في منطقة <strong>${lastInspection.area}</strong>
                    </div>
                `;
            } else {
                document.getElementById('area-reminder').innerHTML = `
                    <div class="flex items-center">
                        <span class="text-blue-600 ml-2">ℹ️</span>
                        <strong>ملاحظة:</strong> هذا أول طلب معاينة لهذا العميل
                    </div>
                `;
            }
            
            // Setup address review listeners after form is shown
            setTimeout(() => {
                setupAddressReviewListeners();
            }, 100);
        }

        function toggleCreateButton() {
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const createButton = document.getElementById('createNewButton');
            
            if (customerNumber) {
                createButton.classList.remove('hidden');
            } else {
                createButton.classList.add('hidden');
            }
        }

        function calculateDiscount() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
            
            const discountAmount = (totalAmount * discountPercentage) / 100;
            const finalAmount = totalAmount - discountAmount;
            
            document.getElementById('finalAmount').value = finalAmount.toFixed(2);
        }

        function calculateExistingDiscount() {
            const totalAmount = parseFloat(document.getElementById('existingTotalAmount').value) || 0;
            const discountPercentage = parseFloat(document.getElementById('existingDiscountPercentage').value) || 0;
            
            const discountAmount = (totalAmount * discountPercentage) / 100;
            const finalAmount = totalAmount - discountAmount;
            
            document.getElementById('existingFinalAmount').value = finalAmount.toFixed(2);
        }

        function showFilter(filterType) {
            // Hide all filter containers first
            const allContainers = [
                'filterInspectionNumberContainer',
                'filterCustomerIdContainer', 
                'filterCustomerNameContainer',
                'filterAreaContainer',
                'filterServiceTypeContainer',
                'filterDateFromContainer',
                'filterDateToContainer',
                'filterApprovalContainer',
                'filterRatingContainer'
            ];
            
            allContainers.forEach(containerId => {
                document.getElementById(containerId).classList.add('hidden');
            });
            
            // Show the specific filter container
            let containerToShow = '';
            switch(filterType) {
                case 'inspectionNumber':
                    containerToShow = 'filterInspectionNumberContainer';
                    break;
                case 'customerId':
                    containerToShow = 'filterCustomerIdContainer';
                    break;
                case 'customerName':
                    containerToShow = 'filterCustomerNameContainer';
                    break;
                case 'area':
                    containerToShow = 'filterAreaContainer';
                    break;
                case 'serviceType':
                    containerToShow = 'filterServiceTypeContainer';
                    break;
                case 'dateFrom':
                    containerToShow = 'filterDateFromContainer';
                    document.getElementById('filterDateToContainer').classList.remove('hidden');
                    break;
                case 'approval':
                    containerToShow = 'filterApprovalContainer';
                    break;
                case 'rating':
                    containerToShow = 'filterRatingContainer';
                    break;
            }
            
            if (containerToShow) {
                document.getElementById(containerToShow).classList.remove('hidden');
            }
        }

        function togglePaymentSection() {
            const approval = document.querySelector('input[name="customerApproval"]:checked');
            const paymentSection = document.getElementById('payment-section');
            const rejectionSection = document.getElementById('rejection-section');
            const teamSection = document.getElementById('team-section');
            const ratingSection = document.getElementById('rating-section');
            
            if (approval && approval.value === 'موافق') {
                paymentSection.classList.remove('hidden');
                teamSection.classList.remove('hidden');
                rejectionSection.classList.add('hidden');
                ratingSection.classList.remove('hidden');
            } else if (approval && approval.value === 'غير موافق') {
                paymentSection.classList.add('hidden');
                teamSection.classList.add('hidden');
                rejectionSection.classList.remove('hidden');
                ratingSection.classList.add('hidden');
            } else {
                // في الانتظار أو لا يوجد اختيار
                paymentSection.classList.add('hidden');
                teamSection.classList.add('hidden');
                rejectionSection.classList.add('hidden');
                ratingSection.classList.add('hidden');
            }
        }

        function toggleRejectionReasonOther() {
            const rejectionReason = document.getElementById('rejectionReason').value;
            const otherSection = document.getElementById('rejectionReasonOther');
            
            if (rejectionReason === 'أسباب أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('rejectionReasonCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('rejectionReasonCustom').required = false;
                document.getElementById('rejectionReasonCustom').value = '';
            }
        }

        function toggleExistingPaymentSection() {
            const approval = document.querySelector('input[name="existingCustomerApproval"]:checked');
            const paymentSection = document.getElementById('existing-payment-section');
            const rejectionSection = document.getElementById('existing-rejection-section');
            
            if (approval && approval.value === 'موافق') {
                paymentSection.classList.remove('hidden');
                rejectionSection.classList.add('hidden');
            } else if (approval && approval.value === 'غير موافق') {
                paymentSection.classList.add('hidden');
                rejectionSection.classList.remove('hidden');
            } else {
                // في الانتظار أو لا يوجد اختيار
                paymentSection.classList.add('hidden');
                rejectionSection.classList.add('hidden');
            }
        }

        function setRating(rating) {
            document.getElementById('customerRating').value = rating;
            
            // Update star colors
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#fbbf24';
                } else {
                    star.style.color = '#d1d5db';
                }
            });
            
            // Update rating text
            const ratingTexts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            
            document.getElementById('rating-text').textContent = ratingTexts[rating];
        }

        function setExistingRating(rating) {
            document.getElementById('existingCustomerRating').value = rating;
            
            // Update star colors
            document.querySelectorAll('.existing-rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#fbbf24';
                } else {
                    star.style.color = '#d1d5db';
                }
            });
            
            // Update rating text
            const ratingTexts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            
            document.getElementById('existing-rating-text').textContent = ratingTexts[rating];
        }

        // New customer form submission
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const inspectionNumber = 'ID-' + (++inspectionCounter);
                const approval = document.querySelector('input[name="customerApproval"]:checked');
                
                // Validate required fields
                const customerName = document.getElementById('customerName').value.trim();
                const customerPhone = document.getElementById('customerPhone').value.trim();
                const customerArea = document.getElementById('customerArea').value;
                const serviceType = document.getElementById('serviceType').value;
                const housingType = document.getElementById('housingType').value;
                const inspectionDate = document.getElementById('inspectionDate').value;
                const inspectionTime = document.getElementById('inspectionTime').value;
                
                if (!customerName || !customerPhone || !customerArea || !serviceType || !housingType || !inspectionDate || !inspectionTime) {
                    alert('يرجى ملء جميع الحقول المطلوبة (المحددة بعلامة *)');
                    return;
                }
                
                // Save customer data if new
                if (!customers[currentCustomerId]) {
                    customers[currentCustomerId] = {
                        name: customerName,
                        phone: customerPhone,
                        createdAt: new Date().toISOString()
                    };
                }
                
                // Get service type (custom or selected)
                const serviceTypeValue = document.getElementById('serviceType').value;
                const finalServiceType = serviceTypeValue === 'أخرى' ? (document.getElementById('serviceTypeCustom').value || serviceTypeValue) : serviceTypeValue;
                
                // Get housing type (custom or selected)
                const housingTypeValue = document.getElementById('housingType').value;
                const finalHousingType = housingTypeValue === 'أخرى' ? (document.getElementById('housingTypeCustom').value || housingTypeValue) : housingTypeValue;

                // Create new inspection
                const newInspection = {
                    inspectionNumber: inspectionNumber,
                    customerId: currentCustomerId,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    area: customerArea,
                    block: document.getElementById('customerBlock').value || '',
                    avenue: document.getElementById('customerAvenue').value || '',
                    street: document.getElementById('customerStreet').value || '',
                    houseNumber: document.getElementById('customerHouseNumber').value || '',
                    location: document.getElementById('customerLocation').value || '',
                    serviceType: finalServiceType,
                    housingType: finalHousingType,
                    inspectionDate: inspectionDate,
                    inspectionTime: inspectionTime,
                    serviceNotes: document.getElementById('serviceNotes').value || '',
                    customerApproval: approval ? approval.value : 'في الانتظار',
                    customerRating: document.getElementById('customerRating').value || '',
                    ratingNotes: document.getElementById('ratingNotes').value || '',
                    inspectorNotes: document.getElementById('inspectorNotes').value || '',
                    status: (approval && approval.value === 'غير موافق') ? 'مكتمل' : 'معلق',
                    createdAt: new Date().toISOString()
                };
                
                // Add approval-specific data
                if (approval && approval.value === 'موافق') {
                    newInspection.paymentMethod = document.getElementById('paymentMethod').value || '';
                    newInspection.totalAmount = document.getElementById('totalAmount').value || '';
                    newInspection.discountPercentage = document.getElementById('discountPercentage').value || '';
                    newInspection.finalAmount = document.getElementById('finalAmount').value || '';
                    newInspection.paymentStatus = document.getElementById('paymentStatus').value || 'في الانتظار';
                    newInspection.serviceDate = document.getElementById('serviceDate').value || '';
                } else if (approval && approval.value === 'غير موافق') {
                    newInspection.proposedPrice = document.getElementById('proposedPrice').value || '';
                    newInspection.rejectionReason = document.getElementById('rejectionReason').value || '';
                }
                
                // Add photos data
                newInspection.beforePhotos = uploadedFiles.before ? uploadedFiles.before.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                })) : [];
                newInspection.afterPhotos = uploadedFiles.after ? uploadedFiles.after.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                })) : [];

                // Add to inspections array
                inspections.push(newInspection);

                // Save to localStorage
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('inspections', JSON.stringify(inspections));
                localStorage.setItem('inspectionCounter', inspectionCounter.toString());
                
                alert(`تم حفظ طلب المعاينة بنجاح!\nرقم المعاينة: ${inspectionNumber}`);
                
                // Reset form
                resetNewInspectionForm();
                renderPendingInspections();
                renderCompletedInspections();
                
            } catch (error) {
                console.error('خطأ في حفظ طلب المعاينة:', error);
                alert('حدث خطأ أثناء حفظ طلب المعاينة. يرجى المحاولة مرة أخرى.');
            }
        });

        // Existing customer form submission
        document.getElementById('existingCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const inspectionNumber = 'ID-' + (++inspectionCounter);
                const approval = document.querySelector('input[name="existingCustomerApproval"]:checked');
                
                const customer = customers[currentCustomerId];
                if (!customer) {
                    alert('خطأ: لم يتم العثور على بيانات العميل');
                    return;
                }
                
                // Validate required fields
                const newArea = document.getElementById('newArea').value;
                const existingServiceType = document.getElementById('existingServiceType').value;
                const existingHousingType = document.getElementById('existingHousingType').value;
                const existingInspectionDate = document.getElementById('existingInspectionDate').value;
                const existingInspectionTime = document.getElementById('existingInspectionTime').value;
                
                if (!newArea || !existingServiceType || !existingHousingType || !existingInspectionDate || !existingInspectionTime) {
                    alert('يرجى ملء جميع الحقول المطلوبة (المحددة بعلامة *)');
                    return;
                }
                
                // Get service type (custom or selected)
                const existingServiceTypeValue = document.getElementById('existingServiceType').value;
                const finalExistingServiceType = existingServiceTypeValue === 'أخرى' ? (document.getElementById('existingServiceTypeCustom').value || existingServiceTypeValue) : existingServiceTypeValue;
                
                // Get housing type (custom or selected)
                const existingHousingTypeValue = document.getElementById('existingHousingType').value;
                const finalExistingHousingType = existingHousingTypeValue === 'أخرى' ? (document.getElementById('existingHousingTypeCustom').value || existingHousingTypeValue) : existingHousingTypeValue;
                
                // Create new inspection
                const newInspection = {
                    inspectionNumber: inspectionNumber,
                    customerId: currentCustomerId,
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    area: newArea,
                    block: document.getElementById('existingCustomerBlock').value || '',
                    avenue: document.getElementById('existingCustomerAvenue').value || '',
                    street: document.getElementById('existingCustomerStreet').value || '',
                    houseNumber: document.getElementById('existingCustomerHouseNumber').value || '',
                    location: document.getElementById('existingCustomerLocation').value || '',
                    serviceType: finalExistingServiceType,
                    housingType: finalExistingHousingType,
                    inspectionDate: existingInspectionDate,
                    inspectionTime: existingInspectionTime,
                    serviceNotes: document.getElementById('existingServiceNotes').value || '',
                    customerApproval: approval ? approval.value : 'في الانتظار',
                    customerRating: document.getElementById('existingCustomerRating').value || '',
                    ratingNotes: document.getElementById('existingRatingNotes').value || '',
                    inspectorNotes: document.getElementById('existingInspectorNotes').value || '',
                    status: (approval && approval.value === 'غير موافق') ? 'مكتمل' : 'معلق',
                    createdAt: new Date().toISOString()
                };
                
                // Add approval-specific data
                if (approval && approval.value === 'موافق') {
                    newInspection.paymentMethod = document.getElementById('existingPaymentMethod').value || '';
                    newInspection.totalAmount = document.getElementById('existingTotalAmount').value || '';
                    newInspection.discountPercentage = document.getElementById('existingDiscountPercentage').value || '';
                    newInspection.finalAmount = document.getElementById('existingFinalAmount').value || '';
                    newInspection.paymentStatus = document.getElementById('existingPaymentStatus').value || 'في الانتظار';
                    newInspection.serviceDate = document.getElementById('existingServiceDate').value || '';
                } else if (approval && approval.value === 'غير موافق') {
                    newInspection.proposedPrice = document.getElementById('existingProposedPrice').value || '';
                    newInspection.rejectionReason = document.getElementById('existingRejectionReason').value || '';
                }
                
                // Add photos data
                newInspection.beforePhotos = uploadedFiles.existingBefore ? uploadedFiles.existingBefore.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                })) : [];
                newInspection.afterPhotos = uploadedFiles.existingAfter ? uploadedFiles.existingAfter.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                })) : [];
                
                // Add to inspections array
                inspections.push(newInspection);
                
                // Save to localStorage
                localStorage.setItem('inspections', JSON.stringify(inspections));
                localStorage.setItem('inspectionCounter', inspectionCounter.toString());
                
                alert(`تم حفظ طلب المعاينة بنجاح!\nرقم المعاينة: ${inspectionNumber}`);
                
                // Reset form
                resetNewInspectionForm();
                renderPendingInspections();
                renderCompletedInspections();
                
            } catch (error) {
                console.error('خطأ في حفظ طلب المعاينة:', error);
                alert('حدث خطأ أثناء حفظ طلب المعاينة. يرجى المحاولة مرة أخرى.');
            }
        });

        function resetNewInspectionForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('existingCustomerForm').reset();
            document.getElementById('new-customer-form').classList.add('hidden');
            document.getElementById('existing-customer-form').classList.add('hidden');
            document.getElementById('customer-search').style.display = 'block';
            document.getElementById('customerNumber').value = '';
            currentCustomerId = null;
            
            // Reset sections
            document.getElementById('payment-section').classList.add('hidden');
            document.getElementById('rejection-section').classList.add('hidden');
            document.getElementById('existing-payment-section').classList.add('hidden');
            document.getElementById('existing-rejection-section').classList.add('hidden');
            document.getElementById('customer-history').classList.add('hidden');
            
            // Reset ratings
            document.querySelectorAll('.rating-star, .existing-rating-star').forEach(star => {
                star.style.color = '#d1d5db';
            });
            document.getElementById('rating-text').textContent = '';
            document.getElementById('existing-rating-text').textContent = '';
            
            // Reset uploaded files
            uploadedFiles = {
                before: [],
                after: [],
                existingBefore: [],
                existingAfter: []
            };
            
            // Clear file previews
            ['beforePhotosPreview', 'afterPhotosPreview', 'existingBeforePhotosPreview', 'existingAfterPhotosPreview'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
        }

        // Filter functions for completed inspections
        function filterCompletedInspections() {
            const filters = {
                inspectionNumber: document.getElementById('filterInspectionNumber').value.toLowerCase(),
                customerId: document.getElementById('filterCustomerId').value.toLowerCase(),
                customerName: document.getElementById('filterCustomerName').value.toLowerCase(),
                area: document.getElementById('filterArea').value,
                serviceType: document.getElementById('filterServiceType').value,
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value,
                approval: document.getElementById('filterApproval').value,
                rating: document.getElementById('filterRating').value
            };
            
            renderCompletedInspections(filters);
        }

        function clearFilters() {
            // Clear all filter values
            document.getElementById('filterInspectionNumber').value = '';
            document.getElementById('filterCustomerId').value = '';
            document.getElementById('filterCustomerName').value = '';
            document.getElementById('filterArea').value = '';
            document.getElementById('filterServiceType').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterApproval').value = '';
            document.getElementById('filterRating').value = '';
            
            // Hide all filter containers
            const allContainers = [
                'filterInspectionNumberContainer',
                'filterCustomerIdContainer', 
                'filterCustomerNameContainer',
                'filterAreaContainer',
                'filterServiceTypeContainer',
                'filterDateFromContainer',
                'filterDateToContainer',
                'filterApprovalContainer',
                'filterRatingContainer'
            ];
            
            allContainers.forEach(containerId => {
                document.getElementById(containerId).classList.add('hidden');
            });
            
            renderCompletedInspections();
        }

        function exportFilteredData() {
            const filters = {
                inspectionNumber: document.getElementById('filterInspectionNumber').value.toLowerCase(),
                customerId: document.getElementById('filterCustomerId').value.toLowerCase(),
                customerName: document.getElementById('filterCustomerName').value.toLowerCase(),
                area: document.getElementById('filterArea').value,
                serviceType: document.getElementById('filterServiceType').value,
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value,
                approval: document.getElementById('filterApproval').value,
                rating: document.getElementById('filterRating').value
            };
            
            let filteredInspections = inspections.filter(inspection => inspection.status === 'مكتمل');
            
            // Apply filters
            if (filters.inspectionNumber) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.inspectionNumber.toLowerCase().includes(filters.inspectionNumber)
                );
            }
            if (filters.customerId) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.customerId.toLowerCase().includes(filters.customerId)
                );
            }
            if (filters.customerName) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.customerName.toLowerCase().includes(filters.customerName)
                );
            }
            if (filters.area) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.area === filters.area
                );
            }
            if (filters.serviceType) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.serviceType === filters.serviceType
                );
            }
            if (filters.dateFrom) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.inspectionDate >= filters.dateFrom
                );
            }
            if (filters.dateTo) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.inspectionDate <= filters.dateTo
                );
            }
            if (filters.approval) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.customerApproval === filters.approval
                );
            }
            if (filters.rating) {
                filteredInspections = filteredInspections.filter(inspection => 
                    inspection.customerRating === filters.rating
                );
            }
            
            // Create CSV content
            const csvContent = "data:text/csv;charset=utf-8," + 
                "رقم المعاينة,رقم العميل,اسم العميل,المنطقة,نوع الخدمة,تاريخ المعاينة,الموافقة,التقييم\n" +
                filteredInspections.map(inspection => 
                    `${inspection.inspectionNumber},${inspection.customerId},${inspection.customerName},${inspection.area},${inspection.serviceType},${inspection.inspectionDate},${inspection.customerApproval},${inspection.customerRating || 'غير محدد'}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "الطلبات_المكتملة.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Edit inspection function
        function editInspectionDetails(inspectionNumber) {
            const inspection = inspections.find(i => i.inspectionNumber === inspectionNumber);
            if (!inspection) return;
            
            currentEditingInspection = inspectionNumber;
            
            // Create edit modal content
            let editHTML = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-6 rounded-lg">
                        <h3 class="text-xl font-bold">تعديل المعاينة: ${inspection.inspectionNumber}</h3>
                    </div>
                    
                    <form id="editInspectionForm" class="space-y-6">
                        <!-- Customer Info -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">بيانات العميل</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">الاسم</label>
                                    <input type="text" id="editCustomerName" value="${inspection.customerName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">رقم الجوال</label>
                                    <input type="tel" id="editCustomerPhone" value="${inspection.customerPhone}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المنطقة</label>
                                    <select id="editArea" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="حولي" ${inspection.area === 'حولي' ? 'selected' : ''}>حولي</option>
                                        <option value="الأحمدي" ${inspection.area === 'الأحمدي' ? 'selected' : ''}>الأحمدي</option>
                                        <option value="الفروانية" ${inspection.area === 'الفروانية' ? 'selected' : ''}>الفروانية</option>
                                        <option value="مبارك الكبير" ${inspection.area === 'مبارك الكبير' ? 'selected' : ''}>مبارك الكبير</option>
                                        <option value="الجهراء" ${inspection.area === 'الجهراء' ? 'selected' : ''}>الجهراء</option>
                                        <option value="العاصمة" ${inspection.area === 'العاصمة' ? 'selected' : ''}>العاصمة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Details -->
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">تفاصيل الخدمة</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع الخدمة</label>
                                    <select id="editServiceType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleEditServiceTypeOther()">
                                        <option value="تنظيف عام" ${inspection.serviceType === 'تنظيف عام' ? 'selected' : ''}>تنظيف عام</option>
                                        <option value="تنظيف عميق" ${inspection.serviceType === 'تنظيف عميق' ? 'selected' : ''}>تنظيف عميق</option>
                                        <option value="تنظيف بعد الدهان" ${inspection.serviceType === 'تنظيف بعد الدهان' ? 'selected' : ''}>تنظيف بعد الدهان</option>
                                        <option value="تنظيف المطبخ" ${inspection.serviceType === 'تنظيف المطبخ' ? 'selected' : ''}>تنظيف المطبخ</option>
                                        <option value="تنظيف الحمامات" ${inspection.serviceType === 'تنظيف الحمامات' ? 'selected' : ''}>تنظيف الحمامات</option>
                                        <option value="تنظيف النوافذ" ${inspection.serviceType === 'تنظيف النوافذ' ? 'selected' : ''}>تنظيف النوافذ</option>
                                        <option value="تنظيف السجاد والموكيت" ${inspection.serviceType === 'تنظيف السجاد والموكيت' ? 'selected' : ''}>تنظيف السجاد والموكيت</option>
                                        <option value="تنظيف الأثاث" ${inspection.serviceType === 'تنظيف الأثاث' ? 'selected' : ''}>تنظيف الأثاث</option>
                                        <option value="أخرى" ${!['تنظيف عام', 'تنظيف عميق', 'تنظيف بعد الدهان', 'تنظيف المطبخ', 'تنظيف الحمامات', 'تنظيف النوافذ', 'تنظيف السجاد والموكيت', 'تنظيف الأثاث'].includes(inspection.serviceType) ? 'selected' : ''}>أخرى</option>
                                    </select>
                                    <div id="editServiceTypeOther" class="mt-2 ${!['تنظيف عام', 'تنظيف عميق', 'تنظيف بعد الدهان', 'تنظيف المطبخ', 'تنظيف الحمامات', 'تنظيف النوافذ', 'تنظيف السجاد والموكيت', 'تنظيف الأثاث'].includes(inspection.serviceType) ? '' : 'hidden'}">
                                        <input type="text" id="editServiceTypeCustom" value="${!['تنظيف عام', 'تنظيف عميق', 'تنظيف بعد الدهان', 'تنظيف المطبخ', 'تنظيف الحمامات', 'تنظيف النوافذ', 'تنظيف السجاد والموكيت', 'تنظيف الأثاث'].includes(inspection.serviceType) ? inspection.serviceType : ''}" placeholder="حدد نوع الخدمة" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نوع السكن</label>
                                    <select id="editHousingType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="toggleEditHousingTypeOther()">
                                        <option value="شقة" ${inspection.housingType === 'شقة' ? 'selected' : ''}>شقة</option>
                                        <option value="فيلا" ${inspection.housingType === 'فيلا' ? 'selected' : ''}>فيلا</option>
                                        <option value="دوبلكس" ${inspection.housingType === 'دوبلكس' ? 'selected' : ''}>دوبلكس</option>
                                        <option value="استوديو" ${inspection.housingType === 'استوديو' ? 'selected' : ''}>استوديو</option>
                                        <option value="بيت شعبي" ${inspection.housingType === 'بيت شعبي' ? 'selected' : ''}>بيت شعبي</option>
                                        <option value="أخرى" ${!['شقة', 'فيلا', 'دوبلكس', 'استوديو', 'بيت شعبي'].includes(inspection.housingType) ? 'selected' : ''}>أخرى</option>
                                    </select>
                                    <div id="editHousingTypeOther" class="mt-2 ${!['شقة', 'فيلا', 'دوبلكس', 'استوديو', 'بيت شعبي'].includes(inspection.housingType) ? '' : 'hidden'}">
                                        <input type="text" id="editHousingTypeCustom" value="${!['شقة', 'فيلا', 'دوبلكس', 'استوديو', 'بيت شعبي'].includes(inspection.housingType) ? inspection.housingType : ''}" placeholder="حدد نوع المكان" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ المعاينة</label>
                                    <input type="date" id="editInspectionDate" value="${inspection.inspectionDate}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">وقت المعاينة</label>
                                    <select id="editInspectionTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="صباحاً (8-12)" ${inspection.inspectionTime === 'صباحاً (8-12)' ? 'selected' : ''}>صباحاً (8-12)</option>
                                        <option value="ظهراً (12-4)" ${inspection.inspectionTime === 'ظهراً (12-4)' ? 'selected' : ''}>ظهراً (12-4)</option>
                                        <option value="مساءً (4-8)" ${inspection.inspectionTime === 'مساءً (4-8)' ? 'selected' : ''}>مساءً (4-8)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-gray-700 font-medium mb-2">ملاحظات الخدمة</label>
                                <textarea id="editServiceNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">${inspection.serviceNotes || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- Customer Approval -->
                        <div class="bg-yellow-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">موافقة العميل</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">هل العميل موافق على الخدمة؟</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="editCustomerApproval" value="موافق" onchange="toggleEditPaymentSection()" class="ml-2" ${inspection.customerApproval === 'موافق' ? 'checked' : ''}>
                                            <span class="text-green-600 font-semibold">موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="editCustomerApproval" value="غير موافق" onchange="toggleEditPaymentSection()" class="ml-2" ${inspection.customerApproval === 'غير موافق' ? 'checked' : ''}>
                                            <span class="text-red-600 font-semibold">غير موافق</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="editCustomerApproval" value="في الانتظار" onchange="toggleEditPaymentSection()" class="ml-2" ${inspection.customerApproval === 'في الانتظار' ? 'checked' : ''}>
                                            <span class="text-blue-600 font-semibold">في الانتظار</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Rejection Section -->
                                <div id="edit-rejection-section" class="${inspection.customerApproval === 'غير موافق' ? '' : 'hidden'}">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">السعر المقترح (دينار كويتي)</label>
                                            <input type="number" id="editProposedPrice" value="${inspection.proposedPrice || ''}" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">سبب عدم الموافقة</label>
                                            <select id="editRejectionReason" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                                <option value="">اختر السبب</option>
                                                <option value="السعر مرتفع" ${inspection.rejectionReason === 'السعر مرتفع' ? 'selected' : ''}>السعر مرتفع</option>
                                                <option value="لا يحتاج الخدمة حالياً" ${inspection.rejectionReason === 'لا يحتاج الخدمة حالياً' ? 'selected' : ''}>لا يحتاج الخدمة حالياً</option>
                                                <option value="وجد خدمة أخرى" ${inspection.rejectionReason === 'وجد خدمة أخرى' ? 'selected' : ''}>وجد خدمة أخرى</option>
                                                <option value="غير راضي عن المعاينة" ${inspection.rejectionReason === 'غير راضي عن المعاينة' ? 'selected' : ''}>غير راضي عن المعاينة</option>
                                                <option value="أسباب أخرى" ${inspection.rejectionReason === 'أسباب أخرى' ? 'selected' : ''}>أسباب أخرى</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Details (shown only if approved) -->
                        <div id="edit-payment-section" class="bg-green-50 p-6 rounded-lg ${inspection.customerApproval === 'موافق' ? '' : 'hidden'}">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">💳</span>
                                معلومات الدفع
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">طريقة الدفع *</label>
                                    <select id="editPaymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="">اختر طريقة الدفع</option>
                                        <option value="كاش" ${inspection.paymentMethod === 'كاش' ? 'selected' : ''}>كاش</option>
                                        <option value="فيزا" ${inspection.paymentMethod === 'فيزا' ? 'selected' : ''}>فيزا</option>
                                        <option value="كي نت" ${inspection.paymentMethod === 'كي نت' ? 'selected' : ''}>كي نت</option>
                                        <option value="ابل باي" ${inspection.paymentMethod === 'ابل باي' ? 'selected' : ''}>ابل باي</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ الكلي (دينار كويتي) *</label>
                                    <input type="number" id="editTotalAmount" value="${inspection.totalAmount || ''}" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateEditDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">نسبة الخصم (%)</label>
                                    <input type="number" id="editDiscountPercentage" value="${inspection.discountPercentage || ''}" min="0" max="100" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onchange="calculateEditDiscount()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">المبلغ بعد الخصم</label>
                                    <input type="number" id="editFinalAmount" value="${inspection.finalAmount || ''}" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">حالة الدفع *</label>
                                    <select id="editPaymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                        <option value="في الانتظار" ${inspection.paymentStatus === 'في الانتظار' ? 'selected' : ''}>في الانتظار</option>
                                        <option value="مدفوع" ${inspection.paymentStatus === 'مدفوع' ? 'selected' : ''}>مدفوع</option>
                                        <option value="مدفوع جزئياً" ${inspection.paymentStatus === 'مدفوع جزئياً' ? 'selected' : ''}>مدفوع جزئياً</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Team Information (shown only if approved) -->
                        <div id="edit-team-section" class="bg-purple-50 p-6 rounded-lg ${inspection.customerApproval === 'موافق' ? '' : 'hidden'}">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">👥</span>
                                معلومات الفريق
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">اسم الفريق</label>
                                    <input type="text" id="editTeamName" value="${inspection.teamName || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">عدد العاملات</label>
                                    <input type="number" id="editWorkersCount" value="${inspection.workersCount || ''}" min="1" max="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">تاريخ تنفيذ الخدمة</label>
                                    <input type="date" id="editServiceDate" value="${inspection.serviceDate || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Satisfaction Rating -->
                        <div class="bg-orange-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">⭐</span>
                                تقييم رضا العميل
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">مدى رضا العميل عن المعاينة (من 1 إلى 5)</label>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span onclick="setEditRating(1)" class="edit-rating-star cursor-pointer text-2xl" data-rating="1">⭐</span>
                                        <span onclick="setEditRating(2)" class="edit-rating-star cursor-pointer text-2xl" data-rating="2">⭐</span>
                                        <span onclick="setEditRating(3)" class="edit-rating-star cursor-pointer text-2xl" data-rating="3">⭐</span>
                                        <span onclick="setEditRating(4)" class="edit-rating-star cursor-pointer text-2xl" data-rating="4">⭐</span>
                                        <span onclick="setEditRating(5)" class="edit-rating-star cursor-pointer text-2xl" data-rating="5">⭐</span>
                                        <span id="edit-rating-text" class="mr-4 font-medium text-gray-700"></span>
                                    </div>
                                    <input type="hidden" id="editCustomerRating" value="${inspection.customerRating || ''}">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظة حول سبب التقييم</label>
                                    <textarea id="editRatingNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="لماذا اختار العميل هذا التقييم؟">${inspection.ratingNotes || ''}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Photos Section -->
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="text-lg ml-2">📸</span>
                                الصور والمقاطع
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Before Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h5 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-red-500 ml-2">📷</span>
                                        صور قبل التنظيف
                                    </h5>
                                    <input type="file" id="editBeforePhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleEditFileUpload('editBefore', this.files)">
                                    <button type="button" onclick="document.getElementById('editBeforePhotos').click()" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع قبل التنظيف
                                    </button>
                                    <div id="editBeforePhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                                
                                <!-- After Cleaning Photos -->
                                <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                                    <h5 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <span class="text-green-500 ml-2">📷</span>
                                        صور بعد التنظيف
                                    </h5>
                                    <input type="file" id="editAfterPhotos" multiple accept="image/*,video/*" class="hidden" onchange="handleEditFileUpload('editAfter', this.files)">
                                    <button type="button" onclick="document.getElementById('editAfterPhotos').click()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                        <span class="ml-2">📁</span>
                                        اختيار صور/مقاطع بعد التنظيف
                                    </button>
                                    <div id="editAfterPhotosPreview" class="mt-3 grid grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inspector Notes -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">ملاحظات إضافية</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ملاحظات المعاين</label>
                                    <textarea id="editInspectorNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="ملاحظات المعاين حول الموقع والخدمة المطلوبة">${inspection.inspectorNotes || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">اسم المعاين</label>
                                    <input type="text" id="editInspectorName" value="${inspection.inspectorName || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="اسم الموظف المختص بالمعاينة">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center gap-4">
                            <button type="submit" class="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                                حفظ التعديلات
                            </button>
                            <button type="button" onclick="closeModal()" class="bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('inspectionDetails').innerHTML = editHTML;
            document.getElementById('inspectionModal').classList.remove('hidden');
            
            // Set initial rating display
            if (inspection.customerRating) {
                setEditRating(parseInt(inspection.customerRating));
            }
            
            // Add form submit handler
            document.getElementById('editInspectionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInspectionEdits();
            });
        }

        function saveInspectionEdits() {
            const inspectionIndex = inspections.findIndex(i => i.inspectionNumber === currentEditingInspection);
            if (inspectionIndex === -1) return;
            
            const approval = document.querySelector('input[name="editCustomerApproval"]:checked').value;
            
            // Get service type (custom or selected)
            const editServiceTypeValue = document.getElementById('editServiceType').value;
            const finalEditServiceType = editServiceTypeValue === 'أخرى' ? document.getElementById('editServiceTypeCustom').value : editServiceTypeValue;
            
            // Get housing type (custom or selected)
            const editHousingTypeValue = document.getElementById('editHousingType').value;
            const finalEditHousingType = editHousingTypeValue === 'أخرى' ? document.getElementById('editHousingTypeCustom').value : editHousingTypeValue;
            
            // Update inspection data
            inspections[inspectionIndex].customerName = document.getElementById('editCustomerName').value;
            inspections[inspectionIndex].customerPhone = document.getElementById('editCustomerPhone').value;
            inspections[inspectionIndex].area = document.getElementById('editArea').value;
            inspections[inspectionIndex].serviceType = finalEditServiceType;
            inspections[inspectionIndex].housingType = finalEditHousingType;
            inspections[inspectionIndex].inspectionDate = document.getElementById('editInspectionDate').value;
            inspections[inspectionIndex].inspectionTime = document.getElementById('editInspectionTime').value;
            inspections[inspectionIndex].serviceNotes = document.getElementById('editServiceNotes').value;
            inspections[inspectionIndex].customerApproval = approval;
            inspections[inspectionIndex].customerRating = document.getElementById('editCustomerRating').value;
            inspections[inspectionIndex].ratingNotes = document.getElementById('editRatingNotes').value;
            inspections[inspectionIndex].inspectorName = document.getElementById('editInspectorName').value;
            inspections[inspectionIndex].inspectorNotes = document.getElementById('editInspectorNotes').value;
            
            // Update approval-specific data
            if (approval === 'موافق') {
                inspections[inspectionIndex].paymentMethod = document.getElementById('editPaymentMethod')?.value || '';
                inspections[inspectionIndex].totalAmount = document.getElementById('editTotalAmount')?.value || '';
                inspections[inspectionIndex].discountPercentage = document.getElementById('editDiscountPercentage')?.value || '';
                inspections[inspectionIndex].finalAmount = document.getElementById('editFinalAmount')?.value || '';
                inspections[inspectionIndex].paymentStatus = document.getElementById('editPaymentStatus')?.value || '';
                inspections[inspectionIndex].teamName = document.getElementById('editTeamName')?.value || '';
                inspections[inspectionIndex].workersCount = document.getElementById('editWorkersCount')?.value || '';
                inspections[inspectionIndex].serviceDate = document.getElementById('editServiceDate')?.value || '';
            } else if (approval === 'غير موافق') {
                inspections[inspectionIndex].proposedPrice = document.getElementById('editProposedPrice')?.value || '';
                inspections[inspectionIndex].rejectionReason = document.getElementById('editRejectionReason')?.value || '';
                inspections[inspectionIndex].status = 'مكتمل';
            }
            
            // Add photos data if available
            if (uploadedFiles.editBefore && uploadedFiles.editBefore.length > 0) {
                inspections[inspectionIndex].beforePhotos = uploadedFiles.editBefore.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                }));
            }
            if (uploadedFiles.editAfter && uploadedFiles.editAfter.length > 0) {
                inspections[inspectionIndex].afterPhotos = uploadedFiles.editAfter.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                }));
            }
            
            // Update customer data
            const customerId = inspections[inspectionIndex].customerId;
            if (customers[customerId]) {
                customers[customerId].name = document.getElementById('editCustomerName').value;
                customers[customerId].phone = document.getElementById('editCustomerPhone').value;
            }
            
            // Save to localStorage
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('inspections', JSON.stringify(inspections));
            
            alert('تم حفظ التعديلات بنجاح!');
            closeModal();
            renderPendingInspections();
            renderCompletedInspections();
        }

        // Helper functions for edit form
        function toggleEditServiceTypeOther() {
            const serviceType = document.getElementById('editServiceType').value;
            const otherSection = document.getElementById('editServiceTypeOther');
            
            if (serviceType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('editServiceTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('editServiceTypeCustom').required = false;
                document.getElementById('editServiceTypeCustom').value = '';
            }
        }

        function toggleEditHousingTypeOther() {
            const housingType = document.getElementById('editHousingType').value;
            const otherSection = document.getElementById('editHousingTypeOther');
            
            if (housingType === 'أخرى') {
                otherSection.classList.remove('hidden');
                document.getElementById('editHousingTypeCustom').required = true;
            } else {
                otherSection.classList.add('hidden');
                document.getElementById('editHousingTypeCustom').required = false;
                document.getElementById('editHousingTypeCustom').value = '';
            }
        }

        function toggleEditPaymentSection() {
            const approval = document.querySelector('input[name="editCustomerApproval"]:checked');
            const paymentSection = document.getElementById('edit-payment-section');
            const teamSection = document.getElementById('edit-team-section');
            const rejectionSection = document.getElementById('edit-rejection-section');
            
            if (approval && approval.value === 'موافق') {
                paymentSection.classList.remove('hidden');
                teamSection.classList.remove('hidden');
                rejectionSection.classList.add('hidden');
            } else if (approval && approval.value === 'غير موافق') {
                paymentSection.classList.add('hidden');
                teamSection.classList.add('hidden');
                rejectionSection.classList.remove('hidden');
            } else {
                // في الانتظار أو لا يوجد اختيار
                paymentSection.classList.add('hidden');
                teamSection.classList.add('hidden');
                rejectionSection.classList.add('hidden');
            }
        }

        function calculateEditDiscount() {
            const totalAmount = parseFloat(document.getElementById('editTotalAmount').value) || 0;
            const discountPercentage = parseFloat(document.getElementById('editDiscountPercentage').value) || 0;
            
            const discountAmount = (totalAmount * discountPercentage) / 100;
            const finalAmount = totalAmount - discountAmount;
            
            document.getElementById('editFinalAmount').value = finalAmount.toFixed(2);
        }

        function setEditRating(rating) {
            document.getElementById('editCustomerRating').value = rating;
            
            // Update star colors
            document.querySelectorAll('.edit-rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#fbbf24';
                } else {
                    star.style.color = '#d1d5db';
                }
            });
            
            // Update rating text
            const ratingTexts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            
            document.getElementById('edit-rating-text').textContent = ratingTexts[rating];
        }

        function handleEditFileUpload(type, files) {
            if (!uploadedFiles[type]) {
                uploadedFiles[type] = [];
            }
            uploadedFiles[type] = Array.from(files);
            displayEditFilePreview(type, files);
        }

        function displayEditFilePreview(type, files) {
            const previewContainer = document.getElementById(type + 'PhotosPreview');
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'relative bg-gray-100 p-2 rounded-lg';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'w-full h-20 object-cover rounded';
                    fileDiv.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'w-full h-20 object-cover rounded';
                    video.controls = true;
                    fileDiv.appendChild(video);
                }
                
                const fileName = document.createElement('p');
                fileName.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                fileName.className = 'text-xs text-gray-600 mt-1 text-center';
                fileDiv.appendChild(fileName);
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600';
                removeBtn.onclick = () => removeEditFile(type, index);
                fileDiv.appendChild(removeBtn);
                
                previewContainer.appendChild(fileDiv);
            });
        }

        function removeEditFile(type, index) {
            uploadedFiles[type].splice(index, 1);
            const input = document.getElementById(type + 'Photos');
            const dt = new DataTransfer();
            uploadedFiles[type].forEach(file => dt.items.add(file));
            input.files = dt.files;
            displayEditFilePreview(type, uploadedFiles[type]);
        }

        function renderPendingInspections() {
            const pendingInspections = inspections.filter(inspection => inspection.status === 'معلق')
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // ترتيب من الأحدث للأقدم
            const tableContainer = document.getElementById('pending-inspections-table');
            
            if (pendingInspections.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-600 text-center py-8">لا توجد معاينات معلقة حالياً</p>';
                return;
            }
            
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-blue-500 to-gray-700 text-white">
                                <th class="border border-gray-300 p-3 text-right text-sm">رقم الطلب</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">رقم العميل</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">اسم العميل</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">المنطقة</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">العنوان الكامل</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">نوع الخدمة</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">التاريخ</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">الموافقة</th>
                                <th class="border border-gray-300 p-3 text-right text-sm">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pendingInspections.forEach(inspection => {
                let approvalColor = 'text-blue-600';
                if (inspection.customerApproval === 'موافق') approvalColor = 'text-green-600';
                else if (inspection.customerApproval === 'غير موافق') approvalColor = 'text-red-600';
                
                // Determine which date to show
                let displayDate = inspection.inspectionDate;
                if (inspection.customerApproval === 'موافق' && inspection.serviceDate) {
                    displayDate = inspection.serviceDate;
                }
                
                // Build full address
                let addressParts = [];
                if (inspection.area) addressParts.push(inspection.area);
                if (inspection.block) addressParts.push(`ق${inspection.block}`);
                if (inspection.avenue) addressParts.push(`ج${inspection.avenue}`);
                if (inspection.street) addressParts.push(`ش${inspection.street}`);
                if (inspection.houseNumber) addressParts.push(`م${inspection.houseNumber}`);
                const fullAddress = addressParts.join(' - ') || 'غير محدد';
                
                tableHTML += `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="border border-gray-300 p-3 font-semibold text-blue-600 text-sm">${inspection.inspectionNumber}</td>
                        <td class="border border-gray-300 p-3 text-sm">${inspection.customerId}</td>
                        <td class="border border-gray-300 p-3 text-sm">${inspection.customerName}</td>
                        <td class="border border-gray-300 p-3 text-sm">${inspection.area}</td>
                        <td class="border border-gray-300 p-3 text-sm" title="${fullAddress}">${fullAddress.length > 30 ? fullAddress.substring(0, 30) + '...' : fullAddress}</td>
                        <td class="border border-gray-300 p-3 text-sm">${inspection.serviceType}</td>
                        <td class="border border-gray-300 p-3 text-sm">${displayDate}</td>
                        <td class="border border-gray-300 p-3 font-semibold ${approvalColor} text-sm">${inspection.customerApproval}</td>
                        <td class="border border-gray-300 p-3">
                            <button onclick="editInspectionDetails('${inspection.inspectionNumber}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 ml-1 transition-colors">
                                تعديل
                            </button>
                            <button onclick="viewInspectionDetails('${inspection.inspectionNumber}')" class="bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700 ml-1 transition-colors">
                                عرض التفاصيل
                            </button>
                            <button onclick="completeInspection('${inspection.inspectionNumber}')" class="bg-gray-800 text-white px-2 py-1 rounded text-xs hover:bg-gray-900 transition-colors">
                                تم انتهاء الطلب
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            tableContainer.innerHTML = tableHTML;
        }

        function renderCompletedInspections(filters = null) {
            let completedInspections = inspections.filter(inspection => inspection.status === 'مكتمل')
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // ترتيب من الأحدث للأقدم
            
            // Apply filters if provided
            if (filters) {
                if (filters.inspectionNumber) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.inspectionNumber.toLowerCase().includes(filters.inspectionNumber)
                    );
                }
                if (filters.customerId) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.customerId.toLowerCase().includes(filters.customerId)
                    );
                }
                if (filters.customerName) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.customerName.toLowerCase().includes(filters.customerName)
                    );
                }
                if (filters.area) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.area === filters.area
                    );
                }
                if (filters.serviceType) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.serviceType === filters.serviceType
                    );
                }
                if (filters.dateFrom) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.inspectionDate >= filters.dateFrom
                    );
                }
                if (filters.dateTo) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.inspectionDate <= filters.dateTo
                    );
                }
                if (filters.approval) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.customerApproval === filters.approval
                    );
                }
                if (filters.rating) {
                    completedInspections = completedInspections.filter(inspection => 
                        inspection.customerRating === filters.rating
                    );
                }
            }
            
            // Store filtered results for pagination
            filteredCompletedInspections = completedInspections;
            
            const tableContainer = document.getElementById('completed-inspections-table');
            const paginationControls = document.getElementById('pagination-controls');
            
            if (completedInspections.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-600 text-center py-8">لا توجد معاينات مكتملة</p>';
                paginationControls.classList.add('hidden');
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(completedInspections.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedInspections = completedInspections.slice(startIndex, endIndex);
            
            // Show/hide pagination controls
            if (totalPages > 1) {
                paginationControls.classList.remove('hidden');
                updatePaginationControls(totalPages);
            } else {
                paginationControls.classList.add('hidden');
            }
            
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gradient-to-r from-green-500 to-teal-600 text-white">
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('inspectionNumber')">رقم المعاينة</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('customerId')">رقم العميل</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('customerName')">اسم العميل</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('area')">المنطقة</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs">العنوان الكامل</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('serviceType')">نوع الخدمة</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('dateFrom')">تاريخ المعاينة</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('approval')">الموافقة</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs">السعر الإجمالي</th>
                                <th class="border border-gray-300 p-2 text-right cursor-pointer hover:bg-green-600 text-xs" onclick="showFilter('rating')">التقييم</th>
                                <th class="border border-gray-300 p-2 text-right text-xs">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            paginatedInspections.forEach(inspection => {
                let approvalColor = 'text-blue-600';
                if (inspection.customerApproval === 'موافق') approvalColor = 'text-green-600';
                else if (inspection.customerApproval === 'غير موافق') approvalColor = 'text-red-600';
                
                const ratingStars = '⭐'.repeat(parseInt(inspection.customerRating) || 0);
                
                // Calculate final price
                let finalPrice = 'غير محدد';
                if (inspection.customerApproval === 'موافق' && inspection.finalAmount) {
                    finalPrice = inspection.finalAmount + ' د.ك';
                } else if (inspection.customerApproval === 'موافق' && inspection.totalAmount) {
                    finalPrice = inspection.totalAmount + ' د.ك';
                } else if (inspection.proposedPrice) {
                    finalPrice = inspection.proposedPrice + ' د.ك';
                }
                
                // Build full address
                let addressParts = [];
                if (inspection.area) addressParts.push(inspection.area);
                if (inspection.block) addressParts.push(`ق${inspection.block}`);
                if (inspection.avenue) addressParts.push(`ج${inspection.avenue}`);
                if (inspection.street) addressParts.push(`ش${inspection.street}`);
                if (inspection.houseNumber) addressParts.push(`م${inspection.houseNumber}`);
                const fullAddress = addressParts.join(' - ') || 'غير محدد';
                
                tableHTML += `
                    <tr class="hover:bg-green-50 transition-colors">
                        <td class="border border-gray-300 p-2 font-semibold text-green-600 text-xs">${inspection.inspectionNumber}</td>
                        <td class="border border-gray-300 p-2 text-xs">${inspection.customerId}</td>
                        <td class="border border-gray-300 p-2 text-xs">${inspection.customerName}</td>
                        <td class="border border-gray-300 p-2 text-xs">${inspection.area}</td>
                        <td class="border border-gray-300 p-2 text-xs" title="${fullAddress}">${fullAddress.length > 25 ? fullAddress.substring(0, 25) + '...' : fullAddress}</td>
                        <td class="border border-gray-300 p-2 text-xs">${inspection.serviceType}</td>
                        <td class="border border-gray-300 p-2 text-xs">${inspection.inspectionDate}</td>
                        <td class="border border-gray-300 p-2 font-semibold ${approvalColor} text-xs">${inspection.customerApproval}</td>
                        <td class="border border-gray-300 p-2 text-xs font-semibold">${finalPrice}</td>
                        <td class="border border-gray-300 p-2 text-xs">${ratingStars} (${inspection.customerRating || 'غير محدد'})</td>
                        <td class="border border-gray-300 p-2">
                            <button onclick="viewInspectionDetails('${inspection.inspectionNumber}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                عرض التفاصيل
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            tableContainer.innerHTML = tableHTML;
        }
        
        function updatePaginationControls(totalPages) {
            document.getElementById('pageInfo').textContent = `صفحة ${currentPage} من ${totalPages}`;
            
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                prevBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                prevBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                prevBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                nextBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                nextBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                nextBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(filteredCompletedInspections.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCompletedInspections();
            }
        }

        function viewInspectionDetails(inspectionNumber) {
            const inspection = inspections.find(i => i.inspectionNumber === inspectionNumber);
            if (!inspection) return;
            
            const ratingStars = '⭐'.repeat(parseInt(inspection.customerRating) || 0);
            const ratingTexts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            
            let detailsHTML = `
                <div class="space-y-6">
                    <!-- Inspection Header -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong>رقم المعاينة:</strong> ${inspection.inspectionNumber}</div>
                            <div><strong>رقم العميل:</strong> ${inspection.customerId}</div>
                            <div><strong>الحالة:</strong> 
                                <span class="px-2 py-1 rounded-full text-xs ${inspection.status === 'مكتمل' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${inspection.status}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Info -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">بيانات العميل</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong>الاسم:</strong> ${inspection.customerName}</div>
                            <div><strong>رقم الجوال:</strong> ${inspection.customerPhone}</div>
                            <div><strong>المنطقة:</strong> ${inspection.area}</div>
                        </div>
                        <div class="mt-4">
                            <strong>العنوان الكامل:</strong> 
                            <div class="bg-white p-3 rounded-lg border mt-2">
                                ${(() => {
                                    let addressParts = [];
                                    if (inspection.area) addressParts.push(`المنطقة: ${inspection.area}`);
                                    if (inspection.block) addressParts.push(`القطعة: ${inspection.block}`);
                                    if (inspection.avenue) addressParts.push(`الجادة: ${inspection.avenue}`);
                                    if (inspection.street) addressParts.push(`الشارع: ${inspection.street}`);
                                    if (inspection.houseNumber) addressParts.push(`رقم المنزل: ${inspection.houseNumber}`);
                                    if (inspection.location) addressParts.push(`الموقع: ${inspection.location}`);
                                    return addressParts.join(' - ') || 'غير محدد';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Details -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">تفاصيل الخدمة</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><strong>نوع الخدمة:</strong> ${inspection.serviceType}</div>
                            <div><strong>نوع السكن:</strong> ${inspection.housingType}</div>
                            <div><strong>تاريخ المعاينة:</strong> ${inspection.inspectionDate}</div>
                            <div><strong>وقت المعاينة:</strong> ${inspection.inspectionTime}</div>
                        </div>
                        ${inspection.serviceNotes ? `<div class="mt-4"><strong>ملاحظات الخدمة:</strong> ${inspection.serviceNotes}</div>` : ''}
                    </div>
                    
                    <!-- Customer Approval -->
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">موافقة العميل</h3>
                        <div class="mb-4">
                            <strong>الموافقة:</strong> 
                            <span class="font-semibold ${inspection.customerApproval === 'موافق' ? 'text-green-600' : 'text-red-600'}">
                                ${inspection.customerApproval}
                            </span>
                        </div>
            `;
            
            if (inspection.customerApproval === 'موافق') {
                detailsHTML += `
                    <!-- Payment Info -->
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">معلومات الدفع</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong>طريقة الدفع:</strong> ${inspection.paymentMethod || 'غير محدد'}</div>
                            <div><strong>المبلغ الكلي:</strong> ${inspection.totalAmount || 'غير محدد'} دينار كويتي</div>
                            <div><strong>حالة الدفع:</strong> ${inspection.paymentStatus || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    <!-- Team Info -->
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">معلومات الفريق</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong>اسم الفريق:</strong> ${inspection.teamName || 'غير محدد'}</div>
                            <div><strong>عدد العاملات:</strong> ${inspection.workersCount || 'غير محدد'}</div>
                            <div><strong>تاريخ تنفيذ الخدمة:</strong> ${inspection.serviceDate || 'غير محدد'}</div>
                        </div>
                    </div>
                `;
            } else {
                detailsHTML += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><strong>السعر المقترح:</strong> ${inspection.proposedPrice || 'غير محدد'} دينار كويتي</div>
                        <div><strong>سبب عدم الموافقة:</strong> ${inspection.rejectionReason || 'غير محدد'}</div>
                    </div>
                `;
            }
            
            detailsHTML += `
                    </div>
                    
                    <!-- Customer Rating -->
                    <div class="bg-orange-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">تقييم العميل</h3>
                        <div class="space-y-4">
                            <div><strong>التقييم:</strong> ${ratingStars} (${inspection.customerRating || 'غير محدد'}/5) - ${ratingTexts[inspection.customerRating] || 'غير محدد'}</div>
                            ${inspection.ratingNotes ? `<div><strong>ملاحظة التقييم:</strong> ${inspection.ratingNotes}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Inspector Notes -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ملاحظات المعاين</h3>
                        <div class="space-y-4">
                            <div><strong>اسم المعاين:</strong> ${inspection.inspectorName || 'غير محدد'}</div>
                            ${inspection.inspectorNotes ? `<div><strong>ملاحظات المعاين:</strong> ${inspection.inspectorNotes}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Photos and Videos -->
                    <div class="bg-indigo-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">الصور والمقاطع</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center">
                                <h4 class="font-semibold text-gray-700 mb-3">صور قبل التنظيف</h4>
                                ${inspection.beforePhotos && inspection.beforePhotos.length > 0 ? 
                                    `<button onclick="showPhotos('before', '${inspection.inspectionNumber}')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                        عرض قبل التنظيف (${inspection.beforePhotos.length})
                                    </button>` : 
                                    '<p class="text-gray-500">لا يوجد أي مقطع للخدمة</p>'
                                }
                            </div>
                            <div class="text-center">
                                <h4 class="font-semibold text-gray-700 mb-3">صور بعد التنظيف</h4>
                                ${inspection.afterPhotos && inspection.afterPhotos.length > 0 ? 
                                    `<button onclick="showPhotos('after', '${inspection.inspectionNumber}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                        عرض بعد التنظيف (${inspection.afterPhotos.length})
                                    </button>` : 
                                    '<p class="text-gray-500">لا يوجد أي مقطع للخدمة</p>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    ${inspection.status === 'مكتمل' ? `
                    <!-- Move to Pending Button (Only for completed inspections) -->
                    <div class="bg-yellow-50 p-6 rounded-lg text-center">
                        <button onclick="moveToPending('${inspection.inspectionNumber}')" class="bg-orange-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                            وضع حالة الطلب في الطلبات المعلقة لتعديله
                        </button>
                    </div>` : ''}
                </div>
            `;
            
            document.getElementById('inspectionDetails').innerHTML = detailsHTML;
            document.getElementById('inspectionModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('inspectionModal').classList.add('hidden');
        }



        function completeInspection(inspectionNumber) {
            if (confirm('هل أنت متأكد من إكمال هذه المعاينة؟')) {
                const inspectionIndex = inspections.findIndex(inspection => inspection.inspectionNumber === inspectionNumber);
                if (inspectionIndex !== -1) {
                    inspections[inspectionIndex].status = 'مكتمل';
                    inspections[inspectionIndex].completedAt = new Date().toISOString();
                    localStorage.setItem('inspections', JSON.stringify(inspections));
                    renderPendingInspections();
                    renderCompletedInspections();
                    alert('تم إكمال المعاينة بنجاح!');
                }
            }
        }



        // Show photos function
        function showPhotos(type, inspectionNumber) {
            alert(`عذراً، عرض الصور والمقاطع غير متاح حالياً في هذا النموذج التجريبي.\nسيتم إضافة هذه الميزة في النسخة الكاملة.`);
        }

        // Move inspection to pending
        function moveToPending(inspectionNumber) {
            if (confirm('هل أنت متأكد من نقل هذا الطلب إلى الطلبات المعلقة؟\nسيتمكن من تعديله مرة أخرى.')) {
                const inspectionIndex = inspections.findIndex(inspection => inspection.inspectionNumber === inspectionNumber);
                if (inspectionIndex !== -1) {
                    inspections[inspectionIndex].status = 'معلق';
                    localStorage.setItem('inspections', JSON.stringify(inspections));
                    renderPendingInspections();
                    renderCompletedInspections();
                    closeModal();
                    alert('تم نقل الطلب إلى الطلبات المعلقة بنجاح!\nيمكنك الآن تعديله من تبويب الطلبات المعلقة.');
                }
            }
        }

        // Address review functions
        function updateAddressReview() {
            const area = document.getElementById('customerArea').value;
            const block = document.getElementById('customerBlock').value;
            const avenue = document.getElementById('customerAvenue').value;
            const street = document.getElementById('customerStreet').value;
            const houseNumber = document.getElementById('customerHouseNumber').value;
            
            if (area || block || avenue || street || houseNumber) {
                let addressParts = [];
                
                if (area) addressParts.push(`المنطقة: ${area}`);
                if (block) addressParts.push(`القطعة: ${block}`);
                if (avenue) addressParts.push(`الجادة: ${avenue}`);
                if (street) addressParts.push(`الشارع: ${street}`);
                if (houseNumber) addressParts.push(`رقم المنزل: ${houseNumber}`);
                
                const fullAddress = addressParts.join(' - ');
                document.getElementById('fullAddress').textContent = fullAddress;
                document.getElementById('addressReview').classList.remove('hidden');
            } else {
                document.getElementById('addressReview').classList.add('hidden');
            }
        }

        function updateExistingAddressReview() {
            const area = document.getElementById('newArea').value;
            const block = document.getElementById('existingCustomerBlock').value;
            const avenue = document.getElementById('existingCustomerAvenue').value;
            const street = document.getElementById('existingCustomerStreet').value;
            const houseNumber = document.getElementById('existingCustomerHouseNumber').value;
            
            if (area || block || avenue || street || houseNumber) {
                let addressParts = [];
                
                if (area) addressParts.push(`المنطقة: ${area}`);
                if (block) addressParts.push(`القطعة: ${block}`);
                if (avenue) addressParts.push(`الجادة: ${avenue}`);
                if (street) addressParts.push(`الشارع: ${street}`);
                if (houseNumber) addressParts.push(`رقم المنزل: ${houseNumber}`);
                
                const fullAddress = addressParts.join(' - ');
                document.getElementById('existingFullAddress').textContent = fullAddress;
                document.getElementById('existingAddressReview').classList.remove('hidden');
            } else {
                document.getElementById('existingAddressReview').classList.add('hidden');
            }
        }

        // Close modal when clicking outside
        document.getElementById('inspectionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989ed8e38320c68b',t:'MTc1OTY4NzUyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
