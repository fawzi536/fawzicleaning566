<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wajha Orders - نظام إدارة طلبات المعاينة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .gradient-orange-red {
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
        }
        
        .gradient-green-blue {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        }
        
        .star-rating {
            display: inline-flex;
            direction: ltr;
        }
        
        .star {
            font-size: 24px;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star.active {
            color: #fbbf24;
        }
        
        .star:hover {
            color: #fbbf24;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.warning {
            background-color: #f59e0b;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .approval-approved {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .approval-rejected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .approval-waiting {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- الهيدر الرئيسي -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- العنوان والشعار -->
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-3xl">🏡</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Wajha Orders</h1>
                        <div class="flex items-center space-x-2 space-x-reverse mt-1">
                            <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-semibold">الإصدار 16</span>
                        </div>
                    </div>
                </div>
                
                <!-- الأزرار الوظيفية -->
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="openGoogleSheets()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <span>📊</span>
                        <span>فتح Google Sheets</span>
                    </button>
                    
                    <button onclick="loadFromGoogleSheets()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                        <span>📥</span>
                        <span>قراءة البيانات</span>
                    </button>
                    
                    <button id="exportBtn" onclick="exportData()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse hidden">
                        <span>📤</span>
                        <span>تصدير كـ CSV</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- التبويبات الرئيسية -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6">
            <div class="flex space-x-0 space-x-reverse">
                <button onclick="showTab('new-order')" class="tab-button active px-8 py-4 font-semibold rounded-t-lg">
                    طلب معاينة جديد
                </button>
                <button onclick="showTab('pending-orders')" class="tab-button px-8 py-4 font-semibold rounded-t-lg text-gray-600 hover:text-blue-600">
                    الطلبات المعلقة
                </button>
                <button onclick="showTab('completed-orders')" class="tab-button px-8 py-4 font-semibold rounded-t-lg text-gray-600 hover:text-blue-600">
                    الطلبات المكتملة
                </button>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <main class="container mx-auto px-6 py-8">
        <!-- تبويب طلب معاينة جديد -->
        <div id="new-order" class="tab-content active">
            <!-- قسم البحث عن العميل -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">البحث عن العميل</h2>
                
                <div class="flex items-center space-x-4 space-x-reverse mb-4">
                    <input type="text" id="customerSearch" placeholder="ابحث برقم العميل أو اسم العميل..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="searchCustomer()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        بحث
                    </button>
                </div>
                
                <div id="createNewOrderBtn" class="hidden mb-4">
                    <button onclick="showNewCustomerForm()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        إنشاء طلب معاينة جديد
                    </button>
                </div>
                
                <p class="text-gray-600 text-sm">💡 نصيحة: يمكنك البحث برقم العميل أو اسم العميل</p>
            </div>

            <!-- قسم تاريخ العميل -->
            <div id="customerHistory" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-4">تاريخ العميل</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">رقم المعاينة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">المنطقة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">نوع الخدمة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">تاريخ المعاينة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الموافقة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="customerHistoryBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- نموذج العميل الجديد -->
            <div id="newCustomerForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">إنشاء طلب معاينة جديد</h3>
                
                <form id="inspectionForm">
                    <!-- معلومات العميل الأساسية -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">معلومات العميل الأساسية</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">رقم العميل</label>
                                <input type="text" id="customerId" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">الاسم <span class="text-red-500">*</span></label>
                                <input type="text" id="customerName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">رقم الجوال <span class="text-red-500">*</span></label>
                                <input type="tel" id="customerPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- معلومات العنوان -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">معلومات العنوان</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">المنطقة <span class="text-red-500">*</span></label>
                                <select id="customerArea" required onchange="updateAddressPreview()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر المنطقة</option>
                                    <option value="الكويت">الكويت</option>
                                    <option value="حولي">حولي</option>
                                    <option value="الفروانية">الفروانية</option>
                                    <option value="مبارك الكبير">مبارك الكبير</option>
                                    <option value="الأحمدي">الأحمدي</option>
                                    <option value="الجهراء">الجهراء</option>
                                    <option value="السالمية">السالمية</option>
                                    <option value="الجابرية">الجابرية</option>
                                    <option value="بيان">بيان</option>
                                    <option value="مشرف">مشرف</option>
                                    <option value="الرميثية">الرميثية</option>
                                    <option value="الشعب">الشعب</option>
                                    <option value="الدعية">الدعية</option>
                                    <option value="الدسمة">الدسمة</option>
                                    <option value="الشرق">الشرق</option>
                                    <option value="المرقاب">المرقاب</option>
                                    <option value="الصوابر">الصوابر</option>
                                    <option value="الفيحاء">الفيحاء</option>
                                    <option value="العديلية">العديلية</option>
                                    <option value="قرطبة">قرطبة</option>
                                    <option value="اليرموك">اليرموك</option>
                                    <option value="الخالدية">الخالدية</option>
                                    <option value="النزهة">النزهة</option>
                                    <option value="الروضة">الروضة</option>
                                    <option value="العدان">العدان</option>
                                    <option value="المهبولة">المهبولة</option>
                                    <option value="الفنطاس">الفنطاس</option>
                                    <option value="أبو حليفة">أبو حليفة</option>
                                    <option value="الفحيحيل">الفحيحيل</option>
                                    <option value="المنقف">المنقف</option>
                                    <option value="الأحمدي">الأحمدي</option>
                                    <option value="الرقة">الرقة</option>
                                    <option value="الصباحية">الصباحية</option>
                                    <option value="الخيران">الخيران</option>
                                    <option value="الوفرة">الوفرة</option>
                                    <option value="الزور">الزور</option>
                                    <option value="كبد">كبد</option>
                                    <option value="الجليب">الجليب</option>
                                    <option value="الري">الري</option>
                                    <option value="الضجيج">الضجيج</option>
                                    <option value="الرابية">الرابية</option>
                                    <option value="إشبيلية">إشبيلية</option>
                                    <option value="الأندلس">الأندلس</option>
                                    <option value="الفردوس">الفردوس</option>
                                    <option value="جليب الشيوخ">جليب الشيوخ</option>
                                    <option value="الرحاب">الرحاب</option>
                                    <option value="العارضية">العارضية</option>
                                    <option value="الضاحية">الضاحية</option>
                                    <option value="الشدادية">الشدادية</option>
                                    <option value="الصليبية">الصليبية</option>
                                    <option value="النعيم">النعيم</option>
                                    <option value="الواحة">الواحة</option>
                                    <option value="تيماء">تيماء</option>
                                    <option value="الصليبيخات">الصليبيخات</option>
                                    <option value="الدوحة">الدوحة</option>
                                    <option value="القيروان">القيروان</option>
                                    <option value="القادسية">القادسية</option>
                                    <option value="السرة">السرة</option>
                                    <option value="الزهراء">الزهراء</option>
                                    <option value="الشامية">الشامية</option>
                                    <option value="الشويخ">الشويخ</option>
                                    <option value="الصالحية">الصالحية</option>
                                    <option value="غرناطة">غرناطة</option>
                                    <option value="الفيصلية">الفيصلية</option>
                                    <option value="النهضة">النهضة</option>
                                    <option value="الوطية">الوطية</option>
                                    <option value="العمرية">العمرية</option>
                                    <option value="الجابرية">الجابرية</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">القطعة</label>
                                <input type="text" id="customerBlock" onchange="updateAddressPreview()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">الجادة</label>
                                <input type="text" id="customerAvenue" onchange="updateAddressPreview()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">الشارع</label>
                                <input type="text" id="customerStreet" onchange="updateAddressPreview()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">رقم المنزل</label>
                                <input type="text" id="customerHouseNumber" onchange="updateAddressPreview()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- مراجعة العنوان -->
                        <div id="addressPreview" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                            <h5 class="font-semibold text-blue-800 mb-2">مراجعة العنوان:</h5>
                            <p id="fullAddress" class="text-blue-700"></p>
                        </div>
                    </div>

                    <!-- تفاصيل الخدمة المطلوبة -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">تفاصيل الخدمة المطلوبة</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">نوع الخدمة <span class="text-red-500">*</span></label>
                                <select id="serviceType" required onchange="toggleOtherService()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر نوع الخدمة</option>
                                    <option value="تنظيف عام">تنظيف عام</option>
                                    <option value="تنظيف عميق">تنظيف عميق</option>
                                    <option value="تنظيف بعد الدهان">تنظيف بعد الدهان</option>
                                    <option value="تنظيف المطبخ">تنظيف المطبخ</option>
                                    <option value="تنظيف الحمامات">تنظيف الحمامات</option>
                                    <option value="تنظيف النوافذ">تنظيف النوافذ</option>
                                    <option value="تنظيف السجاد والموكيت">تنظيف السجاد والموكيت</option>
                                    <option value="تنظيف الأثاث">تنظيف الأثاث</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div id="otherServiceDiv" class="hidden">
                                <label class="block text-gray-700 text-sm font-bold mb-2">تحديد نوع الخدمة الأخرى</label>
                                <input type="text" id="otherService" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">نوع السكن <span class="text-red-500">*</span></label>
                                <select id="propertyType" required onchange="toggleOtherProperty()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر نوع السكن</option>
                                    <option value="شقة">شقة</option>
                                    <option value="فيلا">فيلا</option>
                                    <option value="دوبلكس">دوبلكس</option>
                                    <option value="استوديو">استوديو</option>
                                    <option value="بيت شعبي">بيت شعبي</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div id="otherPropertyDiv" class="hidden">
                                <label class="block text-gray-700 text-sm font-bold mb-2">تحديد نوع السكن الآخر</label>
                                <input type="text" id="otherProperty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">تاريخ المعاينة المفضل <span class="text-red-500">*</span></label>
                                <input type="date" id="inspectionDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">وقت المعاينة المفضل</label>
                                <select id="inspectionTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="صباحاً (8-12)">صباحاً (8-12)</option>
                                    <option value="ظهراً (12-4)">ظهراً (12-4)</option>
                                    <option value="مساءً (4-8)">مساءً (4-8)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">ملاحظات إضافية</label>
                            <textarea id="additionalNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- موافقة العميل على الخدمة -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">موافقة العميل على الخدمة</h4>
                        <div class="flex space-x-6 space-x-reverse">
                            <label class="flex items-center">
                                <input type="radio" name="approval" value="موافق" onchange="toggleApprovalSections()" class="ml-2">
                                <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm">موافق</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="approval" value="غير موافق" onchange="toggleApprovalSections()" class="ml-2">
                                <span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm">غير موافق</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="approval" value="في الانتظار" checked onchange="toggleApprovalSections()" class="ml-2">
                                <span class="px-3 py-1 bg-blue-500 text-white rounded-full text-sm">في الانتظار</span>
                            </label>
                        </div>
                    </div>

                    <!-- أسباب الإلغاء -->
                    <div id="rejectionReasons" class="mb-8 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">أسباب الإلغاء</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">سبب الإلغاء</label>
                                <select id="rejectionReason" onchange="toggleOtherRejectionReason()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر سبب الإلغاء</option>
                                    <option value="السعر مرتفع">السعر مرتفع</option>
                                    <option value="تغيير في الخطط">تغيير في الخطط</option>
                                    <option value="وجد خدمة أخرى">وجد خدمة أخرى</option>
                                    <option value="عدم توفر الوقت">عدم توفر الوقت</option>
                                    <option value="عدم الحاجة للخدمة">عدم الحاجة للخدمة</option>
                                    <option value="مشكلة في التواصل">مشكلة في التواصل</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div id="otherRejectionDiv" class="hidden">
                                <label class="block text-gray-700 text-sm font-bold mb-2">تحديد السبب الآخر</label>
                                <input type="text" id="otherRejectionReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">تفاصيل إضافية حول سبب الإلغاء</label>
                            <textarea id="rejectionDetails" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="اكتب تفاصيل إضافية حول سبب الإلغاء..."></textarea>
                        </div>
                    </div>

                    <!-- معلومات الدفع -->
                    <div id="paymentInfo" class="mb-8 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">معلومات الدفع</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ الكلي (د.ك)</label>
                                <input type="number" id="totalAmount" step="0.001" onchange="calculateDiscount()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">نسبة الخصم (%)</label>
                                <input type="number" id="discountPercent" step="0.1" onchange="calculateDiscount()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ بعد الخصم (د.ك)</label>
                                <input type="number" id="finalAmount" step="0.001" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">تاريخ تنفيذ الخدمة</label>
                                <input type="date" id="serviceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">حالة الدفع</label>
                            <select id="paymentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="في الانتظار">في الانتظار</option>
                                <option value="مدفوع">مدفوع</option>
                                <option value="مدفوع جزئياً">مدفوع جزئياً</option>
                            </select>
                        </div>
                    </div>

                    <!-- تقييم رضا العميل -->
                    <div id="customerRating" class="mb-8 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">تقييم رضا العميل</h4>
                        <div class="mb-4">
                            <div class="star-rating" id="starRating">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <p id="ratingText" class="text-gray-600 mt-2">اختر التقييم</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ملاحظة حول سبب التقييم</label>
                            <textarea id="ratingNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- ملاحظات إضافية -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">ملاحظات إضافية</h4>
                        <textarea id="inspectorNotes" rows="3" placeholder="ملاحظات إضافية من المفتش..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- أزرار الحفظ -->
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button type="button" onclick="resetForm()" class="px-6 py-3 text-gray-600 hover:text-gray-800 transition-colors">
                            إعادة تعيين
                        </button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg transition-all duration-300 flex items-center space-x-2 space-x-reverse">
                            <span>حفظ الطلب</span>
                            <div id="saveSpinner" class="loading-spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>

            <!-- نموذج العميل الموجود -->
            <div id="existingCustomerForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">إضافة طلب معاينة لعميل موجود</h3>
                
                <!-- معلومات العميل الموجود -->
                <div id="existingCustomerInfo" class="mb-6 p-4 bg-gray-100 rounded-lg">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                
                <!-- باقي النموذج مطابق للعميل الجديد (بدون معلومات العميل الأساسية) -->
                <!-- يمكن نسخ الأقسام من النموذج السابق -->
            </div>
        </div>

        <!-- تبويب الطلبات المعلقة -->
        <div id="pending-orders" class="tab-content">
            <div class="gradient-orange-red rounded-xl shadow-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-6">الطلبات المعلقة</h2>
                
                <div class="bg-white bg-opacity-10 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-black bg-opacity-20">
                                <tr>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">رقم المعاينة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">اسم العميل</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">المنطقة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">نوع الخدمة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">تاريخ المعاينة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">الموافقة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="pendingOrdersBody" class="divide-y divide-white divide-opacity-20">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- تبويب الطلبات المكتملة -->
        <div id="completed-orders" class="tab-content">
            <div class="gradient-green-blue rounded-xl shadow-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-6">الطلبات المكتملة</h2>
                
                <div class="bg-white bg-opacity-10 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-black bg-opacity-20">
                                <tr>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">رقم المعاينة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">اسم العميل</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">المنطقة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">نوع الخدمة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">تاريخ المعاينة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">الموافقة</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">التقييم</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-white uppercase">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="completedOrdersBody" class="divide-y divide-white divide-opacity-20">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- النافذة المنبثقة لتفاصيل المعاينة -->
    <div id="inspectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto bounce-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">تفاصيل المعاينة</h3>
                <button onclick="closeInspectionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            
            <div id="inspectionDetails">
                <!-- سيتم ملء المحتوى ديناميكياً -->
            </div>
        </div>
    </div>

    <!-- النافذة المنبثقة لتعديل المعاينة -->
    <div id="editInspectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto bounce-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">تعديل المعاينة</h3>
                <button onclick="closeEditInspectionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            
            <form id="editInspectionForm">
                <div id="editInspectionContent">
                    <!-- سيتم ملء المحتوى ديناميكياً -->
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse mt-6">
                    <button type="button" onclick="closeEditInspectionModal()" class="px-6 py-3 text-gray-600 hover:text-gray-800 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg transition-all duration-300">
                        حفظ التعديلات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // متغيرات النظام
        let customers = {};
        let inspections = [];
        let inspectionCounter = 1000;
        let currentRating = 0;
        let isExistingCustomer = false;
        let currentCustomerId = null;

        // Google Sheets Configuration
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI/edit';
        const GOOGLE_SHEETS_ID = '14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI';

        // تهيئة النظام
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            generateCustomerId();
            setupEventListeners();
            setMinDate();
            updateTables();
            
            showNotification('مرحباً بك في نظام Wajha Orders! 🏡', 'success');
        });

        // تحميل البيانات المحلية
        function loadLocalData() {
            const savedCustomers = localStorage.getItem('customers');
            const savedInspections = localStorage.getItem('inspections');
            const savedCounter = localStorage.getItem('inspectionCounter');
            
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            }
            
            if (savedInspections) {
                inspections = JSON.parse(savedInspections);
            }
            
            if (savedCounter) {
                inspectionCounter = parseInt(savedCounter);
            }
        }

        // حفظ البيانات محلياً
        function saveLocalData() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('inspections', JSON.stringify(inspections));
            localStorage.setItem('inspectionCounter', inspectionCounter.toString());
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // نظام التقييم بالنجوم
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    setRating(rating);
                });
                
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                highlightStars(currentRating);
            });

            // نموذج الإرسال
            document.getElementById('inspectionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInspection();
            });

            // البحث عن العميل
            document.getElementById('customerSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomer();
                }
            });

            // اختصار Ctrl+Q لإظهار/إخفاء زر التصدير
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'q') {
                    e.preventDefault();
                    const exportBtn = document.getElementById('exportBtn');
                    exportBtn.classList.toggle('hidden');
                    if (!exportBtn.classList.contains('hidden')) {
                        showNotification('تم إظهار زر التصدير! 📤', 'success');
                    }
                }
            });
        }

        // تعيين الحد الأدنى للتاريخ (اليوم)
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').min = today;
            if (document.getElementById('serviceDate')) {
                document.getElementById('serviceDate').min = today;
            }
        }

        // إظهار التبويب
        function showTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-600', 'hover:text-blue-600');
            });
            
            // إظهار التبويب المحدد
            document.getElementById(tabName).classList.add('active');
            
            // تفعيل الزر المحدد
            event.target.classList.add('active');
            event.target.classList.remove('text-gray-600', 'hover:text-blue-600');
            
            // تحديث الجداول حسب التبويب
            if (tabName === 'pending-orders') {
                updatePendingOrdersTable();
            } else if (tabName === 'completed-orders') {
                updateCompletedOrdersTable();
            }
        }

        // البحث عن العميل
        function searchCustomer() {
            const searchTerm = document.getElementById('customerSearch').value.trim();
            
            if (!searchTerm) {
                showNotification('يرجى إدخال رقم العميل أو اسم العميل للبحث', 'warning');
                return;
            }
            
            // البحث في العملاء الموجودين
            const foundCustomer = Object.values(customers).find(customer => 
                customer.id.includes(searchTerm) || 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (foundCustomer) {
                // عميل موجود
                showExistingCustomerHistory(foundCustomer);
                document.getElementById('createNewOrderBtn').classList.remove('hidden');
                isExistingCustomer = true;
                currentCustomerId = foundCustomer.id;
            } else {
                // عميل جديد
                document.getElementById('customerHistory').classList.add('hidden');
                document.getElementById('createNewOrderBtn').classList.remove('hidden');
                isExistingCustomer = false;
                currentCustomerId = null;
                
                // ملء حقل البحث في النموذج إذا كان اسماً
                if (isNaN(searchTerm)) {
                    document.getElementById('customerName').value = searchTerm;
                }
            }
        }

        // إظهار تاريخ العميل الموجود
        function showExistingCustomerHistory(customer) {
            const customerInspections = inspections.filter(inspection => 
                inspection.customerId === customer.id
            );
            
            const historyBody = document.getElementById('customerHistoryBody');
            historyBody.innerHTML = '';
            
            customerInspections.forEach(inspection => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const approvalClass = getApprovalClass(inspection.approval);
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-orange-600">${inspection.id}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${inspection.area}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${inspection.serviceType}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatDate(inspection.inspectionDate)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${approvalClass}">${inspection.approval}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${inspection.status}</td>
                    <td class="px-6 py-4">
                        <button onclick="showInspectionDetails('${inspection.id}')" class="text-blue-600 hover:text-blue-900 text-sm">عرض التفاصيل</button>
                    </td>
                `;
                
                historyBody.appendChild(row);
            });
            
            document.getElementById('customerHistory').classList.remove('hidden');
        }

        // إظهار نموذج العميل الجديد
        function showNewCustomerForm() {
            if (isExistingCustomer && currentCustomerId) {
                showExistingCustomerForm();
            } else {
                document.getElementById('newCustomerForm').classList.remove('hidden');
                generateCustomerId();
            }
        }

        // إظهار نموذج العميل الموجود
        function showExistingCustomerForm() {
            const customer = customers[currentCustomerId];
            
            // ملء معلومات العميل الموجود
            const customerInfo = document.getElementById('existingCustomerInfo');
            customerInfo.innerHTML = `
                <h4 class="font-semibold text-gray-800 mb-2">معلومات العميل</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <span class="text-sm text-gray-600">رقم العميل:</span>
                        <p class="font-medium">${customer.id}</p>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">الاسم:</span>
                        <p class="font-medium">${customer.name}</p>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">الجوال:</span>
                        <p class="font-medium">${customer.phone}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('existingCustomerForm').classList.remove('hidden');
        }

        // توليد رقم عميل جديد
        function generateCustomerId() {
            const customerId = 'CUST-' + Date.now();
            document.getElementById('customerId').value = customerId;
        }

        // تحديث معاينة العنوان
        function updateAddressPreview() {
            const area = document.getElementById('customerArea').value;
            const block = document.getElementById('customerBlock').value;
            const avenue = document.getElementById('customerAvenue').value;
            const street = document.getElementById('customerStreet').value;
            const houseNumber = document.getElementById('customerHouseNumber').value;
            
            if (area) {
                let address = area;
                if (block) address += ` - قطعة ${block}`;
                if (avenue) address += ` - جادة ${avenue}`;
                if (street) address += ` - شارع ${street}`;
                if (houseNumber) address += ` - منزل ${houseNumber}`;
                
                document.getElementById('fullAddress').textContent = address;
                document.getElementById('addressPreview').classList.remove('hidden');
            } else {
                document.getElementById('addressPreview').classList.add('hidden');
            }
        }

        // تبديل حقل الخدمة الأخرى
        function toggleOtherService() {
            const serviceType = document.getElementById('serviceType').value;
            const otherDiv = document.getElementById('otherServiceDiv');
            
            if (serviceType === 'أخرى') {
                otherDiv.classList.remove('hidden');
                document.getElementById('otherService').required = true;
            } else {
                otherDiv.classList.add('hidden');
                document.getElementById('otherService').required = false;
            }
        }

        // تبديل حقل نوع السكن الآخر
        function toggleOtherProperty() {
            const propertyType = document.getElementById('propertyType').value;
            const otherDiv = document.getElementById('otherPropertyDiv');
            
            if (propertyType === 'أخرى') {
                otherDiv.classList.remove('hidden');
                document.getElementById('otherProperty').required = true;
            } else {
                otherDiv.classList.add('hidden');
                document.getElementById('otherProperty').required = false;
            }
        }

        // تبديل الأقسام حسب الموافقة
        function toggleApprovalSections() {
            const approval = document.querySelector('input[name="approval"]:checked').value;
            const paymentInfo = document.getElementById('paymentInfo');
            const rejectionReasons = document.getElementById('rejectionReasons');
            const customerRating = document.getElementById('customerRating');
            
            // إخفاء جميع الأقسام أولاً
            paymentInfo.classList.add('hidden');
            rejectionReasons.classList.add('hidden');
            customerRating.classList.add('hidden');
            
            if (approval === 'موافق') {
                paymentInfo.classList.remove('hidden');
                customerRating.classList.remove('hidden');
            } else if (approval === 'غير موافق') {
                rejectionReasons.classList.remove('hidden');
            }
        }

        // تبديل حقل السبب الآخر للإلغاء
        function toggleOtherRejectionReason() {
            const rejectionReason = document.getElementById('rejectionReason').value;
            const otherDiv = document.getElementById('otherRejectionDiv');
            
            if (rejectionReason === 'أخرى') {
                otherDiv.classList.remove('hidden');
                document.getElementById('otherRejectionReason').required = true;
            } else {
                otherDiv.classList.add('hidden');
                document.getElementById('otherRejectionReason').required = false;
            }
        }

        // حساب الخصم
        function calculateDiscount() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            
            const discountAmount = totalAmount * (discountPercent / 100);
            const finalAmount = totalAmount - discountAmount;
            
            document.getElementById('finalAmount').value = finalAmount.toFixed(3);
        }

        // تعيين التقييم
        function setRating(rating) {
            currentRating = rating;
            highlightStars(rating);
            updateRatingText(rating);
        }

        // تمييز النجوم
        function highlightStars(rating) {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // تحديث نص التقييم
        function updateRatingText(rating) {
            const texts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            
            document.getElementById('ratingText').textContent = texts[rating] || 'اختر التقييم';
        }

        // حفظ المعاينة
        async function saveInspection() {
            const spinner = document.getElementById('saveSpinner');
            spinner.classList.remove('hidden');
            
            try {
                // جمع البيانات من النموذج
                const inspectionData = collectFormData();
                
                // التحقق من صحة البيانات
                if (!validateInspectionData(inspectionData)) {
                    return;
                }
                
                // حفظ العميل إذا كان جديداً
                if (!isExistingCustomer) {
                    saveCustomer(inspectionData);
                }
                
                // حفظ المعاينة
                const inspectionId = 'INS-' + (++inspectionCounter);
                inspectionData.id = inspectionId;
                inspectionData.status = 'معلق';
                inspectionData.createdAt = new Date().toISOString();
                
                inspections.push(inspectionData);
                
                // حفظ البيانات محلياً
                saveLocalData();
                
                // محاولة الحفظ في Google Sheets
                await saveToGoogleSheets(inspectionData);
                
                showNotification('تم حفظ الطلب بنجاح! 🎉', 'success');
                resetForm();
                updateTables();
                
            } catch (error) {
                console.error('خطأ في حفظ المعاينة:', error);
                showNotification('تم حفظ الطلب محلياً، لكن فشل في الحفظ السحابي', 'warning');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // جمع بيانات النموذج
        function collectFormData() {
            const serviceType = document.getElementById('serviceType').value;
            const propertyType = document.getElementById('propertyType').value;
            const approval = document.querySelector('input[name="approval"]:checked').value;
            const rejectionReason = document.getElementById('rejectionReason').value;
            
            return {
                customerId: isExistingCustomer ? currentCustomerId : document.getElementById('customerId').value,
                customerName: isExistingCustomer ? customers[currentCustomerId].name : document.getElementById('customerName').value,
                customerPhone: isExistingCustomer ? customers[currentCustomerId].phone : document.getElementById('customerPhone').value,
                area: document.getElementById('customerArea').value,
                block: document.getElementById('customerBlock').value,
                avenue: document.getElementById('customerAvenue').value,
                street: document.getElementById('customerStreet').value,
                houseNumber: document.getElementById('customerHouseNumber').value,
                serviceType: serviceType === 'أخرى' ? document.getElementById('otherService').value : serviceType,
                propertyType: propertyType === 'أخرى' ? document.getElementById('otherProperty').value : propertyType,
                inspectionDate: document.getElementById('inspectionDate').value,
                inspectionTime: document.getElementById('inspectionTime').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                approval: approval,
                rejectionReason: approval === 'غير موافق' ? (rejectionReason === 'أخرى' ? document.getElementById('otherRejectionReason').value : rejectionReason) : '',
                rejectionDetails: approval === 'غير موافق' ? document.getElementById('rejectionDetails').value : '',
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
                finalAmount: parseFloat(document.getElementById('finalAmount').value) || 0,
                serviceDate: document.getElementById('serviceDate').value,
                paymentStatus: document.getElementById('paymentStatus').value,
                rating: approval === 'موافق' ? currentRating : 0,
                ratingNotes: approval === 'موافق' ? document.getElementById('ratingNotes').value : '',
                inspectorNotes: document.getElementById('inspectorNotes').value
            };
        }

        // التحقق من صحة البيانات
        function validateInspectionData(data) {
            if (!data.customerName) {
                showNotification('يرجى إدخال اسم العميل', 'error');
                return false;
            }
            
            if (!data.customerPhone) {
                showNotification('يرجى إدخال رقم الجوال', 'error');
                return false;
            }
            
            if (!data.area) {
                showNotification('يرجى اختيار المنطقة', 'error');
                return false;
            }
            
            if (!data.serviceType) {
                showNotification('يرجى اختيار نوع الخدمة', 'error');
                return false;
            }
            
            if (!data.propertyType) {
                showNotification('يرجى اختيار نوع السكن', 'error');
                return false;
            }
            
            if (!data.inspectionDate) {
                showNotification('يرجى اختيار تاريخ المعاينة', 'error');
                return false;
            }
            
            return true;
        }

        // حفظ العميل الجديد
        function saveCustomer(inspectionData) {
            const customer = {
                id: inspectionData.customerId,
                name: inspectionData.customerName,
                phone: inspectionData.customerPhone,
                createdAt: new Date().toISOString()
            };
            
            customers[customer.id] = customer;
        }

        // حفظ في Google Sheets (تم تعطيله مؤقتاً)
        async function saveToGoogleSheets(data) {
            // تم تعطيل الحفظ التلقائي في Google Sheets
            // يمكن للمستخدم استخدام زر التصدير ثم نسخ البيانات يدوياً
            console.log('تم حفظ البيانات محلياً:', data);
            return Promise.resolve({ success: true, message: 'تم الحفظ محلياً' });
        }

        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('inspectionForm').reset();
            document.getElementById('newCustomerForm').classList.add('hidden');
            document.getElementById('existingCustomerForm').classList.add('hidden');
            document.getElementById('customerHistory').classList.add('hidden');
            document.getElementById('createNewOrderBtn').classList.add('hidden');
            document.getElementById('addressPreview').classList.add('hidden');
            document.getElementById('paymentInfo').classList.add('hidden');
            document.getElementById('rejectionReasons').classList.add('hidden');
            document.getElementById('customerRating').classList.add('hidden');
            document.getElementById('otherServiceDiv').classList.add('hidden');
            document.getElementById('otherPropertyDiv').classList.add('hidden');
            document.getElementById('otherRejectionDiv').classList.add('hidden');
            
            currentRating = 0;
            highlightStars(0);
            updateRatingText(0);
            
            generateCustomerId();
            document.getElementById('customerSearch').value = '';
            
            isExistingCustomer = false;
            currentCustomerId = null;
        }

        // تحديث الجداول
        function updateTables() {
            updatePendingOrdersTable();
            updateCompletedOrdersTable();
        }

        // تحديث جدول الطلبات المعلقة
        function updatePendingOrdersTable() {
            const tbody = document.getElementById('pendingOrdersBody');
            tbody.innerHTML = '';
            
            const pendingInspections = inspections.filter(inspection => inspection.status === 'معلق');
            
            pendingInspections.forEach(inspection => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white hover:bg-opacity-10';
                
                const approvalClass = getApprovalClass(inspection.approval);
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-orange-300">${inspection.id}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.customerName}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.area}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.serviceType}</td>
                    <td class="px-6 py-4 text-sm text-white">${formatDate(inspection.inspectionDate)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${approvalClass}">${inspection.approval}</span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="showInspectionDetails('${inspection.id}')" class="text-yellow-300 hover:text-yellow-100 text-sm ml-2">عرض التفاصيل</button>
                        <button onclick="editInspection('${inspection.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm ml-2">تعديل</button>
                        <button onclick="markAsCompleted('${inspection.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">تم الانتهاء</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // تحديث جدول الطلبات المكتملة
        function updateCompletedOrdersTable() {
            const tbody = document.getElementById('completedOrdersBody');
            tbody.innerHTML = '';
            
            const completedInspections = inspections.filter(inspection => inspection.status === 'مكتمل');
            
            completedInspections.forEach(inspection => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white hover:bg-opacity-10';
                
                const approvalClass = getApprovalClass(inspection.approval);
                const stars = generateStars(inspection.rating);
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-green-300">${inspection.id}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.customerName}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.area}</td>
                    <td class="px-6 py-4 text-sm text-white">${inspection.serviceType}</td>
                    <td class="px-6 py-4 text-sm text-white">${formatDate(inspection.inspectionDate)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${approvalClass}">${inspection.approval}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-white">${stars}</td>
                    <td class="px-6 py-4">
                        <button onclick="showInspectionDetails('${inspection.id}')" class="text-blue-300 hover:text-blue-100 text-sm">عرض التفاصيل</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // الحصول على فئة الموافقة
        function getApprovalClass(approval) {
            switch (approval) {
                case 'موافق':
                    return 'approval-approved';
                case 'غير موافق':
                    return 'approval-rejected';
                default:
                    return 'approval-waiting';
            }
        }

        // توليد النجوم للتقييم
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="text-yellow-400">★</span>';
                } else {
                    stars += '<span class="text-gray-400">★</span>';
                }
            }
            return stars;
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA');
        }

        // تحديد المعاينة كمكتملة
        function markAsCompleted(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (inspection) {
                inspection.status = 'مكتمل';
                saveLocalData();
                updateTables();
                showNotification('تم تحديث حالة المعاينة إلى مكتملة', 'success');
            }
        }

        // عرض تفاصيل المعاينة
        function showInspectionDetails(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (!inspection) return;
            
            const customer = customers[inspection.customerId];
            
            const detailsHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- معلومات العميل -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-3">معلومات العميل</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">رقم العميل:</span> ${inspection.customerId}</p>
                            <p><span class="font-medium">الاسم:</span> ${inspection.customerName}</p>
                            <p><span class="font-medium">الجوال:</span> ${inspection.customerPhone}</p>
                            <p><span class="font-medium">رقم المعاينة:</span> ${inspection.id}</p>
                        </div>
                    </div>
                    
                    <!-- معلومات العنوان -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-semibold text-green-800 mb-3">معلومات العنوان</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">المنطقة:</span> ${inspection.area}</p>
                            ${inspection.block ? `<p><span class="font-medium">القطعة:</span> ${inspection.block}</p>` : ''}
                            ${inspection.avenue ? `<p><span class="font-medium">الجادة:</span> ${inspection.avenue}</p>` : ''}
                            ${inspection.street ? `<p><span class="font-medium">الشارع:</span> ${inspection.street}</p>` : ''}
                            ${inspection.houseNumber ? `<p><span class="font-medium">رقم المنزل:</span> ${inspection.houseNumber}</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- معلومات الخدمة -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-3">معلومات الخدمة</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">نوع الخدمة:</span> ${inspection.serviceType}</p>
                            <p><span class="font-medium">نوع السكن:</span> ${inspection.propertyType}</p>
                            <p><span class="font-medium">تاريخ المعاينة:</span> ${formatDate(inspection.inspectionDate)}</p>
                            <p><span class="font-medium">وقت المعاينة:</span> ${inspection.inspectionTime}</p>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- تفاصيل إضافية -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">الحالة والموافقة</h4>
                            <div class="flex space-x-4 space-x-reverse">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${inspection.status === 'مكتمل' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">${inspection.status}</span>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${getApprovalClass(inspection.approval)}">${inspection.approval}</span>
                            </div>
                        </div>
                        
                        ${inspection.approval === 'موافق' ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">المعلومات المالية</h4>
                            <div class="space-y-1 text-sm">
                                <p><span class="font-medium">المبلغ الكلي:</span> ${inspection.totalAmount} د.ك</p>
                                <p><span class="font-medium">نسبة الخصم:</span> ${inspection.discountPercent}%</p>
                                <p><span class="font-medium">المبلغ النهائي:</span> ${inspection.finalAmount} د.ك</p>
                                <p><span class="font-medium">حالة الدفع:</span> ${inspection.paymentStatus}</p>
                                ${inspection.serviceDate ? `<p><span class="font-medium">تاريخ تنفيذ الخدمة:</span> ${formatDate(inspection.serviceDate)}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${inspection.approval === 'غير موافق' && inspection.rejectionReason ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">سبب الإلغاء</h4>
                            <div class="space-y-1 text-sm">
                                <p><span class="font-medium">السبب:</span> ${inspection.rejectionReason}</p>
                                ${inspection.rejectionDetails ? `<p><span class="font-medium">التفاصيل:</span> ${inspection.rejectionDetails}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${inspection.rating > 0 ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">التقييم</h4>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <div>${generateStars(inspection.rating)}</div>
                                <span class="text-sm text-gray-600">(${inspection.rating}/5)</span>
                            </div>
                            ${inspection.ratingNotes ? `<p class="text-sm text-gray-600 mt-1">${inspection.ratingNotes}</p>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- الملاحظات -->
                    <div class="space-y-4">
                        ${inspection.additionalNotes ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">ملاحظات إضافية</h4>
                            <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${inspection.additionalNotes}</p>
                        </div>
                        ` : ''}
                        
                        ${inspection.inspectorNotes ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">ملاحظات المفتش</h4>
                            <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${inspection.inspectorNotes}</p>
                        </div>
                        ` : ''}
                        
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">تاريخ الإنشاء</h4>
                            <p class="text-sm text-gray-600">${formatDate(inspection.createdAt)}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('inspectionDetails').innerHTML = detailsHTML;
            document.getElementById('inspectionModal').classList.remove('hidden');
            document.getElementById('inspectionModal').classList.add('flex');
        }

        // إغلاق نافذة تفاصيل المعاينة
        function closeInspectionModal() {
            document.getElementById('inspectionModal').classList.add('hidden');
            document.getElementById('inspectionModal').classList.remove('flex');
        }

        // اختبار الاتصال
        async function testConnection() {
            showNotification('جاري اختبار الاتصال مع Google Sheets...', 'warning');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=test', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                showNotification('تم الاتصال بنجاح مع Google Sheets! ✅', 'success');
            } catch (error) {
                showNotification('فشل في الاتصال مع Google Sheets - سيعمل النظام محلياً', 'error');
            }
        }

        // فحص البيانات المحلية
        function checkLocalData() {
            const customersCount = Object.keys(customers).length;
            const inspectionsCount = inspections.length;
            const pendingCount = inspections.filter(i => i.status === 'معلق').length;
            const completedCount = inspections.filter(i => i.status === 'مكتمل').length;
            
            const message = `📊 إحصائيات البيانات المحلية:
            
العملاء: ${customersCount}
إجمالي المعاينات: ${inspectionsCount}
المعاينات المعلقة: ${pendingCount}
المعاينات المكتملة: ${completedCount}
آخر رقم معاينة: ${inspectionCounter}`;
            
            alert(message);
        }

        // فتح Google Sheets
        function openGoogleSheets() {
            window.open(GOOGLE_SHEETS_URL, '_blank', 'noopener,noreferrer');
        }

        // قراءة البيانات من Google Sheets
        async function loadFromGoogleSheets() {
            showNotification('جاري تحميل البيانات من Google Sheets...', 'warning');
            
            try {
                // محاولة قراءة بيانات المعاينات من الشيت الأول
                const inspectionsUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:csv&gid=0`;
                
                console.log('محاولة الاتصال بـ:', inspectionsUrl);
                
                // استخدام طريقة مختلفة للوصول للبيانات
                let response;
                let csvData;
                
                try {
                    // المحاولة الأولى: استخدام fetch عادي
                    response = await fetch(inspectionsUrl, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain,*/*'
                        }
                    });
                    
                    if (response.ok) {
                        csvData = await response.text();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (fetchError) {
                    console.log('فشل في fetch، محاولة طريقة بديلة...');
                    
                    // المحاولة الثانية: استخدام رابط مختلف
                    const alternativeUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/export?format=csv&gid=0`;
                    console.log('محاولة الرابط البديل:', alternativeUrl);
                    
                    try {
                        response = await fetch(alternativeUrl, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            csvData = await response.text();
                        } else {
                            throw new Error(`فشل في الرابط البديل: ${response.status}`);
                        }
                    } catch (altError) {
                        console.log('فشل في الرابط البديل أيضاً');
                        
                        // المحاولة الثالثة: استخدام JSONP
                        try {
                            csvData = await loadViaJSONP();
                        } catch (jsonpError) {
                            throw new Error('فشل في جميع طرق الاتصال. تأكد من أن الشيت مشارك للعامة للقراءة');
                        }
                    }
                }
                
                console.log('البيانات المستلمة:', csvData ? csvData.substring(0, 500) : 'لا توجد بيانات');
                
                if (!csvData || csvData.trim() === '' || csvData.includes('<!DOCTYPE html>')) {
                    throw new Error('لا توجد بيانات صالحة في الشيت أو الشيت غير مشارك للعامة');
                }
                
                // تحويل CSV إلى JSON
                const parsedInspections = parseCSVToInspections(csvData);
                const parsedCustomers = extractCustomersFromInspections(parsedInspections);
                
                // دمج البيانات مع البيانات المحلية
                let newCustomersCount = 0;
                let newInspectionsCount = 0;
                
                // إضافة العملاء الجدد
                Object.keys(parsedCustomers).forEach(customerId => {
                    if (!customers[customerId]) {
                        customers[customerId] = parsedCustomers[customerId];
                        newCustomersCount++;
                    }
                });
                
                // إضافة المعاينات الجديدة
                parsedInspections.forEach(newInsp => {
                    if (!inspections.some(existingInsp => existingInsp.id === newInsp.id)) {
                        inspections.push(newInsp);
                        newInspectionsCount++;
                    }
                });
                
                // حفظ البيانات محلياً
                saveLocalData();
                updateTables();
                
                showNotification(`تم تحميل ${newCustomersCount} عميل جديد و ${newInspectionsCount} معاينة جديدة من Google Sheets! ✅`, 'success');
                
            } catch (error) {
                console.error('خطأ في قراءة البيانات:', error);
                
                // إظهار رسالة مفصلة حسب نوع الخطأ
                let errorMessage = 'فشل في قراءة البيانات من Google Sheets';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'مشكلة في الاتصال - تأكد من الاتصال بالإنترنت وأن الشيت مشارك للعامة';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'مشكلة في أذونات الوصول - تأكد من أن الشيت مشارك للعامة للقراءة';
                } else {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
                
                // اقتراح حلول
                setTimeout(() => {
                    showNotification('💡 نصيحة: تأكد من أن Google Sheet مشارك للعامة (Anyone with the link can view)', 'warning');
                }, 2000);
            }
        }

        // تحميل البيانات باستخدام JSONP كطريقة بديلة
        function loadViaJSONP() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'jsonpCallback_' + Date.now();
                
                window[callbackName] = function(data) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    // تحويل البيانات إلى CSV
                    if (data && data.table && data.table.rows) {
                        let csv = '';
                        data.table.rows.forEach(row => {
                            const rowData = row.c.map(cell => cell ? (cell.v || '') : '');
                            csv += rowData.map(field => `"${field}"`).join(',') + '\n';
                        });
                        resolve(csv);
                    } else {
                        reject(new Error('لا توجد بيانات في الاستجابة'));
                    }
                };
                
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('فشل في تحميل البيانات عبر JSONP'));
                };
                
                const jsonpUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:json&tq=SELECT%20*&gid=0&headers=1&callback=${callbackName}`;
                script.src = jsonpUrl;
                document.head.appendChild(script);
                
                // timeout بعد 10 ثواني
                setTimeout(() => {
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('انتهت مهلة الاتصال'));
                    }
                }, 10000);
            });
        }



        // تحويل CSV المعاينات إلى JSON
        function parseCSVToInspections(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const inspections = [];
            
            if (lines.length < 2) {
                console.log('لا توجد بيانات كافية في CSV');
                return inspections;
            }
            
            console.log('عدد الأسطر:', lines.length);
            console.log('الهيدر:', lines[0]);
            
            // تخطي الهيدر
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                console.log(`السطر ${i}:`, values);
                
                if (values.length >= 3 && values[0] && values[0].trim() !== '') {
                    const inspection = {
                        id: values[0] || `INS-${Date.now()}-${i}`,
                        customerId: values[1] || `CUST-${Date.now()}-${i}`,
                        customerName: values[2] || '',
                        customerPhone: values[3] || '',
                        area: values[4] || '',
                        serviceType: values[5] || '',
                        propertyType: values[6] || '',
                        inspectionDate: values[7] || '',
                        inspectionTime: values[8] || 'صباحاً (8-12)',
                        status: values[9] || 'معلق',
                        approval: values[10] || 'في الانتظار',
                        totalAmount: parseFloat(values[11]) || 0,
                        finalAmount: parseFloat(values[12]) || 0,
                        rating: parseInt(values[13]) || 0,
                        additionalNotes: values[14] || '',
                        inspectorNotes: values[15] || '',
                        createdAt: values[16] || new Date().toISOString(),
                        // حقول إضافية
                        block: values[17] || '',
                        avenue: values[18] || '',
                        street: values[19] || '',
                        houseNumber: values[20] || '',
                        rejectionReason: values[21] || '',
                        rejectionDetails: values[22] || '',
                        discountPercent: parseFloat(values[23]) || 0,
                        serviceDate: values[24] || '',
                        paymentStatus: values[25] || 'في الانتظار',
                        ratingNotes: values[26] || ''
                    };
                    
                    inspections.push(inspection);
                }
            }
            
            console.log('تم تحليل', inspections.length, 'معاينة');
            return inspections;
        }

        // استخراج العملاء من المعاينات
        function extractCustomersFromInspections(inspections) {
            const customers = {};
            
            inspections.forEach(inspection => {
                if (inspection.customerId && !customers[inspection.customerId]) {
                    customers[inspection.customerId] = {
                        id: inspection.customerId,
                        name: inspection.customerName || '',
                        phone: inspection.customerPhone || '',
                        createdAt: inspection.createdAt || new Date().toISOString()
                    };
                }
            });
            
            return customers;
        }

        // تحليل سطر CSV مع التعامل مع الفواصل داخل النصوص
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // تصدير البيانات كـ Excel
        function exportData() {
            // إضافة BOM للترميز العربي الصحيح
            const BOM = '\uFEFF';
            
            // إنشاء محتوى CSV للعملاء
            let customersCSV = BOM + 'customer_id,name,phone,created_at\n';
            Object.values(customers).forEach(customer => {
                customersCSV += `"${customer.id}","${customer.name}","${customer.phone}","${customer.createdAt}"\n`;
            });

            // إنشاء محتوى CSV للمعاينات
            let inspectionsCSV = BOM + 'inspection_id,customer_id,customer_name,area,service_type,property_type,inspection_date,inspection_time,status,approval,total_amount,final_amount,rating,additional_notes,inspector_notes,created_at\n';
            inspections.forEach(inspection => {
                inspectionsCSV += `"${inspection.id}","${inspection.customerId}","${inspection.customerName}","${inspection.area}","${inspection.serviceType}","${inspection.propertyType}","${inspection.inspectionDate}","${inspection.inspectionTime}","${inspection.status}","${inspection.approval}","${inspection.totalAmount}","${inspection.finalAmount}","${inspection.rating}","${inspection.additionalNotes || ''}","${inspection.inspectorNotes || ''}","${inspection.createdAt}"\n`;
            });

            // تصدير ملف العملاء
            const customersBlob = new Blob([customersCSV], { type: 'text/csv;charset=utf-8;' });
            const customersUrl = URL.createObjectURL(customersBlob);
            const customersLink = document.createElement('a');
            customersLink.href = customersUrl;
            customersLink.download = `Customers-${new Date().toISOString().split('T')[0]}.csv`;
            customersLink.click();
            URL.revokeObjectURL(customersUrl);

            // تصدير ملف المعاينات
            setTimeout(() => {
                const inspectionsBlob = new Blob([inspectionsCSV], { type: 'text/csv;charset=utf-8;' });
                const inspectionsUrl = URL.createObjectURL(inspectionsBlob);
                const inspectionsLink = document.createElement('a');
                inspectionsLink.href = inspectionsUrl;
                inspectionsLink.download = `Inspections-${new Date().toISOString().split('T')[0]}.csv`;
                inspectionsLink.click();
                URL.revokeObjectURL(inspectionsUrl);
            }, 500);
            
            showNotification('تم تصدير ملفي CSV بنجاح! يمكنك رفعهما إلى Google Sheets 📥', 'success');
        }

        // تعديل المعاينة
        function editInspection(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (!inspection) return;
            
            const editContent = document.getElementById('editInspectionContent');
            editContent.innerHTML = `
                <!-- موافقة العميل على الخدمة -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">موافقة العميل على الخدمة</h4>
                    <div class="flex space-x-6 space-x-reverse">
                        <label class="flex items-center">
                            <input type="radio" name="editApproval" value="موافق" ${inspection.approval === 'موافق' ? 'checked' : ''} onchange="toggleEditApprovalSections()" class="ml-2">
                            <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm">موافق</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="editApproval" value="غير موافق" ${inspection.approval === 'غير موافق' ? 'checked' : ''} onchange="toggleEditApprovalSections()" class="ml-2">
                            <span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm">غير موافق</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="editApproval" value="في الانتظار" ${inspection.approval === 'في الانتظار' ? 'checked' : ''} onchange="toggleEditApprovalSections()" class="ml-2">
                            <span class="px-3 py-1 bg-blue-500 text-white rounded-full text-sm">في الانتظار</span>
                        </label>
                    </div>
                </div>

                <!-- أسباب الإلغاء -->
                <div id="editRejectionReasons" class="mb-6 ${inspection.approval !== 'غير موافق' ? 'hidden' : ''}">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">أسباب الإلغاء</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">سبب الإلغاء</label>
                            <select id="editRejectionReason" onchange="toggleEditOtherRejectionReason()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر سبب الإلغاء</option>
                                <option value="السعر مرتفع" ${inspection.rejectionReason === 'السعر مرتفع' ? 'selected' : ''}>السعر مرتفع</option>
                                <option value="تغيير في الخطط" ${inspection.rejectionReason === 'تغيير في الخطط' ? 'selected' : ''}>تغيير في الخطط</option>
                                <option value="وجد خدمة أخرى" ${inspection.rejectionReason === 'وجد خدمة أخرى' ? 'selected' : ''}>وجد خدمة أخرى</option>
                                <option value="عدم توفر الوقت" ${inspection.rejectionReason === 'عدم توفر الوقت' ? 'selected' : ''}>عدم توفر الوقت</option>
                                <option value="عدم الحاجة للخدمة" ${inspection.rejectionReason === 'عدم الحاجة للخدمة' ? 'selected' : ''}>عدم الحاجة للخدمة</option>
                                <option value="مشكلة في التواصل" ${inspection.rejectionReason === 'مشكلة في التواصل' ? 'selected' : ''}>مشكلة في التواصل</option>
                                <option value="أخرى" ${inspection.rejectionReason && !['السعر مرتفع', 'تغيير في الخطط', 'وجد خدمة أخرى', 'عدم توفر الوقت', 'عدم الحاجة للخدمة', 'مشكلة في التواصل'].includes(inspection.rejectionReason) ? 'selected' : ''}>أخرى</option>
                            </select>
                        </div>
                        <div id="editOtherRejectionDiv" class="${inspection.rejectionReason && !['السعر مرتفع', 'تغيير في الخطط', 'وجد خدمة أخرى', 'عدم توفر الوقت', 'عدم الحاجة للخدمة', 'مشكلة في التواصل'].includes(inspection.rejectionReason) ? '' : 'hidden'}">
                            <label class="block text-gray-700 text-sm font-bold mb-2">تحديد السبب الآخر</label>
                            <input type="text" id="editOtherRejectionReason" value="${inspection.rejectionReason && !['السعر مرتفع', 'تغيير في الخطط', 'وجد خدمة أخرى', 'عدم توفر الوقت', 'عدم الحاجة للخدمة', 'مشكلة في التواصل'].includes(inspection.rejectionReason) ? inspection.rejectionReason : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">تفاصيل إضافية حول سبب الإلغاء</label>
                        <textarea id="editRejectionDetails" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="اكتب تفاصيل إضافية حول سبب الإلغاء...">${inspection.rejectionDetails || ''}</textarea>
                    </div>
                </div>

                <!-- معلومات الدفع -->
                <div id="editPaymentInfo" class="mb-6 ${inspection.approval !== 'موافق' ? 'hidden' : ''}">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">معلومات الدفع</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ الكلي (د.ك)</label>
                            <input type="number" id="editTotalAmount" step="0.001" value="${inspection.totalAmount || ''}" onchange="calculateEditDiscount()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">نسبة الخصم (%)</label>
                            <input type="number" id="editDiscountPercent" step="0.1" value="${inspection.discountPercent || ''}" onchange="calculateEditDiscount()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">المبلغ بعد الخصم (د.ك)</label>
                            <input type="number" id="editFinalAmount" step="0.001" value="${inspection.finalAmount || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">تاريخ تنفيذ الخدمة</label>
                            <input type="date" id="editServiceDate" value="${inspection.serviceDate || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">حالة الدفع</label>
                        <select id="editPaymentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="في الانتظار" ${inspection.paymentStatus === 'في الانتظار' ? 'selected' : ''}>في الانتظار</option>
                            <option value="مدفوع" ${inspection.paymentStatus === 'مدفوع' ? 'selected' : ''}>مدفوع</option>
                            <option value="مدفوع جزئياً" ${inspection.paymentStatus === 'مدفوع جزئياً' ? 'selected' : ''}>مدفوع جزئياً</option>
                        </select>
                    </div>
                </div>

                <!-- تقييم رضا العميل -->
                <div id="editCustomerRating" class="mb-6 ${inspection.approval !== 'موافق' ? 'hidden' : ''}">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">تقييم رضا العميل</h4>
                    <div class="mb-4">
                        <div class="star-rating" id="editStarRating">
                            <span class="star ${inspection.rating >= 1 ? 'active' : ''}" data-rating="1">★</span>
                            <span class="star ${inspection.rating >= 2 ? 'active' : ''}" data-rating="2">★</span>
                            <span class="star ${inspection.rating >= 3 ? 'active' : ''}" data-rating="3">★</span>
                            <span class="star ${inspection.rating >= 4 ? 'active' : ''}" data-rating="4">★</span>
                            <span class="star ${inspection.rating >= 5 ? 'active' : ''}" data-rating="5">★</span>
                        </div>
                        <p id="editRatingText" class="text-gray-600 mt-2">${getRatingText(inspection.rating)}</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ملاحظة حول سبب التقييم</label>
                        <textarea id="editRatingNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">${inspection.ratingNotes || ''}</textarea>
                    </div>
                </div>

                <!-- ملاحظات إضافية -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">ملاحظات إضافية</h4>
                    <textarea id="editInspectorNotes" rows="3" placeholder="ملاحظات إضافية من المفتش..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">${inspection.inspectorNotes || ''}</textarea>
                </div>

                <input type="hidden" id="editInspectionId" value="${inspection.id}">
            `;
            
            // إعداد نظام التقييم للتعديل
            setupEditRatingSystem(inspection.rating);
            
            // إعداد نموذج التعديل
            document.getElementById('editInspectionForm').onsubmit = function(e) {
                e.preventDefault();
                saveInspectionEdit();
            };
            
            document.getElementById('editInspectionModal').classList.remove('hidden');
            document.getElementById('editInspectionModal').classList.add('flex');
        }

        // إعداد نظام التقييم للتعديل
        function setupEditRatingSystem(currentRating) {
            let editCurrentRating = currentRating || 0;
            
            document.querySelectorAll('#editStarRating .star').forEach(star => {
                star.addEventListener('click', function() {
                    editCurrentRating = parseInt(this.dataset.rating);
                    updateEditStars(editCurrentRating);
                    updateEditRatingText(editCurrentRating);
                });
                
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    updateEditStars(rating);
                });
            });
            
            document.getElementById('editStarRating').addEventListener('mouseleave', function() {
                updateEditStars(editCurrentRating);
            });
        }

        // تحديث نجوم التعديل
        function updateEditStars(rating) {
            document.querySelectorAll('#editStarRating .star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // تحديث نص التقييم للتعديل
        function updateEditRatingText(rating) {
            document.getElementById('editRatingText').textContent = getRatingText(rating);
        }

        // الحصول على نص التقييم
        function getRatingText(rating) {
            const texts = {
                1: 'غير راضي تماماً',
                2: 'غير راضي',
                3: 'راضي إلى حد ما',
                4: 'راضي',
                5: 'راضي جداً'
            };
            return texts[rating] || 'اختر التقييم';
        }

        // تبديل الأقسام في نموذج التعديل
        function toggleEditApprovalSections() {
            const approval = document.querySelector('input[name="editApproval"]:checked').value;
            const paymentInfo = document.getElementById('editPaymentInfo');
            const rejectionReasons = document.getElementById('editRejectionReasons');
            const customerRating = document.getElementById('editCustomerRating');
            
            // إخفاء جميع الأقسام أولاً
            paymentInfo.classList.add('hidden');
            rejectionReasons.classList.add('hidden');
            customerRating.classList.add('hidden');
            
            if (approval === 'موافق') {
                paymentInfo.classList.remove('hidden');
                customerRating.classList.remove('hidden');
            } else if (approval === 'غير موافق') {
                rejectionReasons.classList.remove('hidden');
            }
        }

        // تبديل حقل السبب الآخر في التعديل
        function toggleEditOtherRejectionReason() {
            const rejectionReason = document.getElementById('editRejectionReason').value;
            const otherDiv = document.getElementById('editOtherRejectionDiv');
            
            if (rejectionReason === 'أخرى') {
                otherDiv.classList.remove('hidden');
                document.getElementById('editOtherRejectionReason').required = true;
            } else {
                otherDiv.classList.add('hidden');
                document.getElementById('editOtherRejectionReason').required = false;
            }
        }

        // حساب الخصم في التعديل
        function calculateEditDiscount() {
            const totalAmount = parseFloat(document.getElementById('editTotalAmount').value) || 0;
            const discountPercent = parseFloat(document.getElementById('editDiscountPercent').value) || 0;
            
            const discountAmount = totalAmount * (discountPercent / 100);
            const finalAmount = totalAmount - discountAmount;
            
            document.getElementById('editFinalAmount').value = finalAmount.toFixed(3);
        }

        // حفظ تعديل المعاينة
        function saveInspectionEdit() {
            const inspectionId = document.getElementById('editInspectionId').value;
            const inspection = inspections.find(i => i.id === inspectionId);
            
            if (!inspection) return;
            
            const approval = document.querySelector('input[name="editApproval"]:checked').value;
            const rejectionReason = document.getElementById('editRejectionReason').value;
            
            // تحديث البيانات
            inspection.approval = approval;
            
            // تحديث أسباب الإلغاء
            if (approval === 'غير موافق') {
                inspection.rejectionReason = rejectionReason === 'أخرى' ? document.getElementById('editOtherRejectionReason').value : rejectionReason;
                inspection.rejectionDetails = document.getElementById('editRejectionDetails').value;
                // مسح بيانات التقييم والدفع
                inspection.rating = 0;
                inspection.ratingNotes = '';
                inspection.totalAmount = 0;
                inspection.finalAmount = 0;
                inspection.paymentStatus = '';
            } else {
                // مسح أسباب الإلغاء
                inspection.rejectionReason = '';
                inspection.rejectionDetails = '';
                
                if (approval === 'موافق') {
                    inspection.totalAmount = parseFloat(document.getElementById('editTotalAmount').value) || 0;
                    inspection.discountPercent = parseFloat(document.getElementById('editDiscountPercent').value) || 0;
                    inspection.finalAmount = parseFloat(document.getElementById('editFinalAmount').value) || 0;
                    inspection.serviceDate = document.getElementById('editServiceDate').value;
                    inspection.paymentStatus = document.getElementById('editPaymentStatus').value;
                    inspection.rating = getCurrentEditRating();
                    inspection.ratingNotes = document.getElementById('editRatingNotes').value;
                } else {
                    // في الانتظار - مسح بيانات الدفع والتقييم
                    inspection.rating = 0;
                    inspection.ratingNotes = '';
                    inspection.totalAmount = 0;
                    inspection.finalAmount = 0;
                    inspection.paymentStatus = '';
                }
            }
            
            inspection.inspectorNotes = document.getElementById('editInspectorNotes').value;
            
            // حفظ البيانات
            saveLocalData();
            updateTables();
            closeEditInspectionModal();
            
            showNotification('تم حفظ التعديلات بنجاح! ✅', 'success');
        }

        // الحصول على التقييم الحالي في التعديل
        function getCurrentEditRating() {
            const activeStars = document.querySelectorAll('#editStarRating .star.active');
            return activeStars.length;
        }

        // إغلاق نافذة تعديل المعاينة
        function closeEditInspectionModal() {
            document.getElementById('editInspectionModal').classList.add('hidden');
            document.getElementById('editInspectionModal').classList.remove('flex');
        }

        // إظهار الإشعارات
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // إظهار الإشعار
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // إخفاء الإشعار
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a4346e0401c68b',t:'MTc1OTc0MzcwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
