<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-cancelled { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-preview { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .status-approved { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .star-rating {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 24px;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #fbbf24;
        }

        .star:hover {
            color: #fbbf24;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">ğŸ  Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</h1>
            <p class="text-gray-600 text-center mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ù…Ø¹ ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-2xl shadow-lg mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button px-6 py-4 font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                    ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                <button onclick="showTab('active')" id="tab-active" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    ğŸ”„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                </button>
                <button onclick="showTab('completed')" id="tab-completed" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    âœ… Ù…ÙƒØªÙ…Ù„Ø©
                </button>
                <button onclick="showTab('add')" id="tab-add" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="showTab('research')" id="tab-research" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                            <p id="total-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">ğŸ“¦</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100">Ù…Ø¹Ø§ÙŠÙ†Ø©</p>
                            <p id="preview-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">ğŸ‘ï¸</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-cyan-100">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</p>
                            <p id="approved-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">âœ”ï¸</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">Ù…ÙƒØªÙ…Ù„Ø©</p>
                            <p id="completed-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">ğŸ‰</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-amber-100">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                            <p id="total-amount" class="text-2xl font-bold">0 Ø¯.Ùƒ</p>
                        </div>
                        <div class="text-4xl">ğŸ’</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</h3>
                <div id="recent-orders" class="space-y-4">
                    <!-- Recent orders will be populated here -->
                </div>
            </div>
        </div>

        <!-- Active Orders Tab -->
        <div id="active-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="active-search-input" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="active-status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</option>
                        <option value="Ù…Ø¹Ø§ÙŠÙ†Ø©">Ù…Ø¹Ø§ÙŠÙ†Ø©</option>
                        <option value="Ù…ÙˆØ§ÙÙ‚">Ù…ÙˆØ§ÙÙ‚</option>
                        <option value="Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„</option>
                        <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ</option>
                        <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                    </select>
                    <button onclick="refreshData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>
            
            <div id="active-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Active orders will be populated here -->
            </div>
        </div>

        <!-- Completed Orders Tab -->
        <div id="completed-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="completed-search-input" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="completed-status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</option>
                        <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„</option>
                        <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
                    </select>
                </div>
            </div>
            
            <div id="completed-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Completed orders will be populated here -->
            </div>
        </div>

        <!-- Add New Order Tab -->
        <div id="add-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <!-- Customer Search Section -->
                <div class="mb-8 p-6 bg-blue-50 rounded-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                    <div class="flex gap-4">
                        <input type="text" id="customer-search" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„)..." 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <button onclick="searchCustomer()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                            Ø¨Ø­Ø«
                        </button>
                    </div>
                    
                    <div id="customer-history" class="mt-4 hidden">
                        <h4 class="font-semibold text-gray-800 mb-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…ÙŠÙ„:</h4>
                        <div id="customer-orders-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Customer orders will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- New Order Form -->
                <div id="new-order-section" class="hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                    
                    <form id="new-order-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                                <input type="text" id="order-number" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <input type="text" id="customer-id" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <input type="text" id="customer-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                                <input type="text" id="area" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø´Ø§Ø±Ø¹</label>
                                <input type="text" id="street" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„</label>
                                <input type="text" id="house-number" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¯ÙˆØ±</label>
                                <input type="text" id="floor" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†</label>
                                <select id="housing-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†</option>
                                    <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
                                    <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
                                    <option value="Ø¨ÙŠØª Ø´Ø¹Ø¨ÙŠ">Ø¨ÙŠØª Ø´Ø¹Ø¨ÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                                <select id="service-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
                                    <option value="ØªÙ†Ø¸ÙŠÙ Ø¹Ø§Ù…">ØªÙ†Ø¸ÙŠÙ Ø¹Ø§Ù…</option>
                                    <option value="ØªÙ†Ø¸ÙŠÙ Ø¹Ù…ÙŠÙ‚">ØªÙ†Ø¸ÙŠÙ Ø¹Ù…ÙŠÙ‚</option>
                                    <option value="ØªÙ†Ø¸ÙŠÙ Ø´Ù‚Ù‚">ØªÙ†Ø¸ÙŠÙ Ø´Ù‚Ù‚</option>
                                    <option value="ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØ§ØªØ¨">ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØ§ØªØ¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                                <input type="date" id="visit-date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                                <input type="time" id="visit-time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ùƒ)</label>
                                <input type="number" id="initial-price" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>

                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <textarea id="customer-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-xl hover:bg-purple-700 transition-colors font-semibold">
                                ğŸ‘ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø¹Ø§ÙŠÙ†Ø©
                            </button>
                            <button type="button" onclick="copyToClipboard()" class="bg-green-600 text-white py-3 px-6 rounded-xl hover:bg-green-700 transition-colors font-semibold">
                                ğŸ“‹ Ù†Ø³Ø® Ù„Ù„Ø´ÙŠØª
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="local-orders" class="mt-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ØºÙŠØ± Ù…Ø±Ø³Ù„Ø©)</h4>
                    <div id="local-orders-list" class="space-y-3">
                        <!-- Local orders will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Tab -->
        <div id="research-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
                    <div id="service-stats" class="space-y-3">
                        <!-- Service statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h3>
                    <div id="area-stats" class="space-y-3">
                        <!-- Area statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
                    <div id="rating-stats" class="space-y-3">
                        <!-- Rating statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <div id="monthly-stats" class="space-y-3">
                        <!-- Monthly statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Management Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div id="modal-content">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let localOrders = JSON.parse(localStorage.getItem('localOrders') || '[]');
        let currentCustomerId = '';
        let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1000');
        
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI/gviz/tq?tqx=out:json';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            displayLocalOrders();
            
            // Auto-refresh every minute
            setInterval(fetchData, 60000);
            
            // Search and filter functionality
            document.getElementById('active-search-input').addEventListener('input', () => filterOrders('active'));
            document.getElementById('active-status-filter').addEventListener('change', () => filterOrders('active'));
            document.getElementById('completed-search-input').addEventListener('input', () => filterOrders('completed'));
            document.getElementById('completed-status-filter').addEventListener('change', () => filterOrders('completed'));
            
            // Form submission
            document.getElementById('new-order-form').addEventListener('submit', handleFormSubmit);
            
            // Customer search
            document.getElementById('customer-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomer();
                }
            });
        });
        
        // Generate automatic order number
        function generateOrderNumber() {
            orderCounter++;
            localStorage.setItem('orderCounter', orderCounter.toString());
            return `ORD-${orderCounter}`;
        }
        
        // Search for customer
        function searchCustomer() {
            const customerId = document.getElementById('customer-search').value.trim();
            if (!customerId) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'warning');
                return;
            }
            
            currentCustomerId = customerId;
            
            // Find customer orders
            const customerOrders = allOrders.filter(order => order.customerId === customerId);
            
            if (customerOrders.length > 0) {
                displayCustomerHistory(customerOrders);
            } else {
                document.getElementById('customer-history').classList.add('hidden');
                showNotification('Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©', 'info');
            }
            
            // Show new order section and populate customer ID
            document.getElementById('new-order-section').classList.remove('hidden');
            document.getElementById('customer-id').value = customerId;
            document.getElementById('order-number').value = generateOrderNumber();
            
            // Auto-fill customer name if exists
            if (customerOrders.length > 0) {
                document.getElementById('customer-name').value = customerOrders[0].customerName;
            }
        }
        
        // Display customer history
        function displayCustomerHistory(orders) {
            const container = document.getElementById('customer-orders-list');
            container.innerHTML = orders.map(order => `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">${order.orderNumber}</p>
                            <p class="text-sm text-gray-600">${order.serviceType} - ${order.area}</p>
                            <p class="text-sm text-gray-600">${order.visitDate}</p>
                        </div>
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">${order.totalAmount} Ø¯.Ùƒ</p>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                                ${order.orderStatus}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('customer-history').classList.remove('hidden');
        }
        
        // Fetch data from Google Sheets
        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // Parse Google Sheets JSON response
                const jsonString = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);
                
                if (data.table && data.table.rows) {
                    allOrders = data.table.rows.map((row, index) => {
                        const cells = row.c || [];
                        return {
                            id: index + 1,
                            orderNumber: cells[0]?.v || '',
                            customerId: cells[1]?.v || '',
                            customerName: cells[2]?.v || '',
                            area: cells[3]?.v || '',
                            street: cells[4]?.v || '',
                            houseNumber: cells[5]?.v || '',
                            floor: cells[6]?.v || '',
                            housingType: cells[7]?.v || '',
                            locationNotes: cells[8]?.v || '',
                            serviceType: cells[9]?.v || '',
                            visitDate: cells[10]?.v || '',
                            visitTime: cells[11]?.v || '',
                            serviceFrequency: cells[12]?.v || '',
                            paymentMethod: cells[13]?.v || '',
                            initialPrice: cells[14]?.v || 0,
                            discountPercentage: cells[15]?.v || 0,
                            finalPrice: cells[16]?.v || 0,
                            orderStatus: cells[17]?.v || 'Ù…Ø¹Ø§ÙŠÙ†Ø©',
                            paymentStatus: cells[18]?.v || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                            cancellationReason: cells[19]?.v || '',
                            customerRating: cells[20]?.v || 0,
                            customerNotes: cells[21]?.v || '',
                            teamNotes: cells[22]?.v || '',
                            createdAt: cells[23]?.v || ''
                        };
                    });
                }
                
                updateDashboard();
                displayActiveOrders();
                displayCompletedOrders();
                updateResearchData();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Update dashboard statistics
        function updateDashboard() {
            const totalOrders = allOrders.length;
            const previewOrders = allOrders.filter(order => order.orderStatus === 'Ù…Ø¹Ø§ÙŠÙ†Ø©').length;
            const approvedOrders = allOrders.filter(order => order.orderStatus === 'Ù…ÙˆØ§ÙÙ‚').length;
            const completedOrders = allOrders.filter(order => order.orderStatus === 'Ù…ÙƒØªÙ…Ù„').length;
            const totalAmount = allOrders.reduce((sum, order) => sum + (parseFloat(order.finalPrice) || parseFloat(order.initialPrice) || 0), 0);
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('preview-orders').textContent = previewOrders;
            document.getElementById('approved-orders').textContent = approvedOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            document.getElementById('total-amount').textContent = totalAmount.toFixed(1) + ' Ø¯.Ùƒ';
            
            // Display recent orders
            const recentOrders = allOrders.slice(-5).reverse();
            const recentOrdersContainer = document.getElementById('recent-orders');
            recentOrdersContainer.innerHTML = recentOrders.map(order => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${order.customerName}</p>
                        <p class="text-sm text-gray-600">${order.serviceType} - ${order.area}</p>
                    </div>
                    <div class="text-left">
                        <p class="font-semibold text-gray-800">${order.finalPrice || order.initialPrice} Ø¯.Ùƒ</p>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        // Display active orders
        function displayActiveOrders(orders = null) {
            const activeOrders = orders || allOrders.filter(order => 
                ['Ù…Ø¹Ø§ÙŠÙ†Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„', 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'].includes(order.orderStatus)
            );
            
            const ordersGrid = document.getElementById('active-orders-grid');
            ordersGrid.innerHTML = activeOrders.map(order => `
                <div class="bg-white rounded-2xl shadow-lg p-6 card-hover fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${order.customerName}</h3>
                            <p class="text-sm text-gray-600">Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${order.orderNumber}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ“± Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                            <span class="text-gray-800">${order.customerId}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span>
                            <span class="text-gray-800">${order.area}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ  Ø§Ù„Ø®Ø¯Ù…Ø©:</span>
                            <span class="text-gray-800">${order.serviceType}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                            <span class="text-gray-800">${order.visitDate}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</span>
                            <span class="text-gray-800 font-semibold">${order.finalPrice || order.initialPrice} Ø¯.Ùƒ</span>
                        </div>
                    </div>
                    
                    <button onclick="openOrderModal('${order.id}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            `).join('');
        }
        
        // Display completed orders
        function displayCompletedOrders(orders = null) {
            const completedOrders = orders || allOrders.filter(order => 
                ['Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'].includes(order.orderStatus)
            );
            
            const ordersGrid = document.getElementById('completed-orders-grid');
            ordersGrid.innerHTML = completedOrders.map(order => `
                <div class="bg-white rounded-2xl shadow-lg p-6 card-hover fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${order.customerName}</h3>
                            <p class="text-sm text-gray-600">Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${order.orderNumber}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ“± Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                            <span class="text-gray-800">${order.customerId}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ  Ø§Ù„Ø®Ø¯Ù…Ø©:</span>
                            <span class="text-gray-800">${order.serviceType}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</span>
                            <span class="text-gray-800 font-semibold">${order.finalPrice || order.initialPrice} Ø¯.Ùƒ</span>
                        </div>
                        ${order.customerRating > 0 ? `
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span>
                                <span class="text-yellow-500">${'â˜…'.repeat(order.customerRating)}${'â˜†'.repeat(5-order.customerRating)}</span>
                            </div>
                        ` : ''}
                        ${order.cancellationReason ? `
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">âŒ Ø§Ù„Ø³Ø¨Ø¨:</span>
                                <span class="text-red-600">${order.cancellationReason}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button onclick="openOrderModal('${order.id}')" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                        Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    </button>
                </div>
            `).join('');
        }
        
        // Filter orders
        function filterOrders(type) {
            const searchInput = document.getElementById(`${type}-search-input`).value.toLowerCase();
            const statusFilter = document.getElementById(`${type}-status-filter`).value;
            
            let baseOrders;
            if (type === 'active') {
                baseOrders = allOrders.filter(order => 
                    ['Ù…Ø¹Ø§ÙŠÙ†Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„', 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'].includes(order.orderStatus)
                );
            } else {
                baseOrders = allOrders.filter(order => 
                    ['Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'].includes(order.orderStatus)
                );
            }
            
            let filteredOrders = baseOrders.filter(order => {
                const matchesSearch = !searchInput || 
                    order.customerName.toLowerCase().includes(searchInput) ||
                    order.orderNumber.toLowerCase().includes(searchInput) ||
                    order.customerId.includes(searchInput) ||
                    order.area.toLowerCase().includes(searchInput);
                
                const matchesStatus = !statusFilter || order.orderStatus === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            if (type === 'active') {
                displayActiveOrders(filteredOrders);
            } else {
                displayCompletedOrders(filteredOrders);
            }
        }
        
        // Open order management modal
        function openOrderModal(orderId) {
            const order = allOrders.find(o => o.id == orderId) || localOrders.find(o => o.id == orderId);
            if (!order) return;
            
            const modalContent = document.getElementById('modal-content');
            
            if (['Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'].includes(order.orderStatus)) {
                // View only for completed orders
                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${order.orderNumber}</div>
                            <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName}</div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerId}</div>
                            <div><strong>Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${order.serviceType}</div>
                            <div><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${order.area}</div>
                            <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${order.visitDate}</div>
                            <div><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${order.finalPrice || order.initialPrice} Ø¯.Ùƒ</div>
                            <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusClass(order.orderStatus)}">${order.orderStatus}</span></div>
                        </div>
                        
                        ${order.customerRating > 0 ? `
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h4 class="font-semibold mb-2">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„:</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-500 text-xl">${'â˜…'.repeat(order.customerRating)}${'â˜†'.repeat(5-order.customerRating)}</span>
                                    <span class="text-gray-600">(${order.customerRating}/5)</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${order.cancellationReason ? `
                            <div class="p-4 bg-red-50 rounded-lg">
                                <h4 class="font-semibold mb-2 text-red-800">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:</h4>
                                <p class="text-red-700">${order.cancellationReason}</p>
                            </div>
                        ` : ''}
                        
                        ${order.customerNotes ? `
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-semibold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</h4>
                                <p>${order.customerNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Management interface for active orders
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${order.orderNumber}</div>
                            <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName}</div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerId}</div>
                            <div><strong>Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${order.serviceType}</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                                <select id="order-status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="Ù…Ø¹Ø§ÙŠÙ†Ø©" ${order.orderStatus === 'Ù…Ø¹Ø§ÙŠÙ†Ø©' ? 'selected' : ''}>Ù…Ø¹Ø§ÙŠÙ†Ø©</option>
                                    <option value="Ù…ÙˆØ§ÙÙ‚" ${order.orderStatus === 'Ù…ÙˆØ§ÙÙ‚' ? 'selected' : ''}>Ù…ÙˆØ§ÙÙ‚</option>
                                    <option value="Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„" ${order.orderStatus === 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„' ? 'selected' : ''}>Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„</option>
                                    <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ" ${order.orderStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ' ? 'selected' : ''}>Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ</option>
                                    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" ${order.orderStatus === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' ? 'selected' : ''}>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„" ${order.orderStatus === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="Ù…Ù„ØºÙŠ" ${order.orderStatus === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ø¯.Ùƒ)</label>
                                    <input type="number" id="initial-price-input" value="${order.initialPrice}" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
                                    <input type="number" id="discount-input" value="${order.discountPercentage || 0}" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¯.Ùƒ)</label>
                                <input type="number" id="final-price-input" value="${order.finalPrice || order.initialPrice}" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <div id="cancellation-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</label>
                                <select id="cancellation-reason" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                                    <option value="">Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</option>
                                    <option value="Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„ÙˆÙ‚Øª">Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„ÙˆÙ‚Øª</option>
                                    <option value="Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¶Ø§ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±">Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¶Ø§ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±</option>
                                    <option value="ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø¸Ø±ÙˆÙ">ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø¸Ø±ÙˆÙ</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                                <input type="text" id="custom-cancellation" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨..." class="w-full px-3 py-2 border border-gray-300 rounded-lg hidden">
                            </div>
                            
                            <div id="rating-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <div class="star-rating mb-3">
                                    <span class="star" data-rating="1">â˜…</span>
                                    <span class="star" data-rating="2">â˜…</span>
                                    <span class="star" data-rating="3">â˜…</span>
                                    <span class="star" data-rating="4">â˜…</span>
                                    <span class="star" data-rating="5">â˜…</span>
                                </div>
                                <textarea id="rating-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="updateOrder(${order.id})" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨
                            </button>
                            <button onclick="copyOrderToClipboard(${order.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                ğŸ“‹ Ù†Ø³Ø® Ù„Ù„Ø´ÙŠØª
                            </button>
                            <button onclick="closeModal()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners for the modal
                setupModalEventListeners(order);
            }
            
            document.getElementById('order-modal').classList.remove('hidden');
        }
        
        // Setup modal event listeners
        function setupModalEventListeners(order) {
            // Status change handler
            document.getElementById('order-status-select').addEventListener('change', function() {
                const status = this.value;
                const cancellationSection = document.getElementById('cancellation-section');
                const ratingSection = document.getElementById('rating-section');
                
                if (status === 'Ù…Ù„ØºÙŠ') {
                    cancellationSection.classList.remove('hidden');
                    ratingSection.classList.add('hidden');
                } else if (status === 'Ù…ÙƒØªÙ…Ù„') {
                    ratingSection.classList.remove('hidden');
                    cancellationSection.classList.add('hidden');
                } else {
                    cancellationSection.classList.add('hidden');
                    ratingSection.classList.add('hidden');
                }
            });
            
            // Discount calculation
            document.getElementById('discount-input').addEventListener('input', function() {
                const initialPrice = parseFloat(document.getElementById('initial-price-input').value) || 0;
                const discount = parseFloat(this.value) || 0;
                const finalPrice = initialPrice * (1 - discount / 100);
                document.getElementById('final-price-input').value = finalPrice.toFixed(1);
            });
            
            // Cancellation reason handler
            document.getElementById('cancellation-reason').addEventListener('change', function() {
                const customInput = document.getElementById('custom-cancellation');
                if (this.value === 'Ø£Ø®Ø±Ù‰') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            });
            
            // Star rating handler
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.querySelectorAll('.star').forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            // Set initial rating if exists
            if (order.customerRating > 0) {
                document.querySelectorAll('.star').forEach((s, index) => {
                    if (index < order.customerRating) {
                        s.classList.add('active');
                    }
                });
            }
        }
        
        // Update order
        function updateOrder(orderId) {
            const status = document.getElementById('order-status-select').value;
            const initialPrice = document.getElementById('initial-price-input').value;
            const discount = document.getElementById('discount-input').value;
            const finalPrice = document.getElementById('final-price-input').value;
            
            let cancellationReason = '';
            if (status === 'Ù…Ù„ØºÙŠ') {
                const reasonSelect = document.getElementById('cancellation-reason').value;
                if (reasonSelect === 'Ø£Ø®Ø±Ù‰') {
                    cancellationReason = document.getElementById('custom-cancellation').value;
                } else {
                    cancellationReason = reasonSelect;
                }
            }
            
            let rating = 0;
            let ratingNotes = '';
            if (status === 'Ù…ÙƒØªÙ…Ù„') {
                rating = document.querySelectorAll('.star.active').length;
                ratingNotes = document.getElementById('rating-notes').value;
            }
            
            // Update local order if it exists
            const localOrderIndex = localOrders.findIndex(o => o.id == orderId);
            if (localOrderIndex !== -1) {
                localOrders[localOrderIndex] = {
                    ...localOrders[localOrderIndex],
                    orderStatus: status,
                    initialPrice: initialPrice,
                    discountPercentage: discount,
                    finalPrice: finalPrice,
                    cancellationReason: cancellationReason,
                    customerRating: rating,
                    ratingNotes: ratingNotes
                };
                localStorage.setItem('localOrders', JSON.stringify(localOrders));
                displayLocalOrders();
            }
            
            closeModal();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }
        
        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                orderNumber: document.getElementById('order-number').value,
                customerId: document.getElementById('customer-id').value,
                customerName: document.getElementById('customer-name').value,
                area: document.getElementById('area').value,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('house-number').value,
                floor: document.getElementById('floor').value,
                housingType: document.getElementById('housing-type').value,
                serviceType: document.getElementById('service-type').value,
                visitDate: document.getElementById('visit-date').value,
                visitTime: document.getElementById('visit-time').value,
                initialPrice: document.getElementById('initial-price').value,
                finalPrice: document.getElementById('initial-price').value,
                customerNotes: document.getElementById('customer-notes').value,
                orderStatus: 'Ù…Ø¹Ø§ÙŠÙ†Ø©',
                paymentStatus: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                createdAt: new Date().toLocaleString('ar-SA')
            };
            
            localOrders.push(formData);
            localStorage.setItem('localOrders', JSON.stringify(localOrders));
            
            document.getElementById('new-order-form').reset();
            document.getElementById('new-order-section').classList.add('hidden');
            document.getElementById('customer-search').value = '';
            displayLocalOrders();
            showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }
        
        // Display local orders
        function displayLocalOrders() {
            const container = document.getElementById('local-orders-list');
            if (localOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ©</p>';
                return;
            }
            
            container.innerHTML = localOrders.map(order => `
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${order.customerName}</h4>
                            <p class="text-sm text-gray-600">${order.serviceType} - ${order.finalPrice || order.initialPrice} Ø¯.Ùƒ</p>
                            <p class="text-xs text-gray-500">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${order.createdAt}</p>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                                ${order.orderStatus}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openOrderModal(${order.id})" class="text-blue-500 hover:text-blue-700">
                                âš™ï¸
                            </button>
                            <button onclick="removeLocalOrder(${order.id})" class="text-red-500 hover:text-red-700">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Remove local order
        function removeLocalOrder(id) {
            localOrders = localOrders.filter(order => order.id !== id);
            localStorage.setItem('localOrders', JSON.stringify(localOrders));
            displayLocalOrders();
            showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨', 'info');
        }
        
        // Copy specific order to clipboard
        function copyOrderToClipboard(orderId) {
            const order = allOrders.find(o => o.id == orderId) || localOrders.find(o => o.id == orderId);
            if (!order) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨', 'error');
                return;
            }
            
            // Get current values from modal if it's open
            const statusSelect = document.getElementById('order-status-select');
            const initialPriceInput = document.getElementById('initial-price-input');
            const discountInput = document.getElementById('discount-input');
            const finalPriceInput = document.getElementById('final-price-input');
            const cancellationReasonSelect = document.getElementById('cancellation-reason');
            const customCancellationInput = document.getElementById('custom-cancellation');
            const ratingNotesInput = document.getElementById('rating-notes');
            
            let updatedOrder = { ...order };
            
            if (statusSelect) {
                updatedOrder.orderStatus = statusSelect.value;
                updatedOrder.initialPrice = initialPriceInput.value;
                updatedOrder.discountPercentage = discountInput.value || 0;
                updatedOrder.finalPrice = finalPriceInput.value;
                
                if (statusSelect.value === 'Ù…Ù„ØºÙŠ') {
                    const reasonSelect = cancellationReasonSelect.value;
                    if (reasonSelect === 'Ø£Ø®Ø±Ù‰') {
                        updatedOrder.cancellationReason = customCancellationInput.value;
                    } else {
                        updatedOrder.cancellationReason = reasonSelect;
                    }
                }
                
                if (statusSelect.value === 'Ù…ÙƒØªÙ…Ù„') {
                    updatedOrder.customerRating = document.querySelectorAll('.star.active').length;
                    updatedOrder.ratingNotes = ratingNotesInput.value;
                }
            }
            
            const orderRow = [
                updatedOrder.orderNumber, updatedOrder.customerId, updatedOrder.customerName, updatedOrder.area,
                updatedOrder.street || '', updatedOrder.houseNumber || '', updatedOrder.floor || '', 
                updatedOrder.housingType || '', '', updatedOrder.serviceType, updatedOrder.visitDate, 
                updatedOrder.visitTime || '', '', '', updatedOrder.initialPrice, 
                updatedOrder.discountPercentage || 0, updatedOrder.finalPrice || updatedOrder.initialPrice,
                updatedOrder.orderStatus, updatedOrder.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', 
                updatedOrder.cancellationReason || '', updatedOrder.customerRating || 0, 
                updatedOrder.customerNotes || '', updatedOrder.ratingNotes || '', 
                updatedOrder.createdAt || new Date().toLocaleString('ar-SA')
            ];
            
            const csvContent = orderRow.join('\t');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                showNotification('ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Google Sheets', 'success');
            }).catch(() => {
                showNotification('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            });
        }
        
        // Copy local orders to clipboard
        function copyToClipboard() {
            if (localOrders.length === 0) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù†Ø³Ø®', 'warning');
                return;
            }
            
            const headers = [
                'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'Ø§Ù„Ø´Ø§Ø±Ø¹',
                'Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„', 'Ø§Ù„Ø¯ÙˆØ±', 'Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©', 'ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©', 'ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹',
                'Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'
            ];
            
            const rows = localOrders.map(order => [
                order.orderNumber, order.customerId, order.customerName, order.area,
                order.street, order.houseNumber, order.floor, order.housingType, '',
                order.serviceType, order.visitDate, order.visitTime, '',
                '', order.initialPrice, order.discountPercentage || 0, order.finalPrice || order.initialPrice,
                order.orderStatus, order.paymentStatus, order.cancellationReason || '',
                order.customerRating || 0, order.customerNotes, order.ratingNotes || '', order.createdAt
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join('\t')).join('\n');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Google Sheets', 'success');
            }).catch(() => {
                showNotification('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            });
        }
        
        // Update research data
        function updateResearchData() {
            // Service statistics
            const serviceStats = {};
            allOrders.forEach(order => {
                serviceStats[order.serviceType] = (serviceStats[order.serviceType] || 0) + 1;
            });
            
            document.getElementById('service-stats').innerHTML = Object.entries(serviceStats)
                .sort(([,a], [,b]) => b - a)
                .map(([service, count]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">${service}</span>
                        <span class="font-semibold text-blue-600">${count}</span>
                    </div>
                `).join('');
            
            // Area statistics
            const areaStats = {};
            allOrders.forEach(order => {
                areaStats[order.area] = (areaStats[order.area] || 0) + 1;
            });
            
            document.getElementById('area-stats').innerHTML = Object.entries(areaStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([area, count]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">${area}</span>
                        <span class="font-semibold text-green-600">${count}</span>
                    </div>
                `).join('');
            
            // Rating statistics
            const ratings = allOrders.filter(order => order.customerRating > 0);
            const avgRating = ratings.length > 0 ? 
                (ratings.reduce((sum, order) => sum + order.customerRating, 0) / ratings.length).toFixed(1) : 0;
            
            document.getElementById('rating-stats').innerHTML = `
                <div class="text-center p-6">
                    <div class="text-4xl font-bold text-yellow-500 mb-2">${avgRating}</div>
                    <div class="text-yellow-500 text-2xl mb-2">${'â˜…'.repeat(Math.floor(avgRating))}${'â˜†'.repeat(5-Math.floor(avgRating))}</div>
                    <div class="text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† ${ratings.length} ØªÙ‚ÙŠÙŠÙ…</div>
                </div>
            `;
        }
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                button.classList.add('text-gray-600');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
            activeTab.classList.remove('text-gray-600');
        }
        
        // Refresh data manually
        function refreshData() {
            fetchData();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        }
        
        // Get status class for styling
        function getStatusClass(status) {
            switch (status) {
                case 'Ù…Ø¹Ø§ÙŠÙ†Ø©':
                    return 'bg-purple-100 text-purple-800';
                case 'Ù…ÙˆØ§ÙÙ‚':
                    return 'bg-cyan-100 text-cyan-800';
                case 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„':
                    return 'bg-green-100 text-green-800';
                case 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ':
                    return 'bg-yellow-100 text-yellow-800';
                case 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹':
                    return 'bg-orange-100 text-orange-800';
                case 'Ù…ÙƒØªÙ…Ù„':
                    return 'bg-emerald-100 text-emerald-800';
                case 'Ù…Ù„ØºÙŠ':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ad8328a0547ccf',t:'MTc1OTg0MTMwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
