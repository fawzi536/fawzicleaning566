<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطلبات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-preview { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .status-approved { background: linear-gradient(135deg, #10b981, #059669); }
        .status-paid { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .status-partial { background: linear-gradient(135deg, #f97316, #ea580c); }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-cancelled { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .status-completed { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-800 text-center">🏠 نظام إدارة الطلبات</h1>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8 space-x-reverse">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    📊 لوحة التحكم
                </button>
                <button onclick="showTab('search')" id="tab-search" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    🔍 بحث وإضافة طلب
                </button>
                <button onclick="showTab('active')" id="tab-active" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    ⏳ قيد التنفيذ
                </button>
                <button onclick="showTab('completed')" id="tab-completed" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    ✅ المكتملة
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">إجمالي الطلبات</p>
                            <p id="total-orders" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-2xl">📋</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">مدفوعة</p>
                            <p id="paid-orders" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-2xl">💰</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">قيد التنفيذ</p>
                            <p id="active-orders" class="text-3xl font-bold text-yellow-600">0</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <span class="text-2xl">⏳</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">مكتملة</p>
                            <p id="completed-orders" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <span class="text-2xl">✅</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📈 إحصائيات سريعة</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600" id="today-orders">0</p>
                        <p class="text-gray-600">طلبات اليوم</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600" id="total-revenue">0 د.ك</p>
                        <p class="text-gray-600">إجمالي الإيرادات</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-600" id="avg-rating">0</p>
                        <p class="text-gray-600">متوسط التقييم</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Add Order Tab -->
        <div id="search-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🔍 البحث عن عميل</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="customer-search" placeholder="أدخل رقم العميل (رقم الجوال)" 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="searchCustomer()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        بحث
                    </button>
                </div>
                <div id="customer-history" class="hidden"></div>
            </div>

            <div id="add-order-form" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">➕ إضافة طلب جديد</h3>
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="order-number">
                    <input type="hidden" id="customer-number">
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">اسم العميل</label>
                        <input type="text" id="customer-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">المنطقة</label>
                        <input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الشارع</label>
                        <input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">رقم المنزل</label>
                        <input type="text" id="house-number" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الدور</label>
                        <input type="text" id="floor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">نوع السكن</label>
                        <select id="housing-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر نوع السكن</option>
                            <option value="شقة">شقة</option>
                            <option value="بيت">بيت</option>
                            <option value="فيلا">فيلا</option>
                            <option value="مكتب">مكتب</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">ملاحظات الموقع</label>
                        <textarea id="location-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">نوع الخدمة</label>
                        <select id="service-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر نوع الخدمة</option>
                            <option value="تنظيف عام">تنظيف عام</option>
                            <option value="تنظيف عميق">تنظيف عميق</option>
                            <option value="تنظيف شقق">تنظيف شقق</option>
                            <option value="تنظيف مكاتب">تنظيف مكاتب</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">تاريخ الزيارة</label>
                        <input type="date" id="visit-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">وقت الزيارة</label>
                        <input type="time" id="visit-time" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">تكرار الخدمة</label>
                        <select id="service-frequency" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر التكرار</option>
                            <option value="مرة واحدة">مرة واحدة</option>
                            <option value="أسبوعي">أسبوعي</option>
                            <option value="شهري">شهري</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">طريقة الدفع</label>
                        <select id="payment-method" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر طريقة الدفع</option>
                            <option value="نقدي">نقدي</option>
                            <option value="كي نت">كي نت</option>
                            <option value="تحويل بنكي">تحويل بنكي</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">المبلغ المبدئي (د.ك)</label>
                        <input type="number" id="initial-amount" step="0.1" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">ملاحظات العميل</label>
                        <textarea id="customer-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                            إضافة طلب (معاينة)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Active Orders Tab -->
        <div id="active-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">⏳ الطلبات قيد التنفيذ</h3>
                <div id="active-orders-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Completed Orders Tab -->
        <div id="completed-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">✅ الطلبات المكتملة</h3>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Order Management Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">إدارة الطلب</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // Global variables
        let orders = [];
        let nextOrderNumber = 1;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            showTab('dashboard');
            fetchOrders();
            setInterval(fetchOrders, 60000); // Update every minute
        });

        // Fetch orders from Google Sheets
        async function fetchOrders() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI/gviz/tq?tqx=out:json');
                const text = await response.text();
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                orders = data.table.rows.map((row, index) => {
                    const cells = row.c || [];
                    return {
                        orderNumber: cells[0]?.v || (index + 1),
                        customerNumber: cells[1]?.v || '',
                        customerName: cells[2]?.v || '',
                        area: cells[3]?.v || '',
                        street: cells[4]?.v || '',
                        houseNumber: cells[5]?.v || '',
                        floor: cells[6]?.v || '',
                        housingType: cells[7]?.v || '',
                        locationNotes: cells[8]?.v || '',
                        serviceType: cells[9]?.v || '',
                        visitDate: cells[10]?.v || '',
                        visitTime: cells[11]?.v || '',
                        serviceFrequency: cells[12]?.v || '',
                        paymentMethod: cells[13]?.v || '',
                        totalAmount: cells[14]?.v || 0,
                        paymentStatus: cells[15]?.v || 'معاينة',
                        teamName: cells[16]?.v || '',
                        bookingStatus: cells[17]?.v || 'معاينة',
                        departureTime: cells[18]?.v || '',
                        customerNotes: cells[19]?.v || '',
                        teamNotes: cells[20]?.v || '',
                        customerRating: cells[21]?.v || 0,
                        orderCoordinator: cells[22]?.v || ''
                    };
                });

                nextOrderNumber = Math.max(...orders.map(o => parseInt(o.orderNumber) || 0)) + 1;
                updateDashboard();
                displayActiveOrders();
                displayCompletedOrders();
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-500');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('text-blue-600', 'border-blue-500');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600', 'border-transparent');
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalOrders = orders.length;
            const paidOrders = orders.filter(o => o.paymentStatus === 'مدفوع كامل').length;
            const activeOrders = orders.filter(o => ['معاينة', 'موافق', 'غير مدفوع', 'مدفوع جزئي'].includes(o.bookingStatus)).length;
            const completedOrders = orders.filter(o => ['مكتمل', 'ملغي'].includes(o.bookingStatus)).length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.visitDate === today).length;
            
            const totalRevenue = orders
                .filter(o => o.paymentStatus === 'مدفوع كامل')
                .reduce((sum, o) => sum + (parseFloat(o.totalAmount) || 0), 0);
            
            const ratings = orders.filter(o => o.customerRating > 0);
            const avgRating = ratings.length > 0 
                ? (ratings.reduce((sum, o) => sum + o.customerRating, 0) / ratings.length).toFixed(1)
                : 0;

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('paid-orders').textContent = paidOrders;
            document.getElementById('active-orders').textContent = activeOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            document.getElementById('today-orders').textContent = todayOrders;
            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(1) + ' د.ك';
            document.getElementById('avg-rating').textContent = avgRating;
        }

        // Search for customer
        function searchCustomer() {
            const customerNumber = document.getElementById('customer-search').value.trim();
            if (!customerNumber) {
                alert('يرجى إدخال رقم العميل');
                return;
            }

            const customerOrders = orders.filter(o => o.customerNumber === customerNumber);
            const historyDiv = document.getElementById('customer-history');
            
            if (customerOrders.length > 0) {
                historyDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">📋 طلبات العميل السابقة (${customerOrders.length})</h4>
                    <div class="space-y-3 mb-4">
                        ${customerOrders.map(order => `
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold">طلب #${order.orderNumber}</p>
                                        <p class="text-sm text-gray-600">${order.serviceType} - ${order.visitDate}</p>
                                        <p class="text-sm text-gray-600">المبلغ: ${order.totalAmount} د.ك</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusClass(order.bookingStatus)}">
                                        ${order.bookingStatus}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                historyDiv.classList.remove('hidden');
                
                // Pre-fill customer info from last order
                const lastOrder = customerOrders[customerOrders.length - 1];
                document.getElementById('customer-name').value = lastOrder.customerName;
                document.getElementById('area').value = lastOrder.area;
                document.getElementById('street').value = lastOrder.street;
                document.getElementById('house-number').value = lastOrder.houseNumber;
                document.getElementById('floor').value = lastOrder.floor;
                document.getElementById('housing-type').value = lastOrder.housingType;
                document.getElementById('location-notes').value = lastOrder.locationNotes;
            } else {
                historyDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-yellow-800">🆕 عميل جديد - لا توجد طلبات سابقة</p>
                    </div>
                `;
                historyDiv.classList.remove('hidden');
            }

            document.getElementById('customer-number').value = customerNumber;
            document.getElementById('order-number').value = nextOrderNumber;
            document.getElementById('add-order-form').classList.remove('hidden');
        }

        // Handle new order form submission
        document.getElementById('new-order-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newOrder = {
                orderNumber: document.getElementById('order-number').value,
                customerNumber: document.getElementById('customer-number').value,
                customerName: document.getElementById('customer-name').value,
                area: document.getElementById('area').value,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('house-number').value,
                floor: document.getElementById('floor').value,
                housingType: document.getElementById('housing-type').value,
                locationNotes: document.getElementById('location-notes').value,
                serviceType: document.getElementById('service-type').value,
                visitDate: document.getElementById('visit-date').value,
                visitTime: document.getElementById('visit-time').value,
                serviceFrequency: document.getElementById('service-frequency').value,
                paymentMethod: document.getElementById('payment-method').value,
                totalAmount: document.getElementById('initial-amount').value,
                paymentStatus: 'غير مدفوع',
                teamName: '',
                bookingStatus: 'معاينة',
                departureTime: '',
                customerNotes: document.getElementById('customer-notes').value,
                teamNotes: '',
                customerRating: 0,
                orderCoordinator: ''
            };

            orders.push(newOrder);
            nextOrderNumber++;
            
            alert('تم إضافة الطلب بنجاح! سيتم عرضه في قائمة الطلبات قيد التنفيذ.');
            
            // Reset form
            document.getElementById('new-order-form').reset();
            document.getElementById('add-order-form').classList.add('hidden');
            document.getElementById('customer-history').classList.add('hidden');
            document.getElementById('customer-search').value = '';
            
            updateDashboard();
            displayActiveOrders();
            
            // Copy order data to clipboard for Google Sheets
            copyOrderToClipboard(newOrder);
        });

        // Copy order data to clipboard
        function copyOrderToClipboard(order) {
            const orderData = [
                order.orderNumber,
                order.customerNumber,
                order.customerName,
                order.area,
                order.street,
                order.houseNumber,
                order.floor,
                order.housingType,
                order.locationNotes,
                order.serviceType,
                order.visitDate,
                order.visitTime,
                order.serviceFrequency,
                order.paymentMethod,
                order.totalAmount,
                order.paymentStatus,
                order.teamName,
                order.bookingStatus,
                order.departureTime,
                order.customerNotes,
                order.teamNotes,
                order.customerRating,
                order.orderCoordinator
            ].join('\t');

            navigator.clipboard.writeText(orderData).then(() => {
                alert('تم نسخ بيانات الطلب! يمكنك لصقها في Google Sheets الآن.');
            });
        }

        // Display active orders
        function displayActiveOrders() {
            const activeOrders = orders.filter(o => ['معاينة', 'موافق', 'غير مدفوع', 'مدفوع جزئي'].includes(o.bookingStatus));
            const container = document.getElementById('active-orders-list');
            
            if (activeOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">لا توجد طلبات قيد التنفيذ</p>';
                return;
            }

            container.innerHTML = activeOrders.map(order => createOrderCard(order)).join('');
        }

        // Display completed orders
        function displayCompletedOrders() {
            const completedOrders = orders.filter(o => ['مكتمل', 'ملغي'].includes(o.bookingStatus));
            const container = document.getElementById('completed-orders-list');
            
            if (completedOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">لا توجد طلبات مكتملة</p>';
                return;
            }

            container.innerHTML = completedOrders.map(order => createOrderCard(order)).join('');
        }

        // Create order card HTML
        function createOrderCard(order) {
            const statusClass = getStatusClass(order.bookingStatus);
            const paymentClass = getPaymentStatusClass(order.paymentStatus);
            
            return `
                <div class="order-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">طلب #${order.orderNumber}</h4>
                            <p class="text-gray-600">${order.customerName} - ${order.customerNumber}</p>
                            <p class="text-sm text-gray-500">${order.serviceType}</p>
                        </div>
                        <div class="text-left">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass} block mb-2">
                                ${order.bookingStatus}
                            </span>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${paymentClass}">
                                ${order.paymentStatus}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <span class="text-gray-500">التاريخ:</span>
                            <span class="font-medium">${order.visitDate}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">الوقت:</span>
                            <span class="font-medium">${order.visitTime}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">المنطقة:</span>
                            <span class="font-medium">${order.area}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">المبلغ:</span>
                            <span class="font-medium">${order.totalAmount} د.ك</span>
                        </div>
                    </div>
                    
                    ${order.customerRating > 0 ? `
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">التقييم:</span>
                            <span class="text-yellow-500">${'★'.repeat(order.customerRating)}${'☆'.repeat(5-order.customerRating)}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="manageOrder('${order.orderNumber}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            إدارة الطلب
                        </button>
                        <button onclick="copyOrderToClipboard(${JSON.stringify(order).replace(/"/g, '&quot;')})" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            نسخ البيانات
                        </button>
                    </div>
                </div>
            `;
        }

        // Get status class for styling
        function getStatusClass(status) {
            const classes = {
                'معاينة': 'bg-yellow-100 text-yellow-800',
                'موافق': 'bg-green-100 text-green-800',
                'غير مدفوع': 'bg-red-100 text-red-800',
                'مدفوع جزئي': 'bg-orange-100 text-orange-800',
                'مكتمل': 'bg-purple-100 text-purple-800',
                'ملغي': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Get payment status class
        function getPaymentStatusClass(status) {
            const classes = {
                'مدفوع كامل': 'bg-green-100 text-green-800',
                'مدفوع جزئي': 'bg-orange-100 text-orange-800',
                'غير مدفوع': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Manage order (open modal)
        function manageOrder(orderNumber) {
            const order = orders.find(o => o.orderNumber == orderNumber);
            if (!order) return;

            const modal = document.getElementById('order-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">معلومات الطلب #${order.orderNumber}</h4>
                        <p><strong>العميل:</strong> ${order.customerName} (${order.customerNumber})</p>
                        <p><strong>الخدمة:</strong> ${order.serviceType}</p>
                        <p><strong>التاريخ:</strong> ${order.visitDate} - ${order.visitTime}</p>
                        <p><strong>العنوان:</strong> ${order.area}, ${order.street}, ${order.houseNumber}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">حالة الحجز</label>
                            <select id="modal-booking-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="معاينة" ${order.bookingStatus === 'معاينة' ? 'selected' : ''}>معاينة</option>
                                <option value="موافق" ${order.bookingStatus === 'موافق' ? 'selected' : ''}>موافق</option>
                                <option value="مكتمل" ${order.bookingStatus === 'مكتمل' ? 'selected' : ''}>مكتمل</option>
                                <option value="ملغي" ${order.bookingStatus === 'ملغي' ? 'selected' : ''}>ملغي</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">حالة الدفع</label>
                            <select id="modal-payment-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="غير مدفوع" ${order.paymentStatus === 'غير مدفوع' ? 'selected' : ''}>غير مدفوع</option>
                                <option value="مدفوع جزئي" ${order.paymentStatus === 'مدفوع جزئي' ? 'selected' : ''}>مدفوع جزئي</option>
                                <option value="مدفوع كامل" ${order.paymentStatus === 'مدفوع كامل' ? 'selected' : ''}>مدفوع كامل</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">المبلغ النهائي (د.ك)</label>
                            <input type="number" id="modal-final-amount" step="0.1" value="${order.totalAmount}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">اسم الفريق</label>
                            <input type="text" id="modal-team-name" value="${order.teamName}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div id="cancellation-reason-div" class="hidden">
                        <label class="block text-gray-700 font-semibold mb-2">سبب الإلغاء</label>
                        <select id="modal-cancellation-reason" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                            <option value="">اختر سبب الإلغاء</option>
                            <option value="عدم توفر العميل">عدم توفر العميل</option>
                            <option value="تغيير الموعد">تغيير الموعد</option>
                            <option value="عدم الرضا عن السعر">عدم الرضا عن السعر</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                        <input type="text" id="modal-other-reason" placeholder="اكتب السبب..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg hidden">
                    </div>
                    
                    <div id="rating-div" class="hidden">
                        <label class="block text-gray-700 font-semibold mb-2">تقييم العميل</label>
                        <div class="flex gap-2 mb-2">
                            ${[1,2,3,4,5].map(i => `
                                <button type="button" onclick="setRating(${i})" 
                                        class="rating-star text-2xl ${order.customerRating >= i ? 'text-yellow-500' : 'text-gray-300'}" 
                                        data-rating="${i}">★</button>
                            `).join('')}
                        </div>
                        <textarea id="modal-rating-notes" placeholder="ملاحظات التقييم..." 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="2">${order.teamNotes}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ملاحظات الفريق</label>
                        <textarea id="modal-team-notes" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                                  rows="3">${order.teamNotes}</textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="updateOrder('${order.orderNumber}')" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold">
                            حفظ التغييرات
                        </button>
                        <button onclick="closeModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold">
                            إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Add event listeners
            document.getElementById('modal-booking-status').addEventListener('change', function() {
                const status = this.value;
                const cancellationDiv = document.getElementById('cancellation-reason-div');
                const ratingDiv = document.getElementById('rating-div');
                
                if (status === 'ملغي') {
                    cancellationDiv.classList.remove('hidden');
                    ratingDiv.classList.add('hidden');
                } else if (status === 'مكتمل') {
                    cancellationDiv.classList.add('hidden');
                    ratingDiv.classList.remove('hidden');
                } else {
                    cancellationDiv.classList.add('hidden');
                    ratingDiv.classList.add('hidden');
                }
            });
            
            document.getElementById('modal-cancellation-reason').addEventListener('change', function() {
                const otherInput = document.getElementById('modal-other-reason');
                if (this.value === 'أخرى') {
                    otherInput.classList.remove('hidden');
                } else {
                    otherInput.classList.add('hidden');
                }
            });
        }

        // Set rating
        function setRating(rating) {
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-500');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.add('text-gray-300');
                    star.classList.remove('text-yellow-500');
                }
            });
        }

        // Update order
        function updateOrder(orderNumber) {
            const orderIndex = orders.findIndex(o => o.orderNumber == orderNumber);
            if (orderIndex === -1) return;

            const bookingStatus = document.getElementById('modal-booking-status').value;
            const paymentStatus = document.getElementById('modal-payment-status').value;
            const finalAmount = document.getElementById('modal-final-amount').value;
            const teamName = document.getElementById('modal-team-name').value;
            const teamNotes = document.getElementById('modal-team-notes').value;
            
            let cancellationReason = '';
            if (bookingStatus === 'ملغي') {
                const reason = document.getElementById('modal-cancellation-reason').value;
                if (reason === 'أخرى') {
                    cancellationReason = document.getElementById('modal-other-reason').value;
                } else {
                    cancellationReason = reason;
                }
            }
            
            let customerRating = 0;
            if (bookingStatus === 'مكتمل') {
                const selectedStar = document.querySelector('.rating-star.text-yellow-500:last-of-type');
                if (selectedStar) {
                    customerRating = parseInt(selectedStar.dataset.rating);
                }
            }

            // Update order
            orders[orderIndex] = {
                ...orders[orderIndex],
                bookingStatus,
                paymentStatus,
                totalAmount: finalAmount,
                teamName,
                teamNotes: bookingStatus === 'ملغي' ? cancellationReason : teamNotes,
                customerRating,
                departureTime: bookingStatus === 'مكتمل' ? new Date().toLocaleTimeString('ar-SA') : ''
            };

            closeModal();
            updateDashboard();
            displayActiveOrders();
            displayCompletedOrders();
            
            // Copy updated order to clipboard
            copyOrderToClipboard(orders[orderIndex]);
            
            alert('تم تحديث الطلب بنجاح! تم نسخ البيانات المحدثة للحافظة.');
        }

        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
            document.getElementById('order-modal').classList.remove('flex');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98aea9d065e54e4e',t:'MTc1OTg1MzM3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
