<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطلبات المتطور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-cancelled { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-preview { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .status-approved { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .star-rating {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 24px;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #fbbf24;
        }

        .star:hover {
            color: #fbbf24;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">🏠 نظام إدارة الطلبات المتطور</h1>
            <p class="text-gray-600 text-center mt-2">إدارة شاملة لطلبات الخدمات المنزلية مع تتبع حالة الطلبات</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-2xl shadow-lg mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button px-6 py-4 font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                    📊 لوحة التحكم
                </button>
                <button onclick="showTab('active')" id="tab-active" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    🔄 قيد التنفيذ
                </button>
                <button onclick="showTab('completed')" id="tab-completed" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    ✅ مكتملة
                </button>
                <button onclick="showTab('add')" id="tab-add" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    ➕ طلب جديد
                </button>
                <button onclick="showTab('research')" id="tab-research" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    🔍 البحث والتحليل
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">جاري تحميل البيانات...</p>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100">إجمالي الطلبات</p>
                            <p id="total-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">📦</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100">معاينة</p>
                            <p id="preview-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">👁️</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-cyan-100">موافق عليها</p>
                            <p id="approved-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">✔️</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">مكتملة</p>
                            <p id="completed-orders" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="text-4xl">🎉</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-amber-100">إجمالي المبلغ</p>
                            <p id="total-amount" class="text-2xl font-bold">0 د.ك</p>
                        </div>
                        <div class="text-4xl">💎</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">آخر التحديثات</h3>
                <div id="recent-orders" class="space-y-4">
                    <!-- Recent orders will be populated here -->
                </div>
            </div>
        </div>

        <!-- Active Orders Tab -->
        <div id="active-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="active-search-input" placeholder="البحث في الطلبات النشطة..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="active-status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع الحالات النشطة</option>
                        <option value="معاينة">معاينة</option>
                        <option value="موافق">موافق</option>
                        <option value="مدفوع كامل">مدفوع كامل</option>
                        <option value="مدفوع جزئي">مدفوع جزئي</option>
                        <option value="غير مدفوع">غير مدفوع</option>
                    </select>
                    <button onclick="refreshData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                        🔄 تحديث
                    </button>
                </div>
            </div>
            
            <div id="active-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Active orders will be populated here -->
            </div>
        </div>

        <!-- Completed Orders Tab -->
        <div id="completed-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="completed-search-input" placeholder="البحث في الطلبات المكتملة..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="completed-status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع الحالات المكتملة</option>
                        <option value="مكتمل">مكتمل</option>
                        <option value="ملغي">ملغي</option>
                    </select>
                </div>
            </div>
            
            <div id="completed-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Completed orders will be populated here -->
            </div>
        </div>

        <!-- Add New Order Tab -->
        <div id="add-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <!-- Customer Search Section -->
                <div class="mb-8 p-6 bg-blue-50 rounded-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">🔍 البحث عن العميل</h3>
                    <div class="flex gap-4">
                        <input type="text" id="customer-search" placeholder="ادخل رقم العميل (رقم الجوال)..." 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <button onclick="searchCustomer()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                            بحث
                        </button>
                    </div>
                    
                    <div id="customer-history" class="mt-4 hidden">
                        <h4 class="font-semibold text-gray-800 mb-3">تاريخ العميل:</h4>
                        <div id="customer-orders-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Customer orders will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- New Order Form -->
                <div id="new-order-section" class="hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">➕ إضافة طلب جديد</h3>
                    
                    <form id="new-order-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">رقم الطلب (تلقائي)</label>
                                <input type="text" id="order-number" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">رقم العميل</label>
                                <input type="text" id="customer-id" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم العميل</label>
                                <input type="text" id="customer-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">المنطقة</label>
                                <input type="text" id="area" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الشارع</label>
                                <input type="text" id="street" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">رقم المنزل</label>
                                <input type="text" id="house-number" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الدور</label>
                                <input type="text" id="floor" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع السكن</label>
                                <select id="housing-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر نوع السكن</option>
                                    <option value="شقة">شقة</option>
                                    <option value="فيلا">فيلا</option>
                                    <option value="بيت شعبي">بيت شعبي</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع الخدمة</label>
                                <select id="service-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">اختر نوع الخدمة</option>
                                    <option value="تنظيف عام">تنظيف عام</option>
                                    <option value="تنظيف عميق">تنظيف عميق</option>
                                    <option value="تنظيف شقق">تنظيف شقق</option>
                                    <option value="تنظيف مكاتب">تنظيف مكاتب</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الزيارة</label>
                                <input type="date" id="visit-date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">وقت الزيارة</label>
                                <input type="time" id="visit-time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">السعر (د.ك)</label>
                                <input type="number" id="initial-price" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>

                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات العميل</label>
                            <textarea id="customer-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-xl hover:bg-purple-700 transition-colors font-semibold">
                                👁️ إنشاء طلب معاينة
                            </button>
                            <button type="button" onclick="copyToClipboard()" class="bg-green-600 text-white py-3 px-6 rounded-xl hover:bg-green-700 transition-colors font-semibold">
                                📋 نسخ للشيت
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="local-orders" class="mt-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">الطلبات المحلية (غير مرسلة)</h4>
                    <div id="local-orders-list" class="space-y-3">
                        <!-- Local orders will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Tab -->
        <div id="research-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">إحصائيات الخدمات</h3>
                    <div id="service-stats" class="space-y-3">
                        <!-- Service statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">إحصائيات المناطق</h3>
                    <div id="area-stats" class="space-y-3">
                        <!-- Area statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">متوسط التقييمات</h3>
                    <div id="rating-stats" class="space-y-3">
                        <!-- Rating statistics will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الطلبات الشهرية</h3>
                    <div id="monthly-stats" class="space-y-3">
                        <!-- Monthly statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Management Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">إدارة الطلب</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                
                <div id="modal-content">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let localOrders = JSON.parse(localStorage.getItem('localOrders') || '[]');
        let currentCustomerId = '';
        let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1000');
        
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI/gviz/tq?tqx=out:json';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            displayLocalOrders();
            
            // Auto-refresh every minute
            setInterval(fetchData, 60000);
            
            // Search and filter functionality
            document.getElementById('active-search-input').addEventListener('input', () => filterOrders('active'));
            document.getElementById('active-status-filter').addEventListener('change', () => filterOrders('active'));
            document.getElementById('completed-search-input').addEventListener('input', () => filterOrders('completed'));
            document.getElementById('completed-status-filter').addEventListener('change', () => filterOrders('completed'));
            
            // Form submission
            document.getElementById('new-order-form').addEventListener('submit', handleFormSubmit);
            
            // Customer search
            document.getElementById('customer-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomer();
                }
            });
        });
        
        // Generate automatic order number
        function generateOrderNumber() {
            orderCounter++;
            localStorage.setItem('orderCounter', orderCounter.toString());
            return `ORD-${orderCounter}`;
        }
        
        // Search for customer
        function searchCustomer() {
            const customerId = document.getElementById('customer-search').value.trim();
            if (!customerId) {
                showNotification('يرجى إدخال رقم العميل', 'warning');
                return;
            }
            
            currentCustomerId = customerId;
            
            // Find customer orders
            const customerOrders = allOrders.filter(order => order.customerId === customerId);
            
            if (customerOrders.length > 0) {
                displayCustomerHistory(customerOrders);
            } else {
                document.getElementById('customer-history').classList.add('hidden');
                showNotification('عميل جديد - لا توجد طلبات سابقة', 'info');
            }
            
            // Show new order section and populate customer ID
            document.getElementById('new-order-section').classList.remove('hidden');
            document.getElementById('customer-id').value = customerId;
            document.getElementById('order-number').value = generateOrderNumber();
            
            // Auto-fill customer name if exists
            if (customerOrders.length > 0) {
                document.getElementById('customer-name').value = customerOrders[0].customerName;
            }
        }
        
        // Display customer history
        function displayCustomerHistory(orders) {
            const container = document.getElementById('customer-orders-list');
            container.innerHTML = orders.map(order => `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">${order.orderNumber}</p>
                            <p class="text-sm text-gray-600">${order.serviceType} - ${order.area}</p>
                            <p class="text-sm text-gray-600">${order.visitDate}</p>
                        </div>
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">${order.totalAmount} د.ك</p>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                                ${order.orderStatus}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('customer-history').classList.remove('hidden');
        }
        
        // Fetch data from Google Sheets
        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // Parse Google Sheets JSON response
                const jsonString = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);
                
                if (data.table && data.table.rows) {
                    allOrders = data.table.rows.map((row, index) => {
                        const cells = row.c || [];
                        return {
                            id: index + 1,
                            orderNumber: cells[0]?.v || '',
                            customerId: cells[1]?.v || '',
                            customerName: cells[2]?.v || '',
                            area: cells[3]?.v || '',
                            street: cells[4]?.v || '',
                            houseNumber: cells[5]?.v || '',
                            floor: cells[6]?.v || '',
                            housingType: cells[7]?.v || '',
                            locationNotes: cells[8]?.v || '',
                            serviceType: cells[9]?.v || '',
                            visitDate: cells[10]?.v || '',
                            visitTime: cells[11]?.v || '',
                            serviceFrequency: cells[12]?.v || '',
                            paymentMethod: cells[13]?.v || '',
                            initialPrice: cells[14]?.v || 0,
                            discountPercentage: cells[15]?.v || 0,
                            finalPrice: cells[16]?.v || 0,
                            orderStatus: cells[17]?.v || 'معاينة',
                            paymentStatus: cells[18]?.v || 'غير مدفوع',
                            cancellationReason: cells[19]?.v || '',
                            customerRating: cells[20]?.v || 0,
                            customerNotes: cells[21]?.v || '',
                            teamNotes: cells[22]?.v || '',
                            createdAt: cells[23]?.v || ''
                        };
                    });
                }
                
                updateDashboard();
                displayActiveOrders();
                displayCompletedOrders();
                updateResearchData();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification('خطأ في تحميل البيانات', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Update dashboard statistics
        function updateDashboard() {
            const totalOrders = allOrders.length;
            const previewOrders = allOrders.filter(order => order.orderStatus === 'معاينة').length;
            const approvedOrders = allOrders.filter(order => order.orderStatus === 'موافق').length;
            const completedOrders = allOrders.filter(order => order.orderStatus === 'مكتمل').length;
            const totalAmount = allOrders.reduce((sum, order) => sum + (parseFloat(order.finalPrice) || parseFloat(order.initialPrice) || 0), 0);
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('preview-orders').textContent = previewOrders;
            document.getElementById('approved-orders').textContent = approvedOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            document.getElementById('total-amount').textContent = totalAmount.toFixed(1) + ' د.ك';
            
            // Display recent orders
            const recentOrders = allOrders.slice(-5).reverse();
            const recentOrdersContainer = document.getElementById('recent-orders');
            recentOrdersContainer.innerHTML = recentOrders.map(order => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${order.customerName}</p>
                        <p class="text-sm text-gray-600">${order.serviceType} - ${order.area}</p>
                    </div>
                    <div class="text-left">
                        <p class="font-semibold text-gray-800">${order.finalPrice || order.initialPrice} د.ك</p>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        // Display active orders
        function displayActiveOrders(orders = null) {
            const activeOrders = orders || allOrders.filter(order => 
                ['معاينة', 'موافق', 'مدفوع كامل', 'مدفوع جزئي', 'غير مدفوع'].includes(order.orderStatus)
            );
            
            const ordersGrid = document.getElementById('active-orders-grid');
            ordersGrid.innerHTML = activeOrders.map(order => `
                <div class="bg-white rounded-2xl shadow-lg p-6 card-hover fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${order.customerName}</h3>
                            <p class="text-sm text-gray-600">طلب رقم: ${order.orderNumber}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">📱 العميل:</span>
                            <span class="text-gray-800">${order.customerId}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">📍 المنطقة:</span>
                            <span class="text-gray-800">${order.area}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">🏠 الخدمة:</span>
                            <span class="text-gray-800">${order.serviceType}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">📅 التاريخ:</span>
                            <span class="text-gray-800">${order.visitDate}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">💰 السعر:</span>
                            <span class="text-gray-800 font-semibold">${order.finalPrice || order.initialPrice} د.ك</span>
                        </div>
                    </div>
                    
                    <button onclick="openOrderModal('${order.id}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        إدارة الطلب
                    </button>
                </div>
            `).join('');
        }
        
        // Display completed orders
        function displayCompletedOrders(orders = null) {
            const completedOrders = orders || allOrders.filter(order => 
                ['مكتمل', 'ملغي'].includes(order.orderStatus)
            );
            
            const ordersGrid = document.getElementById('completed-orders-grid');
            ordersGrid.innerHTML = completedOrders.map(order => `
                <div class="bg-white rounded-2xl shadow-lg p-6 card-hover fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${order.customerName}</h3>
                            <p class="text-sm text-gray-600">طلب رقم: ${order.orderNumber}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                            ${order.orderStatus}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">📱 العميل:</span>
                            <span class="text-gray-800">${order.customerId}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">🏠 الخدمة:</span>
                            <span class="text-gray-800">${order.serviceType}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">💰 السعر:</span>
                            <span class="text-gray-800 font-semibold">${order.finalPrice || order.initialPrice} د.ك</span>
                        </div>
                        ${order.customerRating > 0 ? `
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">⭐ التقييم:</span>
                                <span class="text-yellow-500">${'★'.repeat(order.customerRating)}${'☆'.repeat(5-order.customerRating)}</span>
                            </div>
                        ` : ''}
                        ${order.cancellationReason ? `
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">❌ السبب:</span>
                                <span class="text-red-600">${order.cancellationReason}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button onclick="openOrderModal('${order.id}')" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                        عرض التفاصيل
                    </button>
                </div>
            `).join('');
        }
        
        // Filter orders
        function filterOrders(type) {
            const searchInput = document.getElementById(`${type}-search-input`).value.toLowerCase();
            const statusFilter = document.getElementById(`${type}-status-filter`).value;
            
            let baseOrders;
            if (type === 'active') {
                baseOrders = allOrders.filter(order => 
                    ['معاينة', 'موافق', 'مدفوع كامل', 'مدفوع جزئي', 'غير مدفوع'].includes(order.orderStatus)
                );
            } else {
                baseOrders = allOrders.filter(order => 
                    ['مكتمل', 'ملغي'].includes(order.orderStatus)
                );
            }
            
            let filteredOrders = baseOrders.filter(order => {
                const matchesSearch = !searchInput || 
                    order.customerName.toLowerCase().includes(searchInput) ||
                    order.orderNumber.toLowerCase().includes(searchInput) ||
                    order.customerId.includes(searchInput) ||
                    order.area.toLowerCase().includes(searchInput);
                
                const matchesStatus = !statusFilter || order.orderStatus === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            if (type === 'active') {
                displayActiveOrders(filteredOrders);
            } else {
                displayCompletedOrders(filteredOrders);
            }
        }
        
        // Open order management modal
        function openOrderModal(orderId) {
            const order = allOrders.find(o => o.id == orderId) || localOrders.find(o => o.id == orderId);
            if (!order) return;
            
            const modalContent = document.getElementById('modal-content');
            
            if (['مكتمل', 'ملغي'].includes(order.orderStatus)) {
                // View only for completed orders
                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>رقم الطلب:</strong> ${order.orderNumber}</div>
                            <div><strong>العميل:</strong> ${order.customerName}</div>
                            <div><strong>رقم العميل:</strong> ${order.customerId}</div>
                            <div><strong>الخدمة:</strong> ${order.serviceType}</div>
                            <div><strong>المنطقة:</strong> ${order.area}</div>
                            <div><strong>التاريخ:</strong> ${order.visitDate}</div>
                            <div><strong>السعر النهائي:</strong> ${order.finalPrice || order.initialPrice} د.ك</div>
                            <div><strong>الحالة:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusClass(order.orderStatus)}">${order.orderStatus}</span></div>
                        </div>
                        
                        ${order.customerRating > 0 ? `
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h4 class="font-semibold mb-2">تقييم العميل:</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-500 text-xl">${'★'.repeat(order.customerRating)}${'☆'.repeat(5-order.customerRating)}</span>
                                    <span class="text-gray-600">(${order.customerRating}/5)</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${order.cancellationReason ? `
                            <div class="p-4 bg-red-50 rounded-lg">
                                <h4 class="font-semibold mb-2 text-red-800">سبب الإلغاء:</h4>
                                <p class="text-red-700">${order.cancellationReason}</p>
                            </div>
                        ` : ''}
                        
                        ${order.customerNotes ? `
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-semibold mb-2">ملاحظات العميل:</h4>
                                <p>${order.customerNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Management interface for active orders
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>رقم الطلب:</strong> ${order.orderNumber}</div>
                            <div><strong>العميل:</strong> ${order.customerName}</div>
                            <div><strong>رقم العميل:</strong> ${order.customerId}</div>
                            <div><strong>الخدمة:</strong> ${order.serviceType}</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">حالة الطلب</label>
                                <select id="order-status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="معاينة" ${order.orderStatus === 'معاينة' ? 'selected' : ''}>معاينة</option>
                                    <option value="موافق" ${order.orderStatus === 'موافق' ? 'selected' : ''}>موافق</option>
                                    <option value="مدفوع كامل" ${order.orderStatus === 'مدفوع كامل' ? 'selected' : ''}>مدفوع كامل</option>
                                    <option value="مدفوع جزئي" ${order.orderStatus === 'مدفوع جزئي' ? 'selected' : ''}>مدفوع جزئي</option>
                                    <option value="غير مدفوع" ${order.orderStatus === 'غير مدفوع' ? 'selected' : ''}>غير مدفوع</option>
                                    <option value="مكتمل" ${order.orderStatus === 'مكتمل' ? 'selected' : ''}>مكتمل</option>
                                    <option value="ملغي" ${order.orderStatus === 'ملغي' ? 'selected' : ''}>ملغي</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">السعر الأولي (د.ك)</label>
                                    <input type="number" id="initial-price-input" value="${order.initialPrice}" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نسبة الخصم (%)</label>
                                    <input type="number" id="discount-input" value="${order.discountPercentage || 0}" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">السعر النهائي (د.ك)</label>
                                <input type="number" id="final-price-input" value="${order.finalPrice || order.initialPrice}" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <div id="cancellation-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">سبب الإلغاء</label>
                                <select id="cancellation-reason" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                                    <option value="">اختر سبب الإلغاء</option>
                                    <option value="عدم توفر الوقت">عدم توفر الوقت</option>
                                    <option value="عدم الرضا عن السعر">عدم الرضا عن السعر</option>
                                    <option value="تغيير في الظروف">تغيير في الظروف</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                                <input type="text" id="custom-cancellation" placeholder="اكتب السبب..." class="w-full px-3 py-2 border border-gray-300 rounded-lg hidden">
                            </div>
                            
                            <div id="rating-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">تقييم العميل</label>
                                <div class="star-rating mb-3">
                                    <span class="star" data-rating="1">★</span>
                                    <span class="star" data-rating="2">★</span>
                                    <span class="star" data-rating="3">★</span>
                                    <span class="star" data-rating="4">★</span>
                                    <span class="star" data-rating="5">★</span>
                                </div>
                                <textarea id="rating-notes" placeholder="ملاحظات التقييم (اختياري)" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="updateOrder(${order.id})" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                تحديث الطلب
                            </button>
                            <button onclick="copyOrderToClipboard(${order.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                📋 نسخ للشيت
                            </button>
                            <button onclick="closeModal()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                إلغاء
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners for the modal
                setupModalEventListeners(order);
            }
            
            document.getElementById('order-modal').classList.remove('hidden');
        }
        
        // Setup modal event listeners
        function setupModalEventListeners(order) {
            // Status change handler
            document.getElementById('order-status-select').addEventListener('change', function() {
                const status = this.value;
                const cancellationSection = document.getElementById('cancellation-section');
                const ratingSection = document.getElementById('rating-section');
                
                if (status === 'ملغي') {
                    cancellationSection.classList.remove('hidden');
                    ratingSection.classList.add('hidden');
                } else if (status === 'مكتمل') {
                    ratingSection.classList.remove('hidden');
                    cancellationSection.classList.add('hidden');
                } else {
                    cancellationSection.classList.add('hidden');
                    ratingSection.classList.add('hidden');
                }
            });
            
            // Discount calculation
            document.getElementById('discount-input').addEventListener('input', function() {
                const initialPrice = parseFloat(document.getElementById('initial-price-input').value) || 0;
                const discount = parseFloat(this.value) || 0;
                const finalPrice = initialPrice * (1 - discount / 100);
                document.getElementById('final-price-input').value = finalPrice.toFixed(1);
            });
            
            // Cancellation reason handler
            document.getElementById('cancellation-reason').addEventListener('change', function() {
                const customInput = document.getElementById('custom-cancellation');
                if (this.value === 'أخرى') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            });
            
            // Star rating handler
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.querySelectorAll('.star').forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            // Set initial rating if exists
            if (order.customerRating > 0) {
                document.querySelectorAll('.star').forEach((s, index) => {
                    if (index < order.customerRating) {
                        s.classList.add('active');
                    }
                });
            }
        }
        
        // Update order
        function updateOrder(orderId) {
            const status = document.getElementById('order-status-select').value;
            const initialPrice = document.getElementById('initial-price-input').value;
            const discount = document.getElementById('discount-input').value;
            const finalPrice = document.getElementById('final-price-input').value;
            
            let cancellationReason = '';
            if (status === 'ملغي') {
                const reasonSelect = document.getElementById('cancellation-reason').value;
                if (reasonSelect === 'أخرى') {
                    cancellationReason = document.getElementById('custom-cancellation').value;
                } else {
                    cancellationReason = reasonSelect;
                }
            }
            
            let rating = 0;
            let ratingNotes = '';
            if (status === 'مكتمل') {
                rating = document.querySelectorAll('.star.active').length;
                ratingNotes = document.getElementById('rating-notes').value;
            }
            
            // Update local order if it exists
            const localOrderIndex = localOrders.findIndex(o => o.id == orderId);
            if (localOrderIndex !== -1) {
                localOrders[localOrderIndex] = {
                    ...localOrders[localOrderIndex],
                    orderStatus: status,
                    initialPrice: initialPrice,
                    discountPercentage: discount,
                    finalPrice: finalPrice,
                    cancellationReason: cancellationReason,
                    customerRating: rating,
                    ratingNotes: ratingNotes
                };
                localStorage.setItem('localOrders', JSON.stringify(localOrders));
                displayLocalOrders();
            }
            
            closeModal();
            showNotification('تم تحديث الطلب بنجاح', 'success');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }
        
        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                orderNumber: document.getElementById('order-number').value,
                customerId: document.getElementById('customer-id').value,
                customerName: document.getElementById('customer-name').value,
                area: document.getElementById('area').value,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('house-number').value,
                floor: document.getElementById('floor').value,
                housingType: document.getElementById('housing-type').value,
                serviceType: document.getElementById('service-type').value,
                visitDate: document.getElementById('visit-date').value,
                visitTime: document.getElementById('visit-time').value,
                initialPrice: document.getElementById('initial-price').value,
                finalPrice: document.getElementById('initial-price').value,
                customerNotes: document.getElementById('customer-notes').value,
                orderStatus: 'معاينة',
                paymentStatus: 'غير مدفوع',
                createdAt: new Date().toLocaleString('ar-SA')
            };
            
            localOrders.push(formData);
            localStorage.setItem('localOrders', JSON.stringify(localOrders));
            
            document.getElementById('new-order-form').reset();
            document.getElementById('new-order-section').classList.add('hidden');
            document.getElementById('customer-search').value = '';
            displayLocalOrders();
            showNotification('تم إنشاء طلب المعاينة بنجاح!', 'success');
        }
        
        // Display local orders
        function displayLocalOrders() {
            const container = document.getElementById('local-orders-list');
            if (localOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">لا توجد طلبات محلية</p>';
                return;
            }
            
            container.innerHTML = localOrders.map(order => `
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${order.customerName}</h4>
                            <p class="text-sm text-gray-600">${order.serviceType} - ${order.finalPrice || order.initialPrice} د.ك</p>
                            <p class="text-xs text-gray-500">تم الإنشاء: ${order.createdAt}</p>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(order.orderStatus)}">
                                ${order.orderStatus}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openOrderModal(${order.id})" class="text-blue-500 hover:text-blue-700">
                                ⚙️
                            </button>
                            <button onclick="removeLocalOrder(${order.id})" class="text-red-500 hover:text-red-700">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Remove local order
        function removeLocalOrder(id) {
            localOrders = localOrders.filter(order => order.id !== id);
            localStorage.setItem('localOrders', JSON.stringify(localOrders));
            displayLocalOrders();
            showNotification('تم حذف الطلب', 'info');
        }
        
        // Copy specific order to clipboard
        function copyOrderToClipboard(orderId) {
            const order = allOrders.find(o => o.id == orderId) || localOrders.find(o => o.id == orderId);
            if (!order) {
                showNotification('لم يتم العثور على الطلب', 'error');
                return;
            }
            
            // Get current values from modal if it's open
            const statusSelect = document.getElementById('order-status-select');
            const initialPriceInput = document.getElementById('initial-price-input');
            const discountInput = document.getElementById('discount-input');
            const finalPriceInput = document.getElementById('final-price-input');
            const cancellationReasonSelect = document.getElementById('cancellation-reason');
            const customCancellationInput = document.getElementById('custom-cancellation');
            const ratingNotesInput = document.getElementById('rating-notes');
            
            let updatedOrder = { ...order };
            
            if (statusSelect) {
                updatedOrder.orderStatus = statusSelect.value;
                updatedOrder.initialPrice = initialPriceInput.value;
                updatedOrder.discountPercentage = discountInput.value || 0;
                updatedOrder.finalPrice = finalPriceInput.value;
                
                if (statusSelect.value === 'ملغي') {
                    const reasonSelect = cancellationReasonSelect.value;
                    if (reasonSelect === 'أخرى') {
                        updatedOrder.cancellationReason = customCancellationInput.value;
                    } else {
                        updatedOrder.cancellationReason = reasonSelect;
                    }
                }
                
                if (statusSelect.value === 'مكتمل') {
                    updatedOrder.customerRating = document.querySelectorAll('.star.active').length;
                    updatedOrder.ratingNotes = ratingNotesInput.value;
                }
            }
            
            const orderRow = [
                updatedOrder.orderNumber, updatedOrder.customerId, updatedOrder.customerName, updatedOrder.area,
                updatedOrder.street || '', updatedOrder.houseNumber || '', updatedOrder.floor || '', 
                updatedOrder.housingType || '', '', updatedOrder.serviceType, updatedOrder.visitDate, 
                updatedOrder.visitTime || '', '', '', updatedOrder.initialPrice, 
                updatedOrder.discountPercentage || 0, updatedOrder.finalPrice || updatedOrder.initialPrice,
                updatedOrder.orderStatus, updatedOrder.paymentStatus || 'غير مدفوع', 
                updatedOrder.cancellationReason || '', updatedOrder.customerRating || 0, 
                updatedOrder.customerNotes || '', updatedOrder.ratingNotes || '', 
                updatedOrder.createdAt || new Date().toLocaleString('ar-SA')
            ];
            
            const csvContent = orderRow.join('\t');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                showNotification('تم نسخ بيانات الطلب! يمكنك لصقها في Google Sheets', 'success');
            }).catch(() => {
                showNotification('فشل في نسخ البيانات', 'error');
            });
        }
        
        // Copy local orders to clipboard
        function copyToClipboard() {
            if (localOrders.length === 0) {
                showNotification('لا توجد طلبات محلية للنسخ', 'warning');
                return;
            }
            
            const headers = [
                'رقم الطلب', 'رقم العميل', 'اسم العميل', 'المنطقة', 'الشارع',
                'رقم المنزل', 'الدور', 'نوع السكن', 'ملاحظات الموقع', 'نوع الخدمة',
                'تاريخ الزيارة', 'وقت الزيارة', 'تكرار الخدمة', 'طريقة الدفع',
                'السعر الأولي', 'نسبة الخصم', 'السعر النهائي', 'حالة الطلب', 'حالة الدفع',
                'سبب الإلغاء', 'تقييم العميل', 'ملاحظات العميل', 'ملاحظات الفريق', 'تاريخ الإنشاء'
            ];
            
            const rows = localOrders.map(order => [
                order.orderNumber, order.customerId, order.customerName, order.area,
                order.street, order.houseNumber, order.floor, order.housingType, '',
                order.serviceType, order.visitDate, order.visitTime, '',
                '', order.initialPrice, order.discountPercentage || 0, order.finalPrice || order.initialPrice,
                order.orderStatus, order.paymentStatus, order.cancellationReason || '',
                order.customerRating || 0, order.customerNotes, order.ratingNotes || '', order.createdAt
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join('\t')).join('\n');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                showNotification('تم نسخ البيانات! يمكنك لصقها في Google Sheets', 'success');
            }).catch(() => {
                showNotification('فشل في نسخ البيانات', 'error');
            });
        }
        
        // Update research data
        function updateResearchData() {
            // Service statistics
            const serviceStats = {};
            allOrders.forEach(order => {
                serviceStats[order.serviceType] = (serviceStats[order.serviceType] || 0) + 1;
            });
            
            document.getElementById('service-stats').innerHTML = Object.entries(serviceStats)
                .sort(([,a], [,b]) => b - a)
                .map(([service, count]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">${service}</span>
                        <span class="font-semibold text-blue-600">${count}</span>
                    </div>
                `).join('');
            
            // Area statistics
            const areaStats = {};
            allOrders.forEach(order => {
                areaStats[order.area] = (areaStats[order.area] || 0) + 1;
            });
            
            document.getElementById('area-stats').innerHTML = Object.entries(areaStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([area, count]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">${area}</span>
                        <span class="font-semibold text-green-600">${count}</span>
                    </div>
                `).join('');
            
            // Rating statistics
            const ratings = allOrders.filter(order => order.customerRating > 0);
            const avgRating = ratings.length > 0 ? 
                (ratings.reduce((sum, order) => sum + order.customerRating, 0) / ratings.length).toFixed(1) : 0;
            
            document.getElementById('rating-stats').innerHTML = `
                <div class="text-center p-6">
                    <div class="text-4xl font-bold text-yellow-500 mb-2">${avgRating}</div>
                    <div class="text-yellow-500 text-2xl mb-2">${'★'.repeat(Math.floor(avgRating))}${'☆'.repeat(5-Math.floor(avgRating))}</div>
                    <div class="text-gray-600">متوسط التقييم من ${ratings.length} تقييم</div>
                </div>
            `;
        }
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                button.classList.add('text-gray-600');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
            activeTab.classList.remove('text-gray-600');
        }
        
        // Refresh data manually
        function refreshData() {
            fetchData();
            showNotification('تم تحديث البيانات', 'success');
        }
        
        // Get status class for styling
        function getStatusClass(status) {
            switch (status) {
                case 'معاينة':
                    return 'bg-purple-100 text-purple-800';
                case 'موافق':
                    return 'bg-cyan-100 text-cyan-800';
                case 'مدفوع كامل':
                    return 'bg-green-100 text-green-800';
                case 'مدفوع جزئي':
                    return 'bg-yellow-100 text-yellow-800';
                case 'غير مدفوع':
                    return 'bg-orange-100 text-orange-800';
                case 'مكتمل':
                    return 'bg-emerald-100 text-emerald-800';
                case 'ملغي':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ad8328a0547ccf',t:'MTc1OTg0MTMwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
