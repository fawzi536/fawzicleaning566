<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-preview { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .status-approved { background: linear-gradient(135deg, #10b981, #059669); }
        .status-paid { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .status-partial { background: linear-gradient(135deg, #f97316, #ea580c); }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-cancelled { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .status-completed { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-800 text-center">ğŸ  Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8 space-x-reverse">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                <button onclick="showTab('search')" id="tab-search" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    ğŸ” Ø¨Ø­Ø« ÙˆØ¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨
                </button>
                <button onclick="showTab('active')" id="tab-active" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                </button>
                <button onclick="showTab('completed')" id="tab-completed" class="tab-btn py-4 px-6 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-all duration-200 font-semibold">
                    âœ… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                            <p id="total-orders" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-2xl">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Ù…Ø¯ÙÙˆØ¹Ø©</p>
                            <p id="paid-orders" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-2xl">ğŸ’°</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</p>
                            <p id="active-orders" class="text-3xl font-bold text-yellow-600">0</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <span class="text-2xl">â³</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-r-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Ù…ÙƒØªÙ…Ù„Ø©</p>
                            <p id="completed-orders" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <span class="text-2xl">âœ…</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600" id="today-orders">0</p>
                        <p class="text-gray-600">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600" id="total-revenue">0 Ø¯.Ùƒ</p>
                        <p class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-600" id="avg-rating">0</p>
                        <p class="text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Add Order Tab -->
        <div id="search-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="customer-search" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„)" 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="searchCustomer()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Ø¨Ø­Ø«
                    </button>
                </div>
                <div id="customer-history" class="hidden"></div>
            </div>

            <div id="add-order-form" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="order-number">
                    <input type="hidden" id="customer-number">
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" id="customer-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø´Ø§Ø±Ø¹</label>
                        <input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„</label>
                        <input type="text" id="house-number" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¯ÙˆØ±</label>
                        <input type="text" id="floor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†</label>
                        <select id="housing-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†</option>
                            <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
                            <option value="Ø¨ÙŠØª">Ø¨ÙŠØª</option>
                            <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
                            <option value="Ù…ÙƒØªØ¨">Ù…ÙƒØªØ¨</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                        <textarea id="location-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <select id="service-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
                            <option value="ØªÙ†Ø¸ÙŠÙ Ø¹Ø§Ù…">ØªÙ†Ø¸ÙŠÙ Ø¹Ø§Ù…</option>
                            <option value="ØªÙ†Ø¸ÙŠÙ Ø¹Ù…ÙŠÙ‚">ØªÙ†Ø¸ÙŠÙ Ø¹Ù…ÙŠÙ‚</option>
                            <option value="ØªÙ†Ø¸ÙŠÙ Ø´Ù‚Ù‚">ØªÙ†Ø¸ÙŠÙ Ø´Ù‚Ù‚</option>
                            <option value="ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØ§ØªØ¨">ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØ§ØªØ¨</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                        <input type="date" id="visit-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                        <input type="time" id="visit-time" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <select id="service-frequency" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙƒØ±Ø§Ø±</option>
                            <option value="Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©">Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                            <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select id="payment-method" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</option>
                            <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                            <option value="ÙƒÙŠ Ù†Øª">ÙƒÙŠ Ù†Øª</option>
                            <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø¯.Ùƒ)</label>
                        <input type="number" id="initial-amount" step="0.1" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <textarea id="customer-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                            Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ (Ù…Ø¹Ø§ÙŠÙ†Ø©)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Active Orders Tab -->
        <div id="active-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â³ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
                <div id="active-orders-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Completed Orders Tab -->
        <div id="completed-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">âœ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Order Management Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // Global variables
        let orders = [];
        let nextOrderNumber = 1;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            showTab('dashboard');
            fetchOrders();
            setInterval(fetchOrders, 60000); // Update every minute
        });

        // Fetch orders from Google Sheets
        async function fetchOrders() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/14kbGPoC4ld3tkDAuVWGO36FjNtRvY0xKBXc_y0vUkZI/gviz/tq?tqx=out:json');
                const text = await response.text();
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                orders = data.table.rows.map((row, index) => {
                    const cells = row.c || [];
                    return {
                        orderNumber: cells[0]?.v || (index + 1),
                        customerNumber: cells[1]?.v || '',
                        customerName: cells[2]?.v || '',
                        area: cells[3]?.v || '',
                        street: cells[4]?.v || '',
                        houseNumber: cells[5]?.v || '',
                        floor: cells[6]?.v || '',
                        housingType: cells[7]?.v || '',
                        locationNotes: cells[8]?.v || '',
                        serviceType: cells[9]?.v || '',
                        visitDate: cells[10]?.v || '',
                        visitTime: cells[11]?.v || '',
                        serviceFrequency: cells[12]?.v || '',
                        paymentMethod: cells[13]?.v || '',
                        totalAmount: cells[14]?.v || 0,
                        paymentStatus: cells[15]?.v || 'Ù…Ø¹Ø§ÙŠÙ†Ø©',
                        teamName: cells[16]?.v || '',
                        bookingStatus: cells[17]?.v || 'Ù…Ø¹Ø§ÙŠÙ†Ø©',
                        departureTime: cells[18]?.v || '',
                        customerNotes: cells[19]?.v || '',
                        teamNotes: cells[20]?.v || '',
                        customerRating: cells[21]?.v || 0,
                        orderCoordinator: cells[22]?.v || ''
                    };
                });

                nextOrderNumber = Math.max(...orders.map(o => parseInt(o.orderNumber) || 0)) + 1;
                updateDashboard();
                displayActiveOrders();
                displayCompletedOrders();
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-500');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('text-blue-600', 'border-blue-500');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600', 'border-transparent');
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalOrders = orders.length;
            const paidOrders = orders.filter(o => o.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„').length;
            const activeOrders = orders.filter(o => ['Ù…Ø¹Ø§ÙŠÙ†Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ'].includes(o.bookingStatus)).length;
            const completedOrders = orders.filter(o => ['Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'].includes(o.bookingStatus)).length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.visitDate === today).length;
            
            const totalRevenue = orders
                .filter(o => o.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„')
                .reduce((sum, o) => sum + (parseFloat(o.totalAmount) || 0), 0);
            
            const ratings = orders.filter(o => o.customerRating > 0);
            const avgRating = ratings.length > 0 
                ? (ratings.reduce((sum, o) => sum + o.customerRating, 0) / ratings.length).toFixed(1)
                : 0;

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('paid-orders').textContent = paidOrders;
            document.getElementById('active-orders').textContent = activeOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            document.getElementById('today-orders').textContent = todayOrders;
            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(1) + ' Ø¯.Ùƒ';
            document.getElementById('avg-rating').textContent = avgRating;
        }

        // Search for customer
        function searchCustomer() {
            const customerNumber = document.getElementById('customer-search').value.trim();
            if (!customerNumber) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
                return;
            }

            const customerOrders = orders.filter(o => o.customerNumber === customerNumber);
            const historyDiv = document.getElementById('customer-history');
            
            if (customerOrders.length > 0) {
                historyDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (${customerOrders.length})</h4>
                    <div class="space-y-3 mb-4">
                        ${customerOrders.map(order => `
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold">Ø·Ù„Ø¨ #${order.orderNumber}</p>
                                        <p class="text-sm text-gray-600">${order.serviceType} - ${order.visitDate}</p>
                                        <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº: ${order.totalAmount} Ø¯.Ùƒ</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusClass(order.bookingStatus)}">
                                        ${order.bookingStatus}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                historyDiv.classList.remove('hidden');
                
                // Pre-fill customer info from last order
                const lastOrder = customerOrders[customerOrders.length - 1];
                document.getElementById('customer-name').value = lastOrder.customerName;
                document.getElementById('area').value = lastOrder.area;
                document.getElementById('street').value = lastOrder.street;
                document.getElementById('house-number').value = lastOrder.houseNumber;
                document.getElementById('floor').value = lastOrder.floor;
                document.getElementById('housing-type').value = lastOrder.housingType;
                document.getElementById('location-notes').value = lastOrder.locationNotes;
            } else {
                historyDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-yellow-800">ğŸ†• Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>
                    </div>
                `;
                historyDiv.classList.remove('hidden');
            }

            document.getElementById('customer-number').value = customerNumber;
            document.getElementById('order-number').value = nextOrderNumber;
            document.getElementById('add-order-form').classList.remove('hidden');
        }

        // Handle new order form submission
        document.getElementById('new-order-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newOrder = {
                orderNumber: document.getElementById('order-number').value,
                customerNumber: document.getElementById('customer-number').value,
                customerName: document.getElementById('customer-name').value,
                area: document.getElementById('area').value,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('house-number').value,
                floor: document.getElementById('floor').value,
                housingType: document.getElementById('housing-type').value,
                locationNotes: document.getElementById('location-notes').value,
                serviceType: document.getElementById('service-type').value,
                visitDate: document.getElementById('visit-date').value,
                visitTime: document.getElementById('visit-time').value,
                serviceFrequency: document.getElementById('service-frequency').value,
                paymentMethod: document.getElementById('payment-method').value,
                totalAmount: document.getElementById('initial-amount').value,
                paymentStatus: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                teamName: '',
                bookingStatus: 'Ù…Ø¹Ø§ÙŠÙ†Ø©',
                departureTime: '',
                customerNotes: document.getElementById('customer-notes').value,
                teamNotes: '',
                customerRating: 0,
                orderCoordinator: ''
            };

            orders.push(newOrder);
            nextOrderNumber++;
            
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°.');
            
            // Reset form
            document.getElementById('new-order-form').reset();
            document.getElementById('add-order-form').classList.add('hidden');
            document.getElementById('customer-history').classList.add('hidden');
            document.getElementById('customer-search').value = '';
            
            updateDashboard();
            displayActiveOrders();
            
            // Copy order data to clipboard for Google Sheets
            copyOrderToClipboard(newOrder);
        });

        // Copy order data to clipboard
        function copyOrderToClipboard(order) {
            const orderData = [
                order.orderNumber,
                order.customerNumber,
                order.customerName,
                order.area,
                order.street,
                order.houseNumber,
                order.floor,
                order.housingType,
                order.locationNotes,
                order.serviceType,
                order.visitDate,
                order.visitTime,
                order.serviceFrequency,
                order.paymentMethod,
                order.totalAmount,
                order.paymentStatus,
                order.teamName,
                order.bookingStatus,
                order.departureTime,
                order.customerNotes,
                order.teamNotes,
                order.customerRating,
                order.orderCoordinator
            ].join('\t');

            navigator.clipboard.writeText(orderData).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Google Sheets Ø§Ù„Ø¢Ù†.');
            });
        }

        // Display active orders
        function displayActiveOrders() {
            const activeOrders = orders.filter(o => ['Ù…Ø¹Ø§ÙŠÙ†Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ'].includes(o.bookingStatus));
            const container = document.getElementById('active-orders-list');
            
            if (activeOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</p>';
                return;
            }

            container.innerHTML = activeOrders.map(order => createOrderCard(order)).join('');
        }

        // Display completed orders
        function displayCompletedOrders() {
            const completedOrders = orders.filter(o => ['Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'].includes(o.bookingStatus));
            const container = document.getElementById('completed-orders-list');
            
            if (completedOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</p>';
                return;
            }

            container.innerHTML = completedOrders.map(order => createOrderCard(order)).join('');
        }

        // Create order card HTML
        function createOrderCard(order) {
            const statusClass = getStatusClass(order.bookingStatus);
            const paymentClass = getPaymentStatusClass(order.paymentStatus);
            
            return `
                <div class="order-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">Ø·Ù„Ø¨ #${order.orderNumber}</h4>
                            <p class="text-gray-600">${order.customerName} - ${order.customerNumber}</p>
                            <p class="text-sm text-gray-500">${order.serviceType}</p>
                        </div>
                        <div class="text-left">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass} block mb-2">
                                ${order.bookingStatus}
                            </span>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${paymentClass}">
                                ${order.paymentStatus}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <span class="text-gray-500">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                            <span class="font-medium">${order.visitDate}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Ø§Ù„ÙˆÙ‚Øª:</span>
                            <span class="font-medium">${order.visitTime}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span>
                            <span class="font-medium">${order.area}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Ø§Ù„Ù…Ø¨Ù„Øº:</span>
                            <span class="font-medium">${order.totalAmount} Ø¯.Ùƒ</span>
                        </div>
                    </div>
                    
                    ${order.customerRating > 0 ? `
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span>
                            <span class="text-yellow-500">${'â˜…'.repeat(order.customerRating)}${'â˜†'.repeat(5-order.customerRating)}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="manageOrder('${order.orderNumber}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨
                        </button>
                        <button onclick="copyOrderToClipboard(${JSON.stringify(order).replace(/"/g, '&quot;')})" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                    </div>
                </div>
            `;
        }

        // Get status class for styling
        function getStatusClass(status) {
            const classes = {
                'Ù…Ø¹Ø§ÙŠÙ†Ø©': 'bg-yellow-100 text-yellow-800',
                'Ù…ÙˆØ§ÙÙ‚': 'bg-green-100 text-green-800',
                'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': 'bg-red-100 text-red-800',
                'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ': 'bg-orange-100 text-orange-800',
                'Ù…ÙƒØªÙ…Ù„': 'bg-purple-100 text-purple-800',
                'Ù…Ù„ØºÙŠ': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Get payment status class
        function getPaymentStatusClass(status) {
            const classes = {
                'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„': 'bg-green-100 text-green-800',
                'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ': 'bg-orange-100 text-orange-800',
                'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Manage order (open modal)
        function manageOrder(orderNumber) {
            const order = orders.find(o => o.orderNumber == orderNumber);
            if (!order) return;

            const modal = document.getElementById('order-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ #${order.orderNumber}</h4>
                        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName} (${order.customerNumber})</p>
                        <p><strong>Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${order.serviceType}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${order.visitDate} - ${order.visitTime}</p>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.area}, ${order.street}, ${order.houseNumber}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²</label>
                            <select id="modal-booking-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="Ù…Ø¹Ø§ÙŠÙ†Ø©" ${order.bookingStatus === 'Ù…Ø¹Ø§ÙŠÙ†Ø©' ? 'selected' : ''}>Ù…Ø¹Ø§ÙŠÙ†Ø©</option>
                                <option value="Ù…ÙˆØ§ÙÙ‚" ${order.bookingStatus === 'Ù…ÙˆØ§ÙÙ‚' ? 'selected' : ''}>Ù…ÙˆØ§ÙÙ‚</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${order.bookingStatus === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                <option value="Ù…Ù„ØºÙŠ" ${order.bookingStatus === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="modal-payment-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" ${order.paymentStatus === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' ? 'selected' : ''}>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                                <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ" ${order.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ' ? 'selected' : ''}>Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ</option>
                                <option value="Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„" ${order.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„' ? 'selected' : ''}>Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¯.Ùƒ)</label>
                            <input type="number" id="modal-final-amount" step="0.1" value="${order.totalAmount}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚</label>
                            <input type="text" id="modal-team-name" value="${order.teamName}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div id="cancellation-reason-div" class="hidden">
                        <label class="block text-gray-700 font-semibold mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</label>
                        <select id="modal-cancellation-reason" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                            <option value="">Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</option>
                            <option value="Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                            <option value="ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯">ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯</option>
                            <option value="Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¶Ø§ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±">Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¶Ø§ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                        <input type="text" id="modal-other-reason" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg hidden">
                    </div>
                    
                    <div id="rating-div" class="hidden">
                        <label class="block text-gray-700 font-semibold mb-2">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <div class="flex gap-2 mb-2">
                            ${[1,2,3,4,5].map(i => `
                                <button type="button" onclick="setRating(${i})" 
                                        class="rating-star text-2xl ${order.customerRating >= i ? 'text-yellow-500' : 'text-gray-300'}" 
                                        data-rating="${i}">â˜…</button>
                            `).join('')}
                        </div>
                        <textarea id="modal-rating-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…..." 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="2">${order.teamNotes}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</label>
                        <textarea id="modal-team-notes" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                                  rows="3">${order.teamNotes}</textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="updateOrder('${order.orderNumber}')" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold">
                            Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                        <button onclick="closeModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Add event listeners
            document.getElementById('modal-booking-status').addEventListener('change', function() {
                const status = this.value;
                const cancellationDiv = document.getElementById('cancellation-reason-div');
                const ratingDiv = document.getElementById('rating-div');
                
                if (status === 'Ù…Ù„ØºÙŠ') {
                    cancellationDiv.classList.remove('hidden');
                    ratingDiv.classList.add('hidden');
                } else if (status === 'Ù…ÙƒØªÙ…Ù„') {
                    cancellationDiv.classList.add('hidden');
                    ratingDiv.classList.remove('hidden');
                } else {
                    cancellationDiv.classList.add('hidden');
                    ratingDiv.classList.add('hidden');
                }
            });
            
            document.getElementById('modal-cancellation-reason').addEventListener('change', function() {
                const otherInput = document.getElementById('modal-other-reason');
                if (this.value === 'Ø£Ø®Ø±Ù‰') {
                    otherInput.classList.remove('hidden');
                } else {
                    otherInput.classList.add('hidden');
                }
            });
        }

        // Set rating
        function setRating(rating) {
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-500');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.add('text-gray-300');
                    star.classList.remove('text-yellow-500');
                }
            });
        }

        // Update order
        function updateOrder(orderNumber) {
            const orderIndex = orders.findIndex(o => o.orderNumber == orderNumber);
            if (orderIndex === -1) return;

            const bookingStatus = document.getElementById('modal-booking-status').value;
            const paymentStatus = document.getElementById('modal-payment-status').value;
            const finalAmount = document.getElementById('modal-final-amount').value;
            const teamName = document.getElementById('modal-team-name').value;
            const teamNotes = document.getElementById('modal-team-notes').value;
            
            let cancellationReason = '';
            if (bookingStatus === 'Ù…Ù„ØºÙŠ') {
                const reason = document.getElementById('modal-cancellation-reason').value;
                if (reason === 'Ø£Ø®Ø±Ù‰') {
                    cancellationReason = document.getElementById('modal-other-reason').value;
                } else {
                    cancellationReason = reason;
                }
            }
            
            let customerRating = 0;
            if (bookingStatus === 'Ù…ÙƒØªÙ…Ù„') {
                const selectedStar = document.querySelector('.rating-star.text-yellow-500:last-of-type');
                if (selectedStar) {
                    customerRating = parseInt(selectedStar.dataset.rating);
                }
            }

            // Update order
            orders[orderIndex] = {
                ...orders[orderIndex],
                bookingStatus,
                paymentStatus,
                totalAmount: finalAmount,
                teamName,
                teamNotes: bookingStatus === 'Ù…Ù„ØºÙŠ' ? cancellationReason : teamNotes,
                customerRating,
                departureTime: bookingStatus === 'Ù…ÙƒØªÙ…Ù„' ? new Date().toLocaleTimeString('ar-SA') : ''
            };

            closeModal();
            updateDashboard();
            displayActiveOrders();
            displayCompletedOrders();
            
            // Copy updated order to clipboard
            copyOrderToClipboard(orders[orderIndex]);
            
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©.');
        }

        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
            document.getElementById('order-modal').classList.remove('flex');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98aea9d065e54e4e',t:'MTc1OTg1MzM3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
